<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>JSDoc: Source: drawPolygon.js</title>

<script src="scripts/prettify/prettify.js"></script>
<script src="scripts/prettify/lang-css.js"></script>
<!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<link type="text/css" rel="stylesheet" href=
"styles/prettify-tomorrow.css">
<link type="text/css" rel="stylesheet" href=
"styles/jsdoc-default.css">
</head>
<body>
<div id="main">
<h1 class="page-title">Source: drawPolygon.js</h1>
<section>
<article>
<pre class="prettyprint source linenums"><code>/**
 * Allow user to draw a polygon on the image.
 *
 * @param {object} viewerInfo - Info specific to 'this' viewer
 * @param {object} viewer - OSD viewer object
 * @param {object} overlay - Canvas on which to draw the polygon
 */
const drawPolygon = (viewerInfo, viewer, overlay) =&gt; {
  let idx = viewerInfo.idx;
  let btnDraw = document.getElementById(`btnDraw${idx}`);
  let mark = document.getElementById(`mark${idx}`);
  let canvas = overlay.fabricCanvas();
  let tag;

  let paintBrush = canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
  paintBrush.decimate = 12;
  paintBrush.color = mark.innerHTML;

  canvas.on('mouse:over', evt =&gt; {
    if (evt.target !== null) {
      fillPolygon(evt, canvas, true);
    }
  });

  canvas.on('mouse:out', evt =&gt; {
    if (evt.target !== null) {
      fillPolygon(evt, canvas, false);
    }
  });

  canvas.on('mouse:up', (evt) =&gt; {
    annotate(evt);
    drawingOff(canvas, viewer);
  });

  canvas.on('path:created', opts =&gt; {
    tag = createId2();
    pathCreatedHandler(opts, btnDraw, canvas, paintBrush, viewer);
  });

  btnDraw.addEventListener('click', function () {
    toggleButton(this, 'btnOn', 'annotationBtn');
    if (canvas.isDrawingMode) {
      // Drawing off
      drawingOff(canvas, viewer);
    } else {
      // Drawing on
      canvas.isDrawingMode = true;
      canvas.on('mouse:down', () =&gt; {
        setGestureSettings(canvas, viewer);
      });
      paintBrush.color = mark.innerHTML;
      paintBrush.width = 10 / viewer.viewport.getZoom(true);
      setOsdTracking(viewer, false);
    }
  });

  function annotate(evt) {
    if (canvas.isDrawingMode) {
      let target = evt.currentTarget;

      // FABRIC TEXTBOX
      let text = new fabric.Textbox('Annotate...', {
        width: 250,
        cursorColor: 'blue',
        top: target.top + target.height + 10,
        left: target.left + target.width + 10,
        fontSize: 20,
        editable: true,
        tag: tag
      });
      canvas.add(text);

      /*
      // ANNOTORIOUS-STYLE DIV FOR ANNOTATION
      let left, top;
      top = target.top + target.height + 25;
      left = target.left + target.width + 25;
      let myDiv = `&lt;div class="r6o-editor r6o-arrow-top r6o-arrow-left" style="transform: translate(0px); top: ${top}px; left: ${left}px; opacity: 1;"&gt;
      &lt;div class="r6o-arrow"&gt;&lt;/div&gt;&lt;!-- ARROW --&gt;
      &lt;div class="r6o-editor-inner"&gt;
        &lt;div class="r6o-widget comment"&gt;
          &lt;textarea class="r6o-editable-text" placeholder="Add a comment..." disabled rows="1" style="overflow: hidden; overflow-wrap: break-word; height: 35px;"&gt;&lt;/textarea&gt;
          &lt;div class="r6o-icon r6o-arrow-down"&gt;
            &lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 940" width="12"&gt;
              &lt;metadata&gt;IcoFont Icons&lt;/metadata&gt;
              &lt;title&gt;simple-down&lt;/title&gt;
              &lt;glyph glyph-name="simple-down" unicode="\uEAB2" horiz-advx="1000"&gt;&lt;/glyph&gt;
              &lt;path fill="currentColor" d="M200 392.6l300 300 300-300-85.10000000000002-85.10000000000002-214.89999999999998 214.79999999999995-214.89999999999998-214.89999999999998-85.10000000000002 85.20000000000005z"&gt;&lt;/path&gt;
            &lt;/svg&gt;
          &lt;/div&gt;
        &lt;/div&gt;&lt;!-- END comment --&gt;
        &lt;div class="r6o-widget comment editable"&gt;
          &lt;textarea class="r6o-editable-text" placeholder="Add a reply..." rows="1" style="overflow: hidden; overflow-wrap: break-word; height: 35px;"&gt;&lt;/textarea&gt;
        &lt;/div&gt;&lt;!-- END reply --&gt;
        &lt;div class="r6o-widget r6o-tag"&gt;
          &lt;ul class="r6o-taglist"&gt;
            &lt;!-- existing tags go here. --&gt;
            &lt;li&gt;&lt;/li&gt;
          &lt;/ul&gt;&lt;!-- END taglist --&gt;
          &lt;div class="r6o-autocomplete"&gt;
            &lt;div&gt;&lt;input placeholder="Add tag..."&gt;&lt;/div&gt;
            &lt;ul&gt;&lt;!-- tags go here --&gt;&lt;/ul&gt;
          &lt;/div&gt;&lt;!-- END add tag --&gt;
        &lt;/div&gt;&lt;!-- END tag section --&gt;
        &lt;div class="r6o-footer r6o-draggable"&gt;
          &lt;button class="r6o-btn left delete-annotation" title="Delete"&gt;
            &lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="12"&gt;
              &lt;path fill="currentColor" d="M268 416h24a12 12 0 0 0 12-12V188a12 12 0 0 0-12-12h-24a12 12 0 0 0-12 12v216a12 12 0 0 0 12 12zM432 80h-82.41l-34-56.7A48 48 0 0 0 274.41 0H173.59a48 48 0 0 0-41.16 23.3L98.41 80H16A16 16 0 0 0 0 96v16a16 16 0 0 0 16 16h16v336a48 48 0 0 0 48 48h288a48 48 0 0 0 48-48V128h16a16 16 0 0 0 16-16V96a16 16 0 0 0-16-16zM171.84 50.91A6 6 0 0 1 177 48h94a6 6 0 0 1 5.15 2.91L293.61 80H154.39zM368 464H80V128h288zm-212-48h24a12 12 0 0 0 12-12V188a12 12 0 0 0-12-12h-24a12 12 0 0 0-12 12v216a12 12 0 0 0 12 12z"&gt;&lt;/path&gt;
            &lt;/svg&gt;
          &lt;/button&gt;&lt;!-- DELETE button --&gt;
          &lt;button class="r6o-btn outline"&gt;Cancel&lt;/button&gt;&lt;!-- CANCEL button --&gt;
          &lt;button class="r6o-btn"&gt;OK&lt;/button&gt;&lt;!-- OK button --&gt;
        &lt;/div&gt;&lt;!-- END footer --&gt;
      &lt;/div&gt;&lt;!-- END editor-inner --&gt;
    &lt;/div&gt;&lt;!-- END editor --&gt;`;
      try {
        const myDiv1 = e('div');
        myDiv1.style.left = `${left}px`;
        myDiv1.style.top = `${top}px`;
        myDiv1.innerHTML = myDiv;
        document.body.appendChild(myDiv1);

      } catch (e) {
        console.log(`%c${e.message}`, "color: #ff00cc;");
      }
      */
    }
  }

  function drawingOff(canvas, viewer) {
    canvas.isDrawingMode = false;
    canvas.off('mouse:down', () =&gt; {
      setGestureSettings(canvas, viewer);
    });
    setOsdTracking(viewer, true);
  }

  function pathCreatedHandler(options, button, canvas, paintBrush, viewer) {
    convertPathToPolygon(options.path, canvas, paintBrush);
    setupDeleteButton(options.path);
    toggleButton(button, 'annotationBtn', 'btnOn');
    canvas.off('path:created', () =&gt; {
      pathCreatedHandler(options, button, canvas, paintBrush, viewer);
    });
  }

  function setGestureSettings(canvas, viewer) {
    viewer.gestureSettingsMouse.clickToZoom = !canvas.getActiveObject();
  }

  function setupDeleteButton(obj) {
    obj.lockMovementX = true;
    obj.lockMovementY = true;
    let deleteIcon = "data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E";

    let deleteImg = document.createElement('img');
    deleteImg.src = deleteIcon;

    function renderIcon(icon) {
      return function renderIcon(ctx, left, top, styleOverride, fabricObject) {
        let size = this.cornerSize;
        ctx.save();
        ctx.translate(left, top);
        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
        ctx.drawImage(icon, -size / 2, -size / 2, size, size);
        ctx.restore();
      };
    }

    fabric.Object.prototype.controls.deleteControl = new fabric.Control({
      x: 0.5,
      y: -0.5,
      offsetX: 15,
      offsetY: -15,
      cursorStyle: 'pointer',
      mouseUpHandler: deleteObject,
      render: renderIcon(deleteImg),
      cornerSize: 24
    });

    function deleteObject(mouseEvent, transform) {
      let target = transform.target;
      try {
        let canvas = target.canvas;
        canvas.remove(target);
        canvas.requestRenderAll();
      } catch (e) {
        console.error(`%c${e.message}`, 'font-size: larger;');
      }
    }
  }

  function convertPathToPolygon(pathObject, canvas, paintBrush) {
    let _points0 = pathObject.path.map(item =&gt; ({
      x: item[1],
      y: item[2]
    }));

    let poly = new fabric.Polygon(_points0, {
      left: pathObject.left,
      top: pathObject.top,
      fill: '',
      strokeWidth: paintBrush.width,
      stroke: paintBrush.color,
      scaleX: pathObject.scaleX,
      scaleY: pathObject.scaleY,
      objectCaching: false,
      transparentCorners: false,
      cornerColor: 'rgba(0, 0, 255, 0.5)',
      cornerStyle: 'square',
      tag: tag
    });
    canvas.add(poly);
    poly.setControlVisible('tr', false);
    canvas.setActiveObject(poly);
    canvas.remove(pathObject);
  }

  function fillPolygon(pointerEvent, canvas, fill) {
    let obj = pointerEvent.target;

    if (isRealValue(obj) &amp;& obj.type === 'polygon') {
      // polygon hover
      if (fill) {
        obj.set({
          fill: obj.stroke,
          opacity: 0.5
        });
        // displayInfo(obj, canvas);
      } else {
        obj.set({
          fill: ''
        });
        // canvas.remove(infoText);
      }
      canvas.renderAll();
    }
  }

  // function displayInfo(obj, canvas) {
  //   // Display some kind of information. TBA.
  //   // Right now this displays what type of object it is. (Polygon, obviously.)
  //   let type = obj.type;
  //   let left = obj.left;
  //   let top = obj.top;
  //
  //   let infoText = new fabric.Text(type, {
  //     fontSize: 18,
  //     fontFamily: 'Courier',
  //     backgroundColor: 'rgba(102, 102, 102, 0.7)',
  //     stroke: 'rgba(255, 255, 255, 1)',
  //     fill: 'rgba(255, 255, 255, 1)',
  //     left, // pointer.x,
  //     top, // pointer.y
  //   });
  //   canvas.add(infoText);
  // }
};
</code></pre></article>
</section>
</div>
<nav>
<h2><a href="index.html">Home</a></h2>
<h3>Classes</h3>
<ul>
<li><a href="ImageViewer.html">ImageViewer</a></li>
<li><a href="MultiViewer.html">MultiViewer</a></li>
</ul>
<h3>Global</h3>
<ul>
<li><a href="global.html#alertMessage">alertMessage</a></li>
<li><a href="global.html#blender">blender</a></li>
<li><a href="global.html#colorToArray">colorToArray</a></li>
<li><a href="global.html#CONFIG">CONFIG</a></li>
<li><a href=
"global.html#createDraggableDiv">createDraggableDiv</a></li>
<li><a href="global.html#createId">createId</a></li>
<li><a href="global.html#createId2">createId2</a></li>
<li><a href="global.html#drawCross">drawCross</a></li>
<li><a href="global.html#drawPolygon">drawPolygon</a></li>
<li><a href="global.html#e">e</a></li>
<li><a href="global.html#editPolygon">editPolygon</a></li>
<li><a href="global.html#filterPopup">filterPopup</a></li>
<li><a href="global.html#getRandomInt">getRandomInt</a></li>
<li><a href="global.html#gridOverlay">gridOverlay</a></li>
<li><a href="global.html#img2array">img2array</a></li>
<li><a href="global.html#isEmpty">isEmpty</a></li>
<li><a href="global.html#isRealValue">isRealValue</a></li>
<li><a href="global.html#layerPopup">layerPopup</a></li>
<li><a href="global.html#layerUI">layerUI</a></li>
<li><a href="global.html#mapMarker">mapMarker</a></li>
<li><a href="global.html#markupTools">markupTools</a></li>
<li><a href="global.html#MAX">MAX</a></li>
<li><a href="global.html#MICRONS_PER_PIX">MICRONS_PER_PIX</a></li>
<li><a href="global.html#mugshots">mugshots</a></li>
<li><a href="global.html#populateStorage">populateStorage</a></li>
<li><a href="global.html#RENDER_TYPES">RENDER_TYPES</a></li>
<li><a href="global.html#ruler">ruler</a></li>
<li><a href="global.html#saveSettings">saveSettings</a></li>
<li><a href="global.html#scaleToPct">scaleToPct</a></li>
<li><a href="global.html#scaleToRgb">scaleToRgb</a></li>
<li><a href="global.html#setFilter">setFilter</a></li>
<li><a href="global.html#setOsdTracking">setOsdTracking</a></li>
<li><a href="global.html#STATE">STATE</a></li>
<li><a href="global.html#stringy">stringy</a></li>
<li><a href=
"global.html#synchronizeViewers">synchronizeViewers</a></li>
<li><a href="global.html#toggleButton">toggleButton</a></li>
<li><a href="global.html#toggleCross">toggleCross</a></li>
</ul>
</nav>
<br class="clear">
<footer>Documentation generated by <a href=
"https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Wed Jul 20
2022 14:05:36 GMT-0400 (Eastern Daylight Time)</footer>
<script>
 prettyPrint(); 
</script> 
<script src="scripts/linenumber.js"></script>
</body>
</html>
