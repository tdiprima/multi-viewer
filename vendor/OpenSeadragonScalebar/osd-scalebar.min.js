!function($){if(!$.version||$.version.major<2)throw new Error("This version of OpenSeadragonScalebar requires OpenSeadragon version 2.0.0+");function b(d,b,h,i,a){a=void 0===a?" ":a;var f=c(d,b),g=e(f/d*b,3);return{size:f*b,text:g+a+h+(i&&g>1?"s":"")}}function a(b,a,f){var d=c(b,a),h=e(d/b*a,3),i=g(h,f);return{size:d*a,text:i}}function c(b,c){var e=d(b),f=d(c),a=d(e/f);return a>=5&&(a/=5),a>=4&&(a/=4),a>=2&&(a/=2),a}function d(a){return a*Math.pow(10,Math.ceil(-f(a)))}function e(b,d){var e=-Math.ceil(-f(b)),a=d-e,c=b*Math.pow(10,a);return a<0?Math.round(c)*Math.pow(10,-a):Math.round(c)/Math.pow(10,a)}function f(a){return Math.log(a)/Math.log(10)}function g(a,b){return a<1e-6?1e9*a+" n"+b:a<.001?1e6*a+" \u03BC"+b:a<1?1e3*a+" m"+b:a>=1e3?a/1e3+" k"+b:a+" "+b}function h(a){return void 0!==a}$.Viewer.prototype.scalebar=function(a){this.scalebarInstance?this.scalebarInstance.refresh(a):((a=a||{}).viewer=this,this.scalebarInstance=new $.Scalebar(a))},$.ScalebarType={NONE:0,MICROSCOPY:1,MAP:2},$.ScalebarLocation={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4},$.Scalebar=function(a){if(!(a=a||{}).viewer)throw new Error("A viewer must be specified.");this.viewer=a.viewer,this.divElt=document.createElement("div"),this.viewer.container.appendChild(this.divElt),this.divElt.style.position="relative",this.divElt.style.margin="0",this.divElt.style.pointerEvents="none",this.setMinWidth(a.minWidth||"150px"),this.setDrawScalebarFunction(a.type||$.ScalebarType.MICROSCOPY),this.color=a.color||"black",this.fontColor=a.fontColor||"black",this.backgroundColor=a.backgroundColor||"none",this.fontSize=a.fontSize||"",this.fontFamily=a.fontFamily||"",this.barThickness=a.barThickness||2,this.pixelsPerMeter=a.pixelsPerMeter||null,this.referenceItemIdx=a.referenceItemIdx||0,this.location=a.location||$.ScalebarLocation.BOTTOM_LEFT,this.xOffset=a.xOffset||5,this.yOffset=a.yOffset||5,this.stayInsideImage=!h(a.stayInsideImage)||a.stayInsideImage,this.sizeAndTextRenderer=a.sizeAndTextRenderer||$.ScalebarSizeAndTextRenderer.METRIC_LENGTH;var b=this;this.viewer.addHandler("open",function(){b.refresh()}),this.viewer.addHandler("animation",function(){b.refresh()}),this.viewer.addHandler("resize",function(){b.refresh()})},$.Scalebar.prototype={updateOptions:function(a){a&&(h(a.type)&&this.setDrawScalebarFunction(a.type),h(a.minWidth)&&this.setMinWidth(a.minWidth),h(a.color)&&(this.color=a.color),h(a.fontColor)&&(this.fontColor=a.fontColor),h(a.backgroundColor)&&(this.backgroundColor=a.backgroundColor),h(a.fontSize)&&(this.fontSize=a.fontSize),h(a.fontFamily)&&(this.fontFamily=a.fontFamily),h(a.barThickness)&&(this.barThickness=a.barThickness),h(a.pixelsPerMeter)&&(this.pixelsPerMeter=a.pixelsPerMeter),h(a.referenceItemIdx)&&(this.referenceItemIdx=a.referenceItemIdx),h(a.location)&&(this.location=a.location),h(a.xOffset)&&(this.xOffset=a.xOffset),h(a.yOffset)&&(this.yOffset=a.yOffset),h(a.stayInsideImage)&&(this.stayInsideImage=a.stayInsideImage),h(a.sizeAndTextRenderer)&&(this.sizeAndTextRenderer=a.sizeAndTextRenderer))},setDrawScalebarFunction:function(a){a?a===$.ScalebarType.MAP?this.drawScalebar=this.drawMapScalebar:this.drawScalebar=this.drawMicroscopyScalebar:this.drawScalebar=null},setMinWidth:function(a){this.divElt.style.width=a,this.divElt.style.display="",this.minWidth=this.divElt.offsetWidth},refresh:function(e){if(this.updateOptions(e),!this.viewer.isOpen()||!this.drawScalebar||!this.pixelsPerMeter||!this.location){this.divElt.style.display="none";return}this.divElt.style.display="";var a,b,f=this.viewer.viewport,g=(a=this.viewer.world.getItemAt(this.referenceItemIdx),b=f.getZoom(!0),a._scaleSpring.current.value*a.viewport._containerInnerSize.x/a.source.dimensions.x*b*this.pixelsPerMeter),c=this.sizeAndTextRenderer(g,this.minWidth);this.drawScalebar(c.size,c.text);var d=this.getScalebarLocation();this.divElt.style.left=d.x+"px",this.divElt.style.top=d.y+"px"},drawMicroscopyScalebar:function(a,b){this.divElt.style.fontSize=this.fontSize,this.divElt.style.fontFamily=this.fontFamily,this.divElt.style.textAlign="center",this.divElt.style.color=this.fontColor,this.divElt.style.border="none",this.divElt.style.borderBottom=this.barThickness+"px solid "+this.color,this.divElt.style.backgroundColor=this.backgroundColor,this.divElt.innerHTML=b,this.divElt.style.width=a+"px"},drawMapScalebar:function(a,b){this.divElt.style.fontSize=this.fontSize,this.divElt.style.fontFamily=this.fontFamily,this.divElt.style.textAlign="center",this.divElt.style.color=this.fontColor,this.divElt.style.border=this.barThickness+"px solid "+this.color,this.divElt.style.borderTop="none",this.divElt.style.backgroundColor=this.backgroundColor,this.divElt.innerHTML=b,this.divElt.style.width=a+"px"},getScalebarLocation:function(){if(this.location===$.ScalebarLocation.TOP_LEFT){var a=0,b=0;if(this.stayInsideImage){var c=this.viewer.viewport.pixelFromPoint(new $.Point(0,0),!0);this.viewer.wrapHorizontal||(a=Math.max(c.x,0)),this.viewer.wrapVertical||(b=Math.max(c.y,0))}return new $.Point(a+this.xOffset,b+this.yOffset)}if(this.location===$.ScalebarLocation.TOP_RIGHT){var e=this.divElt.offsetWidth,d=this.viewer.container,a=d.offsetWidth-e,b=0;if(this.stayInsideImage){var c=this.viewer.viewport.pixelFromPoint(new $.Point(1,0),!0);this.viewer.wrapHorizontal||(a=Math.min(a,c.x-e)),this.viewer.wrapVertical||(b=Math.max(b,c.y))}return new $.Point(a-this.xOffset,b+this.yOffset)}if(this.location===$.ScalebarLocation.BOTTOM_RIGHT){var e=this.divElt.offsetWidth,f=this.divElt.offsetHeight,d=this.viewer.container,a=d.offsetWidth-e,b=d.offsetHeight-f;if(this.stayInsideImage){var c=this.viewer.viewport.pixelFromPoint(new $.Point(1,1/this.viewer.source.aspectRatio),!0);this.viewer.wrapHorizontal||(a=Math.min(a,c.x-e)),this.viewer.wrapVertical||(b=Math.min(b,c.y-f))}return new $.Point(a-this.xOffset,b-this.yOffset)}if(this.location===$.ScalebarLocation.BOTTOM_LEFT){var f=this.divElt.offsetHeight,d=this.viewer.container,a=0,b=d.offsetHeight-f;if(this.stayInsideImage){var c=this.viewer.viewport.pixelFromPoint(new $.Point(0,1/this.viewer.source.aspectRatio),!0);this.viewer.wrapHorizontal||(a=Math.max(a,c.x)),this.viewer.wrapVertical||(b=Math.min(b,c.y-f))}return new $.Point(a+this.xOffset,b-this.yOffset)}},getAsCanvas:function(){var a=document.createElement("canvas");a.width=this.divElt.offsetWidth,a.height=this.divElt.offsetHeight;var b=a.getContext("2d");b.fillStyle=this.backgroundColor,b.fillRect(0,0,a.width,a.height),b.fillStyle=this.color,b.fillRect(0,a.height-this.barThickness,a.width,a.height),this.drawScalebar===this.drawMapScalebar&&(b.fillRect(0,0,this.barThickness,a.height),b.fillRect(a.width-this.barThickness,0,this.barThickness,a.height)),b.font=window.getComputedStyle(this.divElt).font,b.textAlign="center",b.textBaseline="middle",b.fillStyle=this.fontColor;var c=a.width/2,d=a.height/2;return b.fillText(this.divElt.textContent,c,d),a},getImageWithScalebarAsCanvas:function(){var b=this.viewer.drawer.canvas,a=document.createElement("canvas");a.width=b.width,a.height=b.height;var c=a.getContext("2d");c.drawImage(b,0,0);var e=this.getAsCanvas(),d=this.getScalebarLocation();return c.drawImage(e,d.x,d.y),a}},$.ScalebarSizeAndTextRenderer={METRIC_LENGTH:function(b,c){return a(b,c,"m")},IMPERIAL_LENGTH:function(f,a){var d=2*a,c=.0254*f;if(d<12*c)return d<c?b(c/1e3,a,"th"):b(c,a,"in");var e=12*c;return d<2e3*e?b(e,a,"ft"):b(5280*e,a,"mi")},ASTRONOMY:function(c,a){var e=2*a;if(e<60*c)return b(c,a,'"',!1,"");var d=60*c;return e<60*d?b(d,a,"'",!1,""):b(60*d,a,"&#176",!1,"")},STANDARD_TIME:function(e,c){var d=2*c;if(d<60*e)return a(e,c,"s",!1);var f=60*e;if(d<60*f)return b(f,c,"minute",!0);var g=60*f;if(d<24*g)return b(g,c,"hour",!0);var h=24*g;return d<365.25*h?b(h,c,"day",!0):b(365.25*h,c,"year",!0)},METRIC_GENERIC:a}}(OpenSeadragon)