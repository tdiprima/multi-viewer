//! OpenseadragonFabricjsOverlay
//! Built on 2022-07-25
//! https://github.com/tdiprima/OpenseadragonFabricjsOverlay

!function(){if(!window.OpenSeadragon){console.error("[openseadragon-fabricjs-overlay] requires OpenSeadragon");return}OpenSeadragon.Viewer.prototype.fabricjsOverlay=function(a){return void 0===a?a={static:!1,scale:1}:(void 0===a.static&&(a.static=!1),void 0===a.scale&&(a.scale=1)),this._fabricjsOverlayInfo=new b(this,a.static),this._scale=a.scale,this._fabricjsOverlayInfo};let a,c=(a=1,function(){return a++}),b=function(b,d,a={}){a.enablePointerEvents=null!==window.PointerEvent;let e=this;this._viewer=b,this._containerWidth=0,this._containerHeight=0,this._canvasdiv=document.createElement("div"),this._canvasdiv.style.position="absolute",this._canvasdiv.style.left="0px",this._canvasdiv.style.top="0px",this._canvasdiv.style.width="100%",this._canvasdiv.style.height="100%",this._viewer.canvas.appendChild(this._canvasdiv),this._canvas=document.createElement("canvas"),this._id=`osd-overlaycanvas-${c()}`,this._canvas.setAttribute("id",this._id),this._canvasdiv.appendChild(this._canvas),this.resize(),d?this._fabricCanvas=new fabric.StaticCanvas(this._canvas,a):this._fabricCanvas=new fabric.Canvas(this._canvas,a),this._fabricCanvas.selection=!1,this._fabricCanvas.on("mouse:down",a=>{a.target&&(a.e.preventDefaultAction=!0,a.e.preventDefault(),a.e.stopPropagation())}),this._fabricCanvas.on("mouse:up",a=>{a.target&&(a.e.preventDefaultAction=!0,a.e.preventDefault(),a.e.stopPropagation())}),this._viewer.addHandler("update-viewport",()=>{e.resize(),e.resizeCanvas(),e.render()}),this._viewer.addHandler("open",()=>{e.resize(),e.resizeCanvas()}),window.addEventListener("resize",()=>{e.resize(),e.resizeCanvas()})};b.prototype={canvas(){return this._canvas},fabricCanvas(){return this._fabricCanvas},clear(){this._fabricCanvas.clear()},render(){this._fabricCanvas.renderAll()},resize(){this._containerWidth!==this._viewer.container.clientWidth&&(this._containerWidth=this._viewer.container.clientWidth,this._canvasdiv.setAttribute("width",this._containerWidth),this._canvas.setAttribute("width",this._containerWidth)),this._containerHeight!==this._viewer.container.clientHeight&&(this._containerHeight=this._viewer.container.clientHeight,this._canvasdiv.setAttribute("height",this._containerHeight),this._canvas.setAttribute("height",this._containerHeight))},resizeCanvas(){let d=new OpenSeadragon.Point(0,0),e=this._viewer.viewport.getZoom(!0);this._fabricCanvas.setWidth(this._containerWidth),this._fabricCanvas.setHeight(this._containerHeight),this._fabricCanvas.setZoom(e);let a=this._viewer.viewport.viewportToWindowCoordinates(d),f=Math.round(a.x),g=Math.round(a.y),b=this._canvasdiv.getBoundingClientRect(),c=OpenSeadragon.getPageScroll();this._fabricCanvas.absolutePan(new fabric.Point(b.left-f+c.x,b.top-g+c.y))}}}()