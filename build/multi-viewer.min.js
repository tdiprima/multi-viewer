/*! multi-viewer - v2.4.8 - 2021-05-07 */
const colorPicker=function(e){if(!isRealValue(e))throw Error("colorPicker.js: Expected input argument, but received none.");const t=new CP(e);return t.on("change",function(e,t,n,o){try{this.source.value=this.color(e,t,n,o),this.source.innerHTML=this.color(e,t,n,o),this.source.style.backgroundColor=this.color(e,t,n,o)}catch(e){console.error("Caught!",e.message)}}),t};function clearClassList(e){const t=e.classList;for(;t.length>0;)t.remove(t.item(0))}function toggleButtonHighlight(e){const t=e.classList.contains("btnOn");clearClassList(e),t?e.classList.add("btn"):e.classList.add("btnOn")}function buttonIsOn(e){return e.classList.contains("btnOn")}function isRealValue(e){return e&&"null"!==e&&"undefined"!==e}const isEmpty=function(e){const t=function(e){if(void 0===e.length){return!Object.keys(e).some(function(t){return!isEmpty(e[t])})&&t(Object.keys(e))}return!e.some(function(e){return!isEmpty(e)})};return!1===e||void 0===e||null===e||"object"==typeof e&&t(e)};function getAColorThatShowsUp(e){return e.endsWith("ff")&&"#00ffff"!==e&&"#ff00ff"!==e?"rgba(255, 255, 0, 0.5)":"rgba(0, 0, 255, 0.5)"}function alertMessage(e){return alert(e),!0}function calculateAspectRatioFit(e,t,n,o){const i=Math.min(n/e,o/t);return{width:Math.round(e*i),height:Math.round(t*i)}}function makeId(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length;let i;for(i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}const pageSetup=function(e,t,n,o,i,r,a,s,c,l){let d=[],u=0;document.addEventListener("DOMContentLoaded",function(){new Promise(function(e,t){return e(l)}).then(function(l){const h=document.getElementById(e),g=document.createElement("table");let f,m,p;g.id="myTable",h.appendChild(g);const v=r*a;let w=0;for(p=0;p<r;p++){const e=g.insertRow(p);let r;for(r=0;r<a;r++){w++;const a=e.insertCell(r),h=makeId(11);let g=makeId(5),p=makeId(5),y=makeId(5),b=makeId(5),k=w,C=document.createElement("div");C.className="divSquare",C.style.width=s+"px",a.appendChild(C);let E=`<div><i id="colors${k}" style="cursor: pointer;" class="fa fa-layer-group"></i></div>`;if(i>1&&(E+=`<input type="checkbox" id="chkPan${k}" checked=""><label for="chkPan${k}">Match Pan</label>&nbsp;\n<input type="checkbox" id="chkZoom${k}" checked=""><label for="chkZoom${k}">Match Zoom</label>&nbsp;&nbsp;`),l&&l.toolbarOn&&(E+=`<span class="controls" id="hideTools${k}" style="color:blue; cursor:pointer;">[+] </span><BR>\n<span id="tools${k}" hidden=true>`,l&&l.slidersOn&&(E+=`<span class="range">\n<input type="range" id="sliderRange${f=u+=1}" min="0" max="100" value="100" class="slider-square" style="display: inline;">\n<input type="range" id="sliderRange${m=u+=1}" min="0" max="100" value="100" class="slider-square" style="display: inline;">\n</span>`),E+='<span class="floated buttons">',l&&l.paintbrushColor?E+=`<mark id="mark${k}">${l.paintbrushColor}</mark>&nbsp;`:E+=`<mark id="mark${k}">#00f</mark>&nbsp;`,E+=`<button id="btnDraw${k}" class="btn"><i class="fas fa-pencil-alt"></i> Draw polygon</button>&nbsp;\n<button id="btnEdit${k}" class="btn"><i class="fas fa-draw-polygon"></i> Edit polygon</button>&nbsp;\n<button id="btnGrid${k}" class="btn"><i class="fas fa-border-all"></i> Draw grid</button>&nbsp;\n<button id="btnGridMarker${k}" class="btn"><i class="fas fa-paint-brush"></i> Mark grid</button>&nbsp;\n<button id="btnMapMarker" class="btn" style="display: none"><i class="fas fa-map-marker-alt"></i> Hide markers</button></div>`,E+="</span></span>"),l&&l.draggableLayers){E+=`<div class="tab" id="tabBox${k}">`;const e=/\b[a-zA-Z0-9]{2}-[a-zA-Z0-9]{4}\b/gm;try{E+=1===k?`<button class="tab_links" id="feat${g}" draggable="true">${n[0][0]?n[0][0].match(e):"Feat n"}</button>\n            <button class="tab_links" id="feat${p}" draggable="true">${n[1][0]?n[1][0].match(e):"Feat n"}</button>`:`<button class="tab_links" id="feat${y}" draggable="true">${n[0][0]?n[0][0].match(e):"Feat n"}</button>\n            <button class="tab_links" id="feat${b}" draggable="true">${n[1][0]?n[1][0].match(e):"Feat n"}</button>`}catch(e){console.error(e.message)}E+="&nbsp;</div>"}if(E+=`<div id="${h}" class="viewer" style="width: ${s}px; height: ${c}px;"></div>`,C.innerHTML=E,l&&l.toolbarOn){let e=document.getElementById("hideTools"+k),t=document.getElementById("tools"+k);e.addEventListener("click",function(){t.hidden?(t.hidden=!1,this.textContent="[-] ",this.style.color="maroon"):(t.hidden=!0,this.textContent="[+] ",this.style.color="blue")}),colorPicker(document.getElementById("mark"+k))}let L=[];try{L.push(document.getElementById("sliderRange"+f)),L.push(document.getElementById("sliderRange"+m))}catch(e){console.log(e)}if(d.push(new MultiViewer(k,h,t,n,o,L,i,l)),i<v&&w-1===i)break}}return d}).then(function(e){synchronizeViewers(e)})})},editPolygon=function(e,t){document.getElementById("btnEdit"+e).addEventListener("click",function(){toggleButtonHighlight(this),Edit(t.fabricCanvas())})};function polygonPositionHandler(e,t,n){const o=n.points[this.pointIndex].x-n.pathOffset.x,i=n.points[this.pointIndex].y-n.pathOffset.y;return fabric.util.transformPoint({x:o,y:i},fabric.util.multiplyTransformMatrices(n.canvas.viewportTransform,n.calcTransformMatrix()))}function actionHandler(e,t,n,o){const i=t.target,r=i.controls[i.__corner],a=i.toLocalPoint(new fabric.Point(n,o),"center","center"),s=i._getNonTransformedDimensions(),c=i._getTransformedDimensions(0,0),l={x:a.x*s.x/c.x+i.pathOffset.x,y:a.y*s.y/c.y+i.pathOffset.y};return i.points[r.pointIndex]=l,!0}function anchorWrapper(e,t){return function(n,o,i,r){const a=o.target,s=fabric.util.transformPoint({x:a.points[e].x-a.pathOffset.x,y:a.points[e].y-a.pathOffset.y},a.calcTransformMatrix()),c=t(n,o,i,r),l=(a._setPositionDimensions({}),a._getNonTransformedDimensions()),d=(a.points[e].x-a.pathOffset.x)/l.x,u=(a.points[e].y-a.pathOffset.y)/l.y;return a.setPositionByOrigin(s,d+.5,u+.5),c}}function getPolygon(e){if(e.getActiveObject())return e.getActiveObject();{const t=e.getObjects("polygon");return 0===t.length?"null":1===t.length?t[0]:"null"}}function Edit(e){const t=getPolygon(e);if(isRealValue(t)){e.setActiveObject(t),t.edit=!t.edit;const n=getAColorThatShowsUp(t.stroke);if(t.edit){const e=t.points.length-1;t.cornerStyle="circle",t.cornerColor=n,t.controls=t.points.reduce(function(t,n,o){return t["p"+o]=new fabric.Control({positionHandler:polygonPositionHandler,actionHandler:anchorWrapper(o>0?o-1:e,actionHandler),actionName:"modifyPolygon",pointIndex:o}),t},{})}else t.cornerColor=n,t.cornerStyle="rect",t.controls=fabric.Object.prototype.controls;t.hasBorders=!t.edit,e.requestRenderAll()}else alertMessage("Please select a polygon for editing.")}const drawPolygon=function(e,t,n){const o=document.getElementById("btnDraw"+e),i=document.getElementById("mark"+e),r=n.fabricCanvas(),a=r.freeDrawingBrush=new fabric.PencilBrush(r);a.decimate=20,a.color=i.innerHTML,r.on("mouse:over",function(e){fillPolygon(e,r)}),r.on("mouse:out",function(e){unfillPolygon(e,r)}),r.on("mouse:up",function(){turnDrawingOff(r,t)}),r.on("path:created",function(e){pathCreatedHandler(e,o,r,a,t)}),o.addEventListener("click",function(){toggleButtonHighlight(this),r.isDrawingMode?turnDrawingOff(r,t):turnDrawingOn(r,t,a,i)})};function turnDrawingOff(e,t){e.isDrawingMode=!1,e.off("mouse:down",function(){setGestureSettings(e,t)}),t.setMouseNavEnabled(!0),t.outerTracker.setTracking(!0)}function turnDrawingOn(e,t,n,o){e.isDrawingMode=!0,e.on("mouse:down",function(){setGestureSettings(e,t)}),n.color=o.innerHTML,n.width=10/t.viewport.getZoom(!0),t.setMouseNavEnabled(!1),t.outerTracker.setTracking(!1)}function pathCreatedHandler(e,t,n,o,i){convertPathToPolygon(e.path,n,o),customizePolygonControls(e.path,n,i),clearClassList(t),t.classList.add("btn"),n.off("path:created",function(){pathCreatedHandler(e,t,n,o,i)})}function setGestureSettings(e,t){e.getActiveObject()?t.gestureSettingsMouse.clickToZoom=!1:($(".deleteBtn").remove(),t.gestureSettingsMouse.clickToZoom=!0)}function customizePolygonControls(e,t,n){e.hasControls=!1,e.lockMovementX=!0,e.lockMovementY=!0,setupDeleteButton(t,n)}function setupDeleteButton(e,t){function n(e,t){jQuery(".deleteBtn").remove();const n=`<img src="images/delete-icon.png" class="deleteBtn" style="position:absolute;top:${t-10}px;left:${e-10}px;cursor:pointer;width:20px;height:20px;"/>`;jQuery(".canvas-container").append(n)}e.on("selection:created",function(e){n(e.target.oCoords.tr.x,e.target.oCoords.tr.y)}),e.on("object:modified",function(e){isRealValue(e.target.oCoords.tr)&&n(e.target.oCoords.tr.x,e.target.oCoords.tr.y)}),e.on("object:scaling",function(e){jQuery(".deleteBtn").remove()}),e.on("object:moving",function(e){jQuery(".deleteBtn").remove()}),e.on("object:rotating",function(e){jQuery(".deleteBtn").remove()}),jQuery(".canvas-container").on("click",".deleteBtn",function(){t.gestureSettingsMouse.clickToZoom=!1,e.getActiveObject()&&(e.remove(e.getActiveObject()),jQuery(".deleteBtn").remove()),t.gestureSettingsMouse.clickToZoom=!0})}function convertPathToPolygon(e,t,n){const o=e.path.map(e=>({x:e[1],y:e[2]})),i=getAColorThatShowsUp(e.stroke),r=new fabric.Polygon(o,{left:e.left,top:e.top,fill:"",strokeWidth:n.width,stroke:n.color,scaleX:e.scaleX,scaleY:e.scaleY,objectCaching:!1,transparentCorners:!1,cornerColor:i});t.add(r),t.setActiveObject(r),t.remove(e)}function fillPolygon(e,t){if(weHoveredOverPolygon(e)){const n=e.target;n.set({fill:n.stroke,opacity:.5}),t.renderAll()}}function unfillPolygon(e,t){if(weHoveredOverPolygon(e)){const n=e.target;null!==n&&(n.set({fill:""}),t.renderAll())}}function weHoveredOverPolygon(e){return isRealValue(e.target)&&"polygon"===e.target.type}const mugshots=function(e){const t=this.__canvas=e.overlay.fabricCanvas();e.overlay.resizeCanvas=function(){const e=this._viewer.world.getItemAt(0);this._fabricCanvas.setWidth(this._containerWidth),this._fabricCanvas.setHeight(this._containerHeight),this._fabricCanvas.setZoom(e.viewportToImageZoom(this._viewer.viewport.getZoom(!0)));const t=e.imageToWindowCoordinates(new OpenSeadragon.Point(0,0)),n=this._canvasdiv.getBoundingClientRect(),o=OpenSeadragon.getPageScroll();this._fabricCanvas.absolutePan(new fabric.Point(n.left-Math.round(t.x)+o.x,n.top-Math.round(t.y)+o.y))};const n=e.viewer.viewport,o="256,",i="0",r="default",a="jpg";function s(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function c(c,l,d,u){let h;!function(e){const t=e.getTopLeft();t.x%1!=0&&console.warn(t.x,"not a whole number");t.y%1!=0&&console.warn(t.y,"not a whole number")}(h=function(e,t){return void 0!==e&&void 0!==t&&e>=0&&t>=0}(d,u)?new OpenSeadragon.Rect(d,u,e.thumbnailSize,e.thumbnailSize):function(t){const n=2*e.thumbnailSize,o=s(n,t.width-n),i=s(n,t.height-n);return new OpenSeadragon.Rect(o,i,e.thumbnailSize,e.thumbnailSize)}(c));const g=document.createElement("IMG");g.alt="mugshot",g.classList.add("thumbnail-image"),g.src=function(e,t){return e+"/"+t.getTopLeft().x+","+t.getTopLeft().y+","+t.width+","+t.height+"/"+o+"/"+i+"/"+r+"."+a}(e.infoUrl,h),l.appendChild(g),g.addEventListener("click",function(){!function(o){(function(e){const t=n.imageToViewportRectangle(e);n.panTo(t.getCenter()),n.zoomTo(n.getMaxZoom())})(o),function(n){t.add(new fabric.Rect({stroke:e.roiColor,strokeWidth:2,fill:"",left:n.x,top:n.y,width:n.width,height:n.height})),t.renderAll()}(o)}(h)})}!function(t){let n,o,i;const r=document.createDocumentFragment();let a;for((n=document.createElement("ul")).classList.add("thumbnail-list"),r.appendChild(n),a=0;a<e.scrollerLength;a++)o=document.createElement("li"),n.appendChild(o),i=document.createElement("span"),c(t,i),o.appendChild(i);document.getElementById(e.thumbId).appendChild(r)}(e.imgDims)},gridOverlay=function(e,t){const n={canvas:t.fabricCanvas(),canvasWidth:Math.ceil(t.fabricCanvas().width),canvasHeight:Math.ceil(t.fabricCanvas().height),cellWidth:25,cellHeight:25,color:"#C0C0C0",cellX:[],cellY:[],gridAdded:!1};document.getElementById("btnGrid"+e).addEventListener("click",function(){gridHandler(this,n)}),document.getElementById("btnGridMarker"+e).addEventListener("click",function(){markerHandler(this,n)})};function gridHandler(e,t){toggleButtonHighlight(e),buttonIsOn(e)&&(turnGridOn(t),t.gridAdded=!0,e.innerHTML='<i class="fas fa-border-all"></i> Remove grid'),buttonIsOn(e)||(turnGridOff(t),t.gridAdded=!1,e.innerHTML='<i class="fas fa-border-all"></i> Draw grid')}function turnGridOff(e){const t=e.canvas.getObjects("line");let n;for(n=0;n<t.length;n++)e.canvas.remove(t[n])}function turnGridOn(e){const t={stroke:e.color,strokeWidth:2,selectable:!1};createHorizontalLines(e,t),createVerticalLines(e,t),e.canvas.renderAll(),e.gridAdded=!0}function createHorizontalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasHeight/e.cellHeight);++n)e.canvas.add(new fabric.Line([0,n*e.cellHeight,e.canvasWidth,n*e.cellHeight],t)),e.cellY[n+1]=n*e.cellHeight}function createVerticalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasWidth/e.cellWidth);++n)e.canvas.add(new fabric.Line([n*e.cellWidth,0,n*e.cellWidth,e.canvasHeight],t)),e.cellX[n+1]=n*e.cellWidth}function fillInGrid(e,t){const n=getCellPosition(getMousePosition(e,t)),o=new fabric.Rect({left:t.cellX[n.x],top:t.cellY[n.y],fill:"red",width:t.cellWidth,height:t.cellHeight,opacity:.5,selectable:!1});t.canvas.add(o)}function getMousePosition(e,t){const n=t.canvas.getPointer(e.e);return{x:n.x/t.cellWidth,y:n.y/t.cellHeight}}function getCellPosition(e){return{x:Math.ceil(e.x+.001),y:Math.ceil(e.y+.001)}}function markerHandler(e,t){toggleButtonHighlight(e);const n=buttonIsOn(e);n||(t.canvas.__eventListeners["mouse:move"]=[],e.innerHTML='<i class="fas fa-paint-brush"></i> Mark grid'),n&&(t.gridAdded?(t.canvas.on("mouse:move",function(e){fillInGrid(e,t)}),e.innerHTML='<i class="fas fa-paint-brush"></i> Done marking'):(toggleButtonHighlight(e),alertMessage("Please draw a grid first.")))}const mapMarker=function(e,t){overrideRightClickMenu(e.element),handleMarkerDisplay(e,t),handleButtonShowHide()};function overrideRightClickMenu(e){e.addEventListener("contextmenu",function(e){e.preventDefault()})}function handleMarkerDisplay(e,t){e.addHandler("canvas-nonprimary-press",function(n){if(isRightClick(n)){const o=n.position,i=e.viewport.pointFromPixel(o);document.querySelectorAll("#btnMapMarker").forEach(function(e){e.style.display="block"}),displayMapMarker(i,e,t)}})}function isRightClick(e){return 2===e.button}function displayMapMarker(e,t,n){n.forEach(function(n){const o=n.getViewer();o.id!==t.id&&addMarkerToViewer(e,o)})}function addMarkerToViewer(e,t){const n=createLink();t.addOverlay({element:n,location:e,placement:"BOTTOM",checkResize:!1})}function createLink(){const e=document.createElement("a");return e.href="#",e.dataset.href="#",e.id="the-map-marker",e.className="fas fa-map-marker",e.style.cssText=" text-decoration: none; font-size: 22px; color: red; cursor: pointer",e}function handleButtonShowHide(){document.querySelectorAll("#btnMapMarker").forEach(function(e){let t,n,o=!1;e.addEventListener("click",function(){o?(t="block",n='<i class="fas fa-map-marker"></i> Hide markers'):(t="none",n='<i class="fas fa-map-marker"></i> Show markers'),this.innerHTML=n,document.querySelectorAll("#the-map-marker").forEach(function(e){e.style.display=t}),o=!o})})}const markupTools=function(e,t){const n=t.fabricjsOverlay({scale:1e3});drawPolygon(e,t,n),editPolygon(e,n),gridOverlay(e,n)};let imageFiltering=function(){"use strict";let e=[];!function(){function t(e,t,n){this.r=e,this.g=t,this.b=n}e.push(new t(0,255,0)),e.push(new t(0,255,0)),e.push(new t(255,255,0)),e.push(new t(0,255,255)),e.push(new t(255,0,0)),e.push(new t(255,165,0)),e.push(new t(0,128,0)),e.push(new t(0,0,255)),e.push(new t(75,0,130)),e.push(new t(28,28,28)),e.push(new t(167,226,46)),e.push(new t(31,120,180)),e.push(new t(255,210,4))}();let t=[{color:"rgba(75, 0, 130, 255)",low:201,hi:255}],n=1;function o(e){try{e.setFilterOptions({filters:[{items:e.world.getItemAt(0===n?1:n),processors:[l().prototype.COLORLEVELS(t)]}]})}catch(e){console.log("OK")}}function i({id:e,val:n,index:i},r){let a=document.createElement("input");return a.id=e,a.setAttribute("type","number"),a.min="0",a.max="255",a.step="1",a.value=n.toString(),a.size=5,a.addEventListener("input",function(){let e=parseInt(this.value);e>255&&(this.value="255"),e<0&&(this.value="0"),this.id.startsWith("low")?t[i].low=parseInt(this.value):(t[i].hi=parseInt(this.value),o(r))}),a}function r(e,t){jQuery("*").each(function(){if(this.id.startsWith("osd-overlaycanvas")){let n=this.id.slice(-1),o=document.getElementById(`colors${n}`);o.style.color=e,o.style.cursor=t}})}function a(e){let t;const n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),o=(n&&n[4]||"").trim();let i=n?(256|n[1]).toString(16).slice(1)+(256|n[2]).toString(16).slice(1)+(256|n[3]).toString(16).slice(1):e;return i=`#${i+=t=(256|(t=""!==o?o:1)).toString(16).slice(1)}`}function s(e,n,i){const r=new CP(e);r.on("change",(e,a,s,c)=>{try{r.source.value=r.color(e,a,s,c),r.source.innerHTML=r.color(e,a,s,c),r.source.style.backgroundColor=r.color(e,a,s,c),t[n].color=`rgba(${e}, ${a}, ${s}, ${255*c})`,o(i)}catch(e){console.warn("check this:",e.message)}})}function c({clientX:e,clientY:n},{style:o},c){r("#ccc","not-allowed"),o.color="#0f0",o.cursor="pointer";let l=document.createElement("div");l.id="colorPopup",l.classList.add("grid-container"),l.classList.add("colorPopup");let d=document.createElement("div");d.className="popupHeader";const u=document.createElement("img");u.src="images/close_icon.png",u.width=25,u.height=25,u.style.cssFloat="left",d.appendChild(u),u.addEventListener("click",function(){o.color="#000",r("#000","pointer"),this.parentNode.parentNode.remove()}),l.appendChild(d);const h=document.createElement("div");h.className="popupHeader",h.innerHTML="Color Levels",l.appendChild(h);let g=document.createElement("div");g.className="popupHeader",l.appendChild(g),t.sort(function(e,t){return e.low>t.low?-1:e.low<t.low?1:void 0}),function(e,n){let o;for(o=0;o<t.length;o++){let r=document.createElement("div"),c=t[o].color,l=document.createElement("mark");l.id=`marker${o}`,l.innerHTML=a(c),r.appendChild(l),s(l,o,n);let d=document.createElement("div"),u={id:`low${o}`,val:t[o].low,index:o};d.appendChild(i(u,n));let h=document.createElement("div");u={id:`hi${o}`,val:t[o].hi,index:o},h.appendChild(i(u,n)),e.appendChild(r),e.appendChild(d),e.appendChild(h)}}(l,c),l.style.left=`${e}px`,l.style.top=`${n}px`,document.body.appendChild(l),function(e){let t=0,n=0,o=0,i=0,r=document.getElementsByClassName("popupHeader");if(r){let e;for(e=0;e<r.length;e++)r[e].onmousedown=a}function a(e){(e=e||window.event).preventDefault(),o=e.clientX,i=e.clientY,document.onmouseup=c,document.onmousemove=s}function s(r){(r=r||window.event).preventDefault(),t=o-r.clientX,n=i-r.clientY,o=r.clientX,i=r.clientY,e.style.top=e.offsetTop-n+"px",e.style.left=e.offsetLeft-t+"px"}function c(){document.onmouseup=null,document.onmousemove=null}}(l)}let l=function(){let e=OpenSeadragon.Filters.GREYSCALE;return e.prototype.COLORLEVELS=(t=>(n,o)=>{if(n.canvas.width>0&&n.canvas.height>0){let e=n.getImageData(0,0,n.canvas.width,n.canvas.height);if(void 0!==typeof e){try{const n=e.data;let o;for(o=0;o<n.length;o+=4)if(255===n[o+3]){let e=i(n[o],t);void 0===e&&console.warn("rgba undefined",n[o]),n[o]=e[0],n[o+1]=e[1],n[o+2]=e[2],n[o+3]=e[3]}else n[o+3]=0}catch(e){console.warn("1:",e.message)}function i(e,t){try{let n,o;for(n=0;n<t.length;n++){let i=t[n].low,r=t[n].hi,a=t[n].color;e>=i&&e<=r&&(o=a.replace(/[a-z%\s\(\)]/g,"").split(","))}return void 0===o?e:o}catch(e){console.warn("2:",e.message)}}try{n.putImageData(e,0,0),o()}catch(e){console.warn("3:",e.message)}}else console.warn("imgData undefined")}else e=null,console.warn("Canvas width and height are 0. Setting filter to null")}),e};return{getFilter:function(){let e=OpenSeadragon.Filters.GREYSCALE;return e.prototype.COLORIZE=(({r:t,g:n,b:o})=>(i,r)=>{if(i.canvas.width>0&&i.canvas.height>0){let e=i.getImageData(0,0,i.canvas.width,i.canvas.height);if(void 0!==typeof e){try{const i=e.data;let r;for(r=0;r<i.length;r+=4)255===i[r+3]?(i[r]=t,i[r+1]=n,i[r+2]=o,i[r+3]=255):i[r+3]=0}catch(e){console.warn("1:",e.message)}try{i.putImageData(e,0,0),r()}catch(e){console.warn("2:",e.message)}}else console.warn("imgData undefined")}else e=null,console.warn("Canvas width and height are 0. Setting filter to null")}),e},getFilter1:l,handleColorLevels:function(e,t){e.addEventListener("click",n=>{n=n||window.event,document.getElementById("colorPopup")||c(n,e,t)})},getColors:()=>e,getColor:t=>t>=e.length?e[Math.floor(Math.random()*e.length-1)]:e[t],getColorRanges:()=>t,setColorRanges(e){t=e},getLayerNumber:()=>n,setLayerNumber(e){n=e}}};class ImageViewer{constructor(e,t,n,o,i,r){this.viewer={},this.options=r,this.imf=filters(),this.setSources(e,n,o,i,this.setViewer(t),this.imf,this.options)}setViewer(e){let t;try{t=OpenSeadragon({id:e,prefixUrl:"vendor/openseadragon/images/",crossOriginPolicy:"Anonymous"})}catch(e){console.warn("setViewer",e),t=null}return this.viewer=t,t}getViewer(){return this.viewer}getImF(){return this.imf}setSources(e,t,n,o,i,r,a){let s=e-1,c=o[s];jQuery.get(t).done(function(){i.addTiledImage({tileSource:t,opacity:1,x:0,y:0}),function(e,t){if(void 0===t)return!1;if(0===t.length)return!1;if(void 0===t[e-1])return!1;if(0===t[e-1].length)return!1;return!0}(e,n)&&n[s].forEach(function(e,t){i.addTiledImage({tileSource:e,opacity:c[t].toFixed(1),x:0,y:0})}),function(e,t,n){try{e.world.addHandler("add-item",function(o){let i=e.world.getIndexOfItem(o.item),r=function(e,t){let n;t&&t.length>0?(e.setColorRanges(t),n=e.getFilter1()):n=e.getFilter();return n}(t,n);null!==r&&i>0&&(t.setLayerNumber(i),n.length>0?e.setFilterOptions({filters:[{items:e.world.getItemAt(i),processors:[r.prototype.COLORLEVELS(n)]}]}):e.setFilterOptions({filters:[{items:e.world.getItemAt(i),processors:[r.prototype.COLORIZE(t.getColor(i))]}]}),e.world.getItemAt(i).source.getTileUrl=function(e,t,n){return function(e,t,n,o){const i=Math.pow(.5,e.maxLevel-t),r=Math.ceil(e.width*i),a=Math.ceil(e.height*i),s=e.getTileWidth(t);let c;const l=c=Math.ceil(s/i);let d,u,h,g,f,m;r<s&&a<s?(m=r+",",d="full"):(u=n*c,h=o*l,g=Math.min(c,e.width-u),f=Math.min(l,e.height-h),m=Math.ceil(g*i)+",",d=[u,h,g,f].join(","));return[e["@id"],d,m,"0","default.png"].join("/")}(this,e,t,n)})})}catch(e){console.error("Here we are",e.message)}}(i,r,a.colorRanges)}).fail(function(e,n){!function(e,t){const n="ImageViewer.js: Url for the viewer isn't good... please check.";throw console.warn(n),console.log("jqXHR object:",t),console.log("URL",e),document.write(`<h1>${n}</h1><b>URL:</b>&nbsp;${e}<br><br><b>Check the console for any clues.`),new Error("Something went wrong.")}(t,e)})}}class MultiViewer extends ImageViewer{constructor(e,t,n,o,i,r,a,s){super(e,t,n,o,i,s),void 0===s&&(s={});try{this.checkboxes={checkPan:!0,checkZoom:!0},this.viewer1=super.getViewer(),this.idx=e,this.sliders=r,this.imf=super.getImF(),a>1&&(this.checkboxes.checkPan=document.getElementById("chkPan"+this.idx),this.checkboxes.checkZoom=document.getElementById("chkZoom"+this.idx)),s.slidersOn&&s.toolbarOn&&addInputHandler(this.sliders,this.viewer1),s.toolbarOn&&markupTools(this.idx,this.viewer1),s.draggableLayers&&handleDraggable();let t=document.getElementById("colors"+this.idx);if(t)if(s.colorRanges){let e=this.imf.getColorRanges();isEmpty(e)&&this.imf.setColorRanges(s.colorRanges),this.imf.handleColorLevels(t,this.viewer1)}else console.warn("No colors, no button for you."),t.style.visibility=hidden}catch(e){console.log(e)}}getViewer(){return this.viewer1}getPanZoom(){return this.checkboxes}}function handleDraggable(){let e=document.querySelectorAll(".tab_links");function t(e){return e.preventDefault&&e.preventDefault(),!1}function n(e){this.classList.add("over")}function o(e){this.classList.remove("over")}function i(e){this.style.opacity="0.4",dragSrcEl=this,sourceViewer=whichViewer(dragSrcEl.parentElement.parentElement),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text",e.target.id)}function r(t){this.style.opacity="1",e.forEach(function(e){e.classList.remove("over")})}function a(e){if(e.stopPropagation(),dragSrcEl!==this){let t=e.dataTransfer.getData("text"),n=e.target.parentElement;if(n.classList.contains("divSquare")){let o;e.target.appendChild(document.getElementById(t));let i=whichViewer(n);o=i.world.getItemCount()-1,i.world.getItemAt(o).setOpacity(1),o=sourceViewer.world.getItemCount()-1,sourceViewer.world.getItemAt(o).setOpacity(0)}}return!1}e.forEach(function(e){e.setAttribute("draggable","true"),e.addEventListener("dragstart",i,!1),e.addEventListener("dragend",r,!1)}),(e=document.querySelectorAll(".tab")).forEach(function(e){e.addEventListener("dragenter",n,!1),e.addEventListener("dragleave",o,!1),e.addEventListener("dragover",t,!1),e.addEventListener("drop",a,!1)})}function whichViewer(e){let t,n,o,i=e.children;for(n=0;n<i.length;n++){let e=i[n];if(e.classList.contains("viewer"))try{for(o=0;o<syncedImageViewers.length;o++)if(syncedImageViewers[o].getViewer().id===e.id){t=syncedImageViewers[o].getViewer();break}}catch(e){console.warn("No syncedImageViewers")}}return t}function addInputHandler(e,t){let n;for(n=0;n<e.length;n++)e[n].addEventListener("input",function(){let e;e=(this.id.replace("sliderRange","")-1)%2==0?0:1;const n=t.world.getItemAt(e);void 0!==n?n.setOpacity(this.value/100):this.hidden=!0})}const synchronizeViewers=function(e){checkData(e)&&(this.syncedImageViewers=[],this.activeViewerId=null,this.numViewers=e.length,e.forEach(function(e){const t=e.getViewer();var n,o;setPanZoomCurrent(t,function(){if(!isActive(t.id))return;setPanZoomOthers(e),resetFlag()}),n=t,o=this.syncedImageViewers,overrideRightClickMenu(n.element),handleMarkerDisplay(n,o),handleButtonShowHide(),this.syncedImageViewers.push(e)}))};function setPanZoomCurrent(e,t){e.addHandler("pan",t),e.addHandler("zoom",t)}function isActive(e){return init(e),e===this.activeViewerId}function init(e){isRealValue(this.activeViewerId)||(this.activeViewerId=e)}function isPanOn(e){const t=e.getPanZoom();return void 0!==t.checkPan.checked?t.checkPan.checked:1!==this.numViewers}function isZoomOn(e){const t=e.getPanZoom();return void 0!==t.checkZoom.checked?t.checkZoom.checked:1!==this.numViewers}function setPanZoomOthers(e){const t=e.getViewer();this.syncedImageViewers.forEach(function(n){const o=n.getViewer();o.id!==t.id&&(isPanOn(n)&&isPanOn(e)&&o.viewport.panTo(t.viewport.getCenter(!1),!1),isZoomOn(n)&&isZoomOn(e)&&o.viewport.zoomTo(t.viewport.getZoom(!1)))})}function resetFlag(){this.activeViewerId=null}function checkData(e){return isEmpty(e)?(console.error("synchronizeViewers.js: Expected input argument, but received none."),!1):e[0]instanceof Object||(console.error("synchronizeViewers.js: Array elements should be MultiViewer objects."),!1)}