/*! multi-viewer - v2.4.8 - 2021-06-03 */
function clearClassList(e){const t=e.classList;for(;t.length>0;)t.remove(t.item(0))}function toggleButton(e,t,n){e.classList.contains(t)?(e.classList.remove(t),e.classList.add(n)):(e.classList.remove(n),e.classList.add(t))}function isRealValue(e){return e&&"null"!==e&&"undefined"!==e}const isEmpty=function(e){const t=function(e){if(void 0===e.length){return!Object.keys(e).some(function(t){return!isEmpty(e[t])})&&t(Object.keys(e))}return!e.some(function(e){return!isEmpty(e)})};return!1===e||void 0===e||null===e||"object"==typeof e&&t(e)};function getAColorThatShowsUp(e){return e.endsWith("ff")&&"#00ffff"!==e&&"#ff00ff"!==e?"rgba(255, 255, 0, 0.5)":"rgba(0, 0, 255, 0.5)"}function alertMessage(e){return alert(e),!0}function calculateAspectRatioFit(e,t,n,o){const r=Math.min(n/e,o/t);return{width:Math.round(e*r),height:Math.round(t*r)}}function makeId(e,t){let n="";const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=o.length;let i;for(i=0;i<e;i++)n+=o.charAt(Math.floor(Math.random()*r));return t&&(n=t+n),n}function getStringRep(e){let t=e.hashCode();return t<0&&(t*=-1),t.toString(16).toUpperCase()}async function fetchAsync(e){const t=await fetch(e);return await t.json()}String.prototype.hashCode=function(){let e,t,n=0;if(0===this.length)return n;for(e=0;e<this.length;e++)n=(n<<5)-n+(t=this.charCodeAt(e)),n&=n;return n};const pageSetup=function(e,t,n,o,r,i,a,s,l){let c=[];document.addEventListener("DOMContentLoaded",function(){new Promise(function(e,t){return e(l)}).then(function(l){let d=document.createElement("button");d.innerHTML="Toggle Dark Mode",document.querySelector("#contentDiv").before(d),d.addEventListener("click",function(){document.body.classList.toggle("dark-mode")});const u=document.getElementById(e),f=document.createElement("table");let g;f.id="myTable",u.appendChild(f);const h=r*i;let p=0;for(g=0;g<r;g++){const e=f.insertRow(g);let r;for(r=0;r<i;r++){const i=e.insertCell(r),d=makeId(11);let u=p;p++;let f=document.createElement("div");f.className="divSquare",f.style.width=a+"px",i.appendChild(f);let g="";o>1&&(g+=`<input type="checkbox" id="chkPan${u}" checked=""><label for="chkPan${u}">Match Pan</label>&nbsp;\n<input type="checkbox" id="chkZoom${u}" checked=""><label for="chkZoom${u}">Match Zoom</label>&nbsp;&nbsp;`),l&&l.toolbarOn&&(g+=`<div class="controls showDiv" id="hideTools${u}"><div id="tools${u}" class="showHover">`,g+='<div class="floated buttons">',l&&l.paintbrushColor?g+=`<mark id="mark${u}">${l.paintbrushColor}</mark>&nbsp;`:g+=`<mark id="mark${u}">#00f</mark>&nbsp;`,g+=`<button id="btnDraw${u}" class="btn"><i class="fas fa-pencil-alt"></i> Draw polygon</button>&nbsp;\n<button id="btnEdit${u}" class="btn"><i class="fas fa-draw-polygon"></i> Edit polygon</button>&nbsp;\n<button id="btnGrid${u}" class="btn"><i class="fas fa-border-all"></i> Draw grid</button>&nbsp;\n<button id="btnGridMarker${u}" class="btn"><i class="fas fa-paint-brush"></i> Mark grid</button>&nbsp;\n<button id="btnRuler${u}" class="btn"><i class="fas fa-ruler"></i> Ruler</button>&nbsp;\n<button id="btnMapMarker" class="btn" style="display: none"><i class="fas fa-map-marker-alt"></i> Hide markers</button></div>`,g+="</div></div>"),g+=`<table><tr><td><div id="${d}" class="viewer drop_site" style="width: ${a}px; height: ${s}px;"></div>\n</td><td style="vertical-align: top;"><span id="layers_and_colors${u}"></span></td>\n</tr></table>`,f.innerHTML=g,new CP(document.getElementById("mark"+u)).on("change",function(e,t,n,o){this.source.value=this.color(e,t,n,o),this.source.style.backgroundColor=this.color(e,t,n,o)});let m=n.features,y=n.opacities,v={features:m[u],opacities:y[u]};if(c.push(new MultiViewer(u,d,t,v,o,l)),o<h&&p-1===o)break}}return c}).then(function(e){synchronizeViewers(e)})})},editPolygon=function(e,t){e.addEventListener("click",function(){toggleButton(this,"btnOn","btn"),Edit(t.fabricCanvas())})};function polygonPositionHandler(e,t,n){const o=n.points[this.pointIndex].x-n.pathOffset.x,r=n.points[this.pointIndex].y-n.pathOffset.y;return fabric.util.transformPoint({x:o,y:r},fabric.util.multiplyTransformMatrices(n.canvas.viewportTransform,n.calcTransformMatrix()))}function actionHandler(e,t,n,o){const r=t.target,i=r.controls[r.__corner],a=r.toLocalPoint(new fabric.Point(n,o),"center","center"),s=r._getNonTransformedDimensions(),l=r._getTransformedDimensions(0,0),c={x:a.x*s.x/l.x+r.pathOffset.x,y:a.y*s.y/l.y+r.pathOffset.y};return r.points[i.pointIndex]=c,!0}function anchorWrapper(e,t){return function(n,o,r,i){const a=o.target,s=fabric.util.transformPoint({x:a.points[e].x-a.pathOffset.x,y:a.points[e].y-a.pathOffset.y},a.calcTransformMatrix()),l=t(n,o,r,i),c=(a._setPositionDimensions({}),a._getNonTransformedDimensions()),d=(a.points[e].x-a.pathOffset.x)/c.x,u=(a.points[e].y-a.pathOffset.y)/c.y;return a.setPositionByOrigin(s,d+.5,u+.5),l}}function getPolygon(e){if(e.getActiveObject())return e.getActiveObject();{const t=e.getObjects("polygon");return 0===t.length?"null":1===t.length?t[0]:"null"}}function Edit(e){const t=getPolygon(e);if(isRealValue(t)){e.setActiveObject(t),t.edit=!t.edit;const n=getAColorThatShowsUp(t.stroke);if(t.edit){const e=t.points.length-1;t.cornerStyle="circle",t.cornerColor=n,t.controls=t.points.reduce(function(t,n,o){return t["p"+o]=new fabric.Control({positionHandler:polygonPositionHandler,actionHandler:anchorWrapper(o>0?o-1:e,actionHandler),actionName:"modifyPolygon",pointIndex:o}),t},{})}else t.cornerColor=n,t.cornerStyle="rect",t.controls=fabric.Object.prototype.controls;t.hasBorders=!t.edit,e.requestRenderAll()}else alertMessage("Please select a polygon for editing.")}const drawPolygon=function(e,t,n,o){const r=o.fabricCanvas(),i=r.freeDrawingBrush=new fabric.PencilBrush(r);i.decimate=20,i.color=t.innerHTML,r.on("mouse:over",function(e){fillPolygon(e,r)}),r.on("mouse:out",function(e){unfillPolygon(e,r)}),r.on("mouse:up",function(){turnDrawingOff(r,n)}),r.on("path:created",function(t){pathCreatedHandler(t,e,r,i,n)}),e.addEventListener("click",function(){toggleButton(this,"btnOn","btn"),r.isDrawingMode?turnDrawingOff(r,n):turnDrawingOn(r,n,i,t)})};function turnDrawingOff(e,t){e.isDrawingMode=!1,e.off("mouse:down",function(){setGestureSettings(e,t)}),t.setMouseNavEnabled(!0),t.outerTracker.setTracking(!0)}function turnDrawingOn(e,t,n,o){e.isDrawingMode=!0,e.on("mouse:down",function(){setGestureSettings(e,t)}),n.color=o.innerHTML,n.width=10/t.viewport.getZoom(!0),t.setMouseNavEnabled(!1),t.outerTracker.setTracking(!1)}function pathCreatedHandler(e,t,n,o,r){convertPathToPolygon(e.path,n,o),customizePolygonControls(e.path,n,r),clearClassList(t),t.classList.add("btn"),n.off("path:created",function(){pathCreatedHandler(e,t,n,o,r)})}function setGestureSettings(e,t){e.getActiveObject()?t.gestureSettingsMouse.clickToZoom=!1:($(".deleteBtn").remove(),t.gestureSettingsMouse.clickToZoom=!0)}function customizePolygonControls(e,t,n){e.hasControls=!1,e.lockMovementX=!0,e.lockMovementY=!0,setupDeleteButton(t,n)}function setupDeleteButton(e,t){function n(e,t){jQuery(".deleteBtn").remove();const n=`<img src="images/delete-icon.png" class="deleteBtn" style="position:absolute;top:${t-10}px;left:${e-10}px;cursor:pointer;width:20px;height:20px;"/>`;jQuery(".canvas-container").append(n)}e.on("selection:created",function(e){n(e.target.oCoords.tr.x,e.target.oCoords.tr.y)}),e.on("object:modified",function(e){isRealValue(e.target.oCoords.tr)&&n(e.target.oCoords.tr.x,e.target.oCoords.tr.y)}),e.on("object:scaling",function(e){jQuery(".deleteBtn").remove()}),e.on("object:moving",function(e){jQuery(".deleteBtn").remove()}),e.on("object:rotating",function(e){jQuery(".deleteBtn").remove()}),jQuery(".canvas-container").on("click",".deleteBtn",function(){t.gestureSettingsMouse.clickToZoom=!1,e.getActiveObject()&&(e.remove(e.getActiveObject()),jQuery(".deleteBtn").remove()),t.gestureSettingsMouse.clickToZoom=!0})}function convertPathToPolygon(e,t,n){const o=e.path.map(e=>({x:e[1],y:e[2]})),r=getAColorThatShowsUp(e.stroke),i=new fabric.Polygon(o,{left:e.left,top:e.top,fill:"",strokeWidth:n.width,stroke:n.color,scaleX:e.scaleX,scaleY:e.scaleY,objectCaching:!1,transparentCorners:!1,cornerColor:r});t.add(i),t.setActiveObject(i),t.remove(e)}function fillPolygon(e,t){if(weHoveredOverPolygon(e)){const n=e.target;n.set({fill:n.stroke,opacity:.5}),t.renderAll()}}function unfillPolygon(e,t){if(weHoveredOverPolygon(e)){const n=e.target;null!==n&&(n.set({fill:""}),t.renderAll())}}function weHoveredOverPolygon(e){return isRealValue(e.target)&&"polygon"===e.target.type}const gridOverlay=function(e,t,n){const o={canvas:n.fabricCanvas(),canvasWidth:Math.ceil(n.fabricCanvas().width),canvasHeight:Math.ceil(n.fabricCanvas().height),cellWidth:25,cellHeight:25,color:"#C0C0C0",cellX:[],cellY:[],gridAdded:!1};e.addEventListener("click",function(){gridHandler(this,o)}),t.addEventListener("click",function(){markerHandler(this,o)})};function gridHandler(e,t){toggleButton(e,"btnOn","btn");const n=e.classList.contains("btnOn");n&&(turnGridOn(t),t.gridAdded=!0,e.innerHTML='<i class="fas fa-border-all"></i> Remove grid'),n||(turnGridOff(t),t.gridAdded=!1,e.innerHTML='<i class="fas fa-border-all"></i> Draw grid')}function turnGridOff(e){const t=e.canvas.getObjects("line");let n;for(n=0;n<t.length;n++)e.canvas.remove(t[n])}function turnGridOn(e){const t={stroke:e.color,strokeWidth:2,selectable:!1};createHorizontalLines(e,t),createVerticalLines(e,t),e.canvas.renderAll(),e.gridAdded=!0}function createHorizontalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasHeight/e.cellHeight);++n)e.canvas.add(new fabric.Line([0,n*e.cellHeight,e.canvasWidth,n*e.cellHeight],t)),e.cellY[n+1]=n*e.cellHeight}function createVerticalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasWidth/e.cellWidth);++n)e.canvas.add(new fabric.Line([n*e.cellWidth,0,n*e.cellWidth,e.canvasHeight],t)),e.cellX[n+1]=n*e.cellWidth}function fillInGrid(e,t){const n=getCellPosition(getMousePosition(e,t)),o=new fabric.Rect({left:t.cellX[n.x],top:t.cellY[n.y],fill:"red",width:t.cellWidth,height:t.cellHeight,opacity:.5,selectable:!1});t.canvas.add(o)}function getMousePosition(e,t){const n=t.canvas.getPointer(e.e);return{x:n.x/t.cellWidth,y:n.y/t.cellHeight}}function getCellPosition(e){return{x:Math.ceil(e.x+.001),y:Math.ceil(e.y+.001)}}function markerHandler(e,t){toggleButton(e,"btnOn","btn");const n=e.classList.contains("btnOn");n||(t.canvas.__eventListeners["mouse:move"]=[],e.innerHTML='<i class="fas fa-paint-brush"></i> Mark grid'),n&&(t.gridAdded?(t.canvas.on("mouse:move",function(e){fillInGrid(e,t)}),e.innerHTML='<i class="fas fa-paint-brush"></i> Done marking'):(toggleButton(e,"btnOn","btn"),alertMessage("Please draw a grid first.")))}const mapMarker=function(e,t){overrideRightClickMenu(e.element),handleMarkerDisplay(e,t),handleButtonShowHide()};function overrideRightClickMenu(e){e.addEventListener("contextmenu",function(e){e.preventDefault()})}function handleMarkerDisplay(e,t){e.addHandler("canvas-nonprimary-press",function(n){if(isRightClick(n)){const o=n.position,r=e.viewport.pointFromPixel(o);document.querySelectorAll("#btnMapMarker").forEach(function(e){e.style.display="block"}),displayMapMarker(r,e,t)}})}function isRightClick(e){return 2===e.button}function displayMapMarker(e,t,n){n.forEach(function(n){const o=n.getViewer();o.id!==t.id&&addMarkerToViewer(e,o)})}function addMarkerToViewer(e,t){const n=createLink();t.addOverlay({element:n,location:e,placement:"BOTTOM",checkResize:!1})}function createLink(){const e=document.createElement("a");return e.href="#",e.dataset.href="#",e.id="the-map-marker",e.className="fas fa-map-marker",e.style.cssText=" text-decoration: none; font-size: 22px; color: red; cursor: pointer",e}function handleButtonShowHide(){document.querySelectorAll("#btnMapMarker").forEach(function(e){let t,n,o=!1;e.addEventListener("click",function(){o?(t="block",n='<i class="fas fa-map-marker"></i> Hide markers'):(t="none",n='<i class="fas fa-map-marker"></i> Show markers'),this.innerHTML=n,document.querySelectorAll("#the-map-marker").forEach(function(e){e.style.display=t}),o=!o})})}const ruler=function(e,t,n){let o,r,i,a,s=[],l=[],c=[],d=[],u=n.fabricCanvas({hoverCursor:"pointer",selection:!1});fabric.Object.prototype.transparentCorners=!1,e.addEventListener("click",function(){toggleButton(e,"btnOn","btn"),e.classList.contains("btnOn")?(i="draw",e.innerHTML='<i class="fas fa-ruler"></i> Ruler off'):(i="",e.innerHTML='<i class="fas fa-ruler"></i> Ruler on'),u.on("mouse:down",function(e){if("draw"===i){t.setMouseNavEnabled(!1),t.outerTracker.setTracking(!1),r=!0;let n=u.getPointer(e.e),i=[n.x,n.y,n.x,n.y];s[0]=n.x,c[0]=n.y,o=new fabric.Line(i,{strokeWidth:2,stroke:"#0f0",originX:"center",originY:"center"}),u.add(o)}else t.setMouseNavEnabled(!0),t.outerTracker.setTracking(!0),u.forEachObject(function(e){e.setCoords()})}),u.on("mouse:move",function(e){if(u.remove(a),u.renderAll(),!r)return;let t=u.getPointer(e.e);if(o.set({x2:t.x,y2:t.y}),l[0]=t.x,d[0]=t.y,"draw"===i){let e=f.lineLength(s[0],c[0],l[0],d[0]).toFixed(2);a=new fabric.Text("Length "+e,{left:l[0],top:d[0],fontSize:14,fill:"#0f0"}),u.add(a)}u.renderAll()}),u.on("mouse:up",function(e){let t=u.getPointer(e.e);r=!1,u.add(new fabric.Rect({left:t.x+1,top:t.y+1,width:150,height:25,fill:"rgba(255,255,255,0.5)",transparentCorners:!0})),void 0!==a&&u.add(new fabric.Text(a.text,{fontSize:20,left:t.x+1,top:t.y+1})),u.renderAll()})});let f={lineLength:function(e,t,n,o){return Math.sqrt(Math.pow(1*n-1*e,2)+Math.pow(1*o-1*t,2))}}},markupTools=function(e,t){const n=t.fabricjsOverlay({scale:1e3});drawPolygon(document.getElementById("btnDraw"+e),document.getElementById("mark"+e),t,n),editPolygon(document.getElementById("btnEdit"+e),n),gridOverlay(document.getElementById("btnGrid"+e),document.getElementById("btnGridMarker"+e),n),ruler(document.getElementById("btnRuler"+e),t,n)};function createDraggableDiv(e,t,n,o,r){let i=document.createElement("div");i.id=e,i.className="popup",i.style.left=n+"px",i.style.top=o+"px";let a=document.createElement("img");a.src="images/close_icon.png",a.width=25,a.height=25,a.alt="close",a.style.cursor="pointer",a.addEventListener("click",function(){i.style.display="none"});let s=document.createElement("div");s.id=e+"Header",s.className="popupHeader",s.innerHTML=t,s.appendChild(a),i.appendChild(s);let l=document.createElement("div");return l.id=e+"Body",i.appendChild(l),document.body.appendChild(i),r||(i.style.display="none"),dragElement(i),i}function dragElement(e){let t=0,n=0,o=0,r=0;function i(e){(e=e||window.event).preventDefault(),o=e.clientX,r=e.clientY,document.onmouseup=s,document.onmousemove=a}function a(i){(i=i||window.event).preventDefault(),t=o-i.clientX,n=r-i.clientY,o=i.clientX,r=i.clientY,e.style.top=e.offsetTop-n+"px",e.style.left=e.offsetLeft-t+"px"}function s(){document.onmouseup=null,document.onmousemove=null}document.getElementById(e.id+"Header")?document.getElementById(e.id+"Header").onmousedown=i:e.onmousedown=i}let filters=function(e,t,n){let o;if(isRealValue(n)){let r=makeId(5,"filters"),i=n.getBoundingClientRect();o=createDraggableDiv(r,"Color Levels",i.left,i.top),createWidget(document.getElementById(`${r}Body`),e,t)}else console.log("tba");return o},createWidget=function(e,t,n){const o=document.createElement("table");e.appendChild(o);const r=makeId(5);n.forEach(function(e,i){let a=o.insertRow(-1);o.appendChild(a);let s=a.insertCell(-1),l=e.color,c=document.createElement("mark");c.id=makeId(5,"marker"),c.innerHTML="#"+rgba2hex(l),c.style.backgroundColor=l,s.appendChild(c),new CP(c).on("change",function(e,o,r,a){this.source.value=this.color(e,o,r,a),this.source.style.backgroundColor=this.color(e,o,r,a),n[i].color=`rgba(${e}, ${o}, ${r}, ${255*a})`,setViewerFilter(n,t)}),(s=a.insertCell(-1)).appendChild(createNumericInput({prefix:"low",uniq:r,suffix:i,val:n[i].low,index:i},t,n)),(s=a.insertCell(-1)).appendChild(createNumericInput({prefix:"hi",uniq:r,suffix:i,val:n[i].hi,index:i},t,n))})};function rgba2hex(e){let t,n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),o=(n&&n[4]||"").trim(),r=n?(256|n[1]).toString(16).slice(1)+(256|n[2]).toString(16).slice(1)+(256|n[3]).toString(16).slice(1):e;return r+=t=(256|(t=""!==o?o:0)).toString(16).slice(1)}function createNumericInput(e,t,n){let o=document.createElement("input");return o.id=e.prefix+e.uniq+e.suffix,o.setAttribute("type","number"),o.min="0",o.max="255",o.step="1",o.value=e.val.toString(),o.size=5,o.addEventListener("change",function(){isIntersect(e.uniq,n,n.length)}),o.addEventListener("input",function(){let o=parseInt(this.value);o>255&&(this.value="255"),o<0&&(this.value="0"),this.id.startsWith("low")?n[e.index].low=parseInt(this.value):(n[e.index].hi=parseInt(this.value),setViewerFilter(n,t))}),o}function isIntersect(e,t,n){for(let t=0;t<n;t++)clearError(document.getElementById("low"+e+t),document.getElementById("hi"+e+t));for(let o=1;o<n;o++){if(parseInt(t[o-1].hi)<parseInt(t[o].low))return setError(document.getElementById("low"+e+o),document.getElementById("hi"+e+(o-1))),!0;if(parseInt(t[o-1].low)<parseInt(t[o].hi))return setError(document.getElementById("low"+e+(o-1)),document.getElementById("hi"+e+o)),!0}return!1}function setError(e,t){e.style.outlineStyle="solid",e.style.outlineColor="red",t.style.outlineStyle="solid",t.style.outlineColor="red"}function clearError(e,t){e.style.outlineStyle="",e.style.outlineColor="",t.style.outlineStyle="",t.style.outlineColor=""}function setViewerFilter(e,t){try{let n,o=t.world.getItemCount(),r=[];for(n=0;n<o;n++)n>0&&r.push({items:t.world.getItemAt(n),processors:[colorFilter.prototype.COLORLEVELS(e)]});t.setFilterOptions({filters:r,loadMode:"sync"})}catch(n){console.error(`setViewerFilter ${n.message}`),console.error("cr:",e,"viewer:",t)}}let colorFilter=OpenSeadragon.Filters.GREYSCALE;colorFilter.prototype.COLORLEVELS=(e=>(t,n)=>{if(t.canvas.width>0&&t.canvas.height>0){let r=t.getImageData(0,0,t.canvas.width,t.canvas.height);if(void 0!==typeof r){try{const t=r.data;let n;for(n=0;n<t.length;n+=4)if(255===t[n+3]){let r=o(t[n],e);void 0===r&&console.warn("rgba undefined",t[n]),t[n]=r[0],t[n+1]=r[1],t[n+2]=r[2],t[n+3]=r[3]}else t[n+3]=0}catch(e){console.warn("1:",e.message)}function o(e,t){try{let n,o;for(n=0;n<t.length;n++){let r=t[n].low,i=t[n].hi,a=t[n].color;e>=r&&e<=i&&(o=a.replace(/[a-z%\s\(\)]/g,"").split(","))}return void 0===o?e:o}catch(e){console.warn("2:",e.message)}}try{t.putImageData(r,0,0),n()}catch(e){console.warn("3:",e.message)}}else console.warn("imgData undefined")}else colorFilter=null,console.warn("Canvas width and height are 0. Setting filter to null")});class ImageViewer{constructor(e,t,n,o,r){this.viewer={};let i=OpenSeadragon({id:t,prefixUrl:"vendor/openseadragon/images/",crossOriginPolicy:"Anonymous",immediateRender:!0,animationTime:0,imageLoaderLimit:1,showNavigator:!0,navigatorPosition:"BOTTOM_RIGHT"});if(n.includes("info.json")){let e=function(e){i.scalebar({type:OpenSeadragon.ScalebarType.MICROSCOPY,pixelsPerMeter:e,location:OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,xOffset:5,yOffset:10,stayInsideImage:!0,color:"rgb(150, 150, 150)",fontColor:"rgb(100, 100, 100)",backgroundColor:"rgba(255, 255, 255, 0.5)",barThickness:2})};(async function(){return(await fetch(n)).json()})().then(function(t){3===t.resolutionUnit?e(100*t.xResolution):console.warn("Handle resolution unit",t.resolutionUnit)})}i.addOnceHandler("tile-loaded",function(){let e="vendor/openseadragon/images/",t=new OpenSeadragon.Button({tooltip:"Zoom to 100%",srcRest:e+"zin_rest.png",srcGroup:e+"zin_grouphover.png",srcHover:e+"zin_hover.png",srcDown:e+"zin_pressed.png",onClick:function(){i.viewport.zoomTo(i.viewport.imageToViewportZoom(1))}}),n=new OpenSeadragon.Button({tooltip:"perspective",srcRest:e+"zout_rest.png",srcGroup:e+"zout_grouphover.png",srcHover:e+"zout_hover.png",srcDown:e+"zout_pressed.png",onClick:function(){i.viewport.goHome(!0)}});i.addControl(t.element,{anchor:OpenSeadragon.ControlAnchor.TOP_LEFT}),i.addControl(n.element,{anchor:OpenSeadragon.ControlAnchor.TOP_LEFT})}),i.addTiledImage({tileSource:n,opacity:1,x:0,y:0});const a=o.features,s=o.opacities;a&&a.forEach(function(e,t){i.addTiledImage({tileSource:e,opacity:s[t],x:0,y:0})}),i.world.addHandler("add-item",function(e){const t=i.world.getIndexOfItem(e.item);t>0&&(setViewerFilter(r.colorRanges,i),i.world.getItemAt(t).source.getTileUrl=function(e,t,n){return function(e,t,n,o){const r=Math.pow(.5,e.maxLevel-t),i=Math.ceil(e.width*r),a=Math.ceil(e.height*r),s=e.getTileWidth(t);let l;const c=l=Math.ceil(s/r);let d,u,f,g,h,p;i<s&&a<s?(p=i+",",d="full"):(u=n*l,f=o*c,g=Math.min(l,e.width-u),h=Math.min(c,e.height-f),p=Math.ceil(g*r)+",",d=[u,f,g,h].join(","));return[e["@id"],d,p,"0","default.png"].join("/")}(this,e,t,n)})}),this.viewer=i}getViewer(){return this.viewer}}let layers=function(e,t,n,o){let r;if(isRealValue(o)){let e=makeId(5,"layers"),i=o.getBoundingClientRect();r=createDraggableDiv(e,"Features",i.left,i.top),createLayerWidget(document.getElementById(`${e}Body`),t,n),handleDragLayers(t)}else createLayerWidget(document.getElementById(e),t,n),handleDragLayers(t);return r},eyeball=function(e,t,n){let o=n.world.getItemAt(t);o&&(e.classList.contains("fa-eye")?o.setOpacity(1):o.setOpacity(0))},createLayerWidget=function(e,t,n){const o=document.createElement("table");e.appendChild(o);let r=n.features,i=n.opacities;r.forEach(function(e,n){let r,a,s,l,c,d=n+1;r=o.insertRow(-1),o.appendChild(r),a=r.insertCell(-1),(s=document.createElement("span")).className="layer_tab",s.id=n+makeId(5,"feat"),s.setAttribute("draggable","true"),s.display="block",s.innerHTML=getStringRep(e),a.appendChild(s),a=r.insertCell(-1),(l=document.createElement("i")).classList.add("fas"),1===i[n]?l.classList.add("fa-eye"):l.classList.add("fa-eye-slash"),l.id=makeId(5,"eye"),a.appendChild(l),l.addEventListener("click",function(){toggleButton(l,"fa-eye","fa-eye-slash"),eyeball(l,d,t)}),a=r.insertCell(-1);let u=document.createElement("div");u.className="showDiv";let f=document.createElement("div");f.className="showHover",(c=document.createElement("i")).classList.add("fas"),c.classList.add("fa-adjust"),c.classList.add("hover-orange"),c.style.cursor="pointer",u.appendChild(c);let g=document.createElement("input");g.type="range",g.id=makeId(5,"range"),g.min="0",g.max="100",g.step="0.1",g.value=100*i[n],g.addEventListener("input",function(){const e=t.world.getItemAt(d);void 0!==e?e.setOpacity(this.value/100):console.warn("worldItem",e)}),f.appendChild(g),u.appendChild(f),a.appendChild(u),a=r.insertCell(-1),(c=document.createElement("i")).classList.add("fas"),c.classList.add("fa-palette"),c.id=makeId(5,"palette"),c.style.cursor="pointer",a.appendChild(c);let h=filters(t,colorRanges,c);c.addEventListener("click",function(e){h.style.display="block"})})},handleDragLayers=function(e){let t=document.querySelectorAll(".layer_tab");function n(e){return e.preventDefault&&e.preventDefault(),!1}function o(e){this.classList.add("over")}function r(e){this.classList.remove("over")}function i(t){this.style.opacity="0.4",dragSrcEl=this,sourceViewer=e,t.dataTransfer.effectAllowed="move",console.log("e.target.id",t.target.id),t.dataTransfer.setData("text",t.target.id)}function a(e){this.style.opacity="1",t.forEach(function(e){e.classList.remove("over")})}function s(e){if(e.preventDefault&&e.preventDefault(),dragSrcEl!==this){const t=e.target.closest(".viewer");if(!t)return!1;let n=e.dataTransfer.getData("text"),o=document.getElementById(n),r=o.id,i=o.innerHTML,a=document.querySelectorAll(".layer_tab");for(let e=0;e<a.length;e++){let t=a[e];if(t.innerHTML===i&&t.id!==r){let e=t.parentElement.parentElement.children[1].children[0];e.classList.remove("fa-eye-slash"),e.classList.add("fa-eye"),t.classList.remove("highlight"),t.classList.add("highlight");break}}let s=getViewerObject(t),l=n[0];console.log("layerNum",l),l=parseInt(l)+1,s.world.getItemAt(l).setOpacity(1)}return!1}t.forEach(function(e){e.setAttribute("draggable","true"),e.addEventListener("dragstart",i,!1),e.addEventListener("dragend",a,!1)}),(t=document.querySelectorAll(".drop_site")).forEach(function(e){e.addEventListener("dragenter",o,!1),e.addEventListener("dragleave",r,!1),e.addEventListener("dragover",n,!1),e.addEventListener("drop",s,!1)})};function getViewerObject(e){let t;try{let n;for(n=0;n<syncedImageViewers.length;n++)if(syncedImageViewers[n].getViewer().id===e.id){t=syncedImageViewers[n].getViewer();break}}catch(e){console.error("getViewerObject:",e.message)}return t}class MultiViewer extends ImageViewer{constructor(e,t,n,o,r,i){super(e,t,n,o,i),void 0===i&&(i={}),this.checkboxes={checkPan:!0,checkZoom:!0},this.viewer1=super.getViewer(),this.idx=e,r>1&&(this.checkboxes.checkPan=document.getElementById("chkPan"+this.idx),this.checkboxes.checkZoom=document.getElementById("chkZoom"+this.idx)),i.toolbarOn&&markupTools(this.idx,this.viewer1),void 0!==o.features?layers(`layers_and_colors${this.idx}`,this.viewer1,o):(console.error("data.features is undefined or null\nHINT: Keys should be in quotes!"),console.log("****** HERE'S 'DATA':",o," ******")),i.draggableLayers||console.error("There's your trouble: options.draggableLayers = ",i.draggableLayers)}getViewer(){return this.viewer1}getPanZoom(){return this.checkboxes}}const synchronizeViewers=function(e){checkData(e)&&(this.syncedImageViewers=[],this.activeViewerId=null,this.numViewers=e.length,e.forEach(function(e){const t=e.getViewer();var n,o;setPanZoomCurrent(t,function(){if(!isActive(t.id))return;setPanZoomOthers(e),resetFlag()}),n=t,o=this.syncedImageViewers,overrideRightClickMenu(n.element),handleMarkerDisplay(n,o),handleButtonShowHide(),this.syncedImageViewers.push(e)}))};function setPanZoomCurrent(e,t){e.addHandler("pan",t),e.addHandler("zoom",t)}function isActive(e){return init(e),e===this.activeViewerId}function init(e){isRealValue(this.activeViewerId)||(this.activeViewerId=e)}function isPanOn(e){const t=e.getPanZoom();return void 0!==t.checkPan.checked?t.checkPan.checked:1!==this.numViewers}function isZoomOn(e){const t=e.getPanZoom();return void 0!==t.checkZoom.checked?t.checkZoom.checked:1!==this.numViewers}function setPanZoomOthers(e){const t=e.getViewer();this.syncedImageViewers.forEach(function(n){const o=n.getViewer();o.id!==t.id&&(isPanOn(n)&&isPanOn(e)&&o.viewport.panTo(t.viewport.getCenter(!1),!1),isZoomOn(n)&&isZoomOn(e)&&o.viewport.zoomTo(t.viewport.getZoom(!1)))})}function resetFlag(){this.activeViewerId=null}function checkData(e){return isEmpty(e)?(console.error("synchronizeViewers.js: Expected input argument, but received none."),!1):e[0]instanceof Object||(console.error("synchronizeViewers.js: Array elements should be MultiViewer objects."),!1)}