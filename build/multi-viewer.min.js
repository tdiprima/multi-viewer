/*! multi-viewer - v2.4.8 - 2021-05-27 */
function clearClassList(e){const t=e.classList;for(;t.length>0;)t.remove(t.item(0))}function toggleButton(e,t,n){e.classList.contains(t)?(e.classList.remove(t),e.classList.add(n)):(e.classList.remove(n),e.classList.add(t))}function isRealValue(e){return e&&"null"!==e&&"undefined"!==e}const isEmpty=function(e){const t=function(e){if(void 0===e.length){return!Object.keys(e).some(function(t){return!isEmpty(e[t])})&&t(Object.keys(e))}return!e.some(function(e){return!isEmpty(e)})};return!1===e||void 0===e||null===e||"object"==typeof e&&t(e)};function getAColorThatShowsUp(e){return e.endsWith("ff")&&"#00ffff"!==e&&"#ff00ff"!==e?"rgba(255, 255, 0, 0.5)":"rgba(0, 0, 255, 0.5)"}function alertMessage(e){return alert(e),!0}function calculateAspectRatioFit(e,t,n,i){const o=Math.min(n/e,i/t);return{width:Math.round(e*o),height:Math.round(t*o)}}function makeId(e,t){let n="";const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=i.length;let r;for(r=0;r<e;r++)n+=i.charAt(Math.floor(Math.random()*o));return t&&(n=t+n),n}function getStringRep(e){let t=e.hashCode();return t<0&&(t*=-1),t.toString(16).toUpperCase()}async function fetchAsync(e){const t=await fetch(e);return await t.json()}String.prototype.hashCode=function(){let e,t,n=0;if(0===this.length)return n;for(e=0;e<this.length;e++)n=(n<<5)-n+(t=this.charCodeAt(e)),n&=n;return n};const pageSetup=function(e,t,n,i,o,r,a,s,l){let c=[],d=0;document.addEventListener("DOMContentLoaded",function(){new Promise(function(e,t){return e(l)}).then(function(l){const u=document.getElementById(e),f=document.createElement("table");let h,g,m;f.id="myTable",u.appendChild(f);const p=o*r;let y=0;for(m=0;m<o;m++){const e=f.insertRow(m);let o;for(o=0;o<r;o++){const r=e.insertCell(o),u=makeId(11);let f=y;y++;let m=document.createElement("div");m.className="divSquare",m.style.width=a+"px",r.appendChild(m);let v="";v+=`<div>\n<i id="layers${f}" style="cursor: pointer;" class="fa fa-layer-group"></i>&nbsp;\n<i id="palette${f}" style="cursor: pointer;" class="fas fa-palette"></i>\n</div>`,i>1&&(v+=`<input type="checkbox" id="chkPan${f}" checked=""><label for="chkPan${f}">Match Pan</label>&nbsp;\n<input type="checkbox" id="chkZoom${f}" checked=""><label for="chkZoom${f}">Match Zoom</label>&nbsp;&nbsp;`),l&&l.toolbarOn&&(v+=`<div class="controls showDiv" id="hideTools${f}"><div id="tools${f}" class="showHover">`,l&&l.slidersOn&&(v+=`<div class="range">\n<input type="range" id="sliderRange${h=d+=1}" min="0" max="100" value="100" class="slider-square" style="display: inline;">\n<input type="range" id="sliderRange${g=d+=1}" min="0" max="100" value="100" class="slider-square" style="display: inline;">\n</div>`),v+='<div class="floated buttons">',l&&l.paintbrushColor?v+=`<mark id="mark${f}">${l.paintbrushColor}</mark>&nbsp;`:v+=`<mark id="mark${f}">#00f</mark>&nbsp;`,v+=`<button id="btnDraw${f}" class="btn"><i class="fas fa-pencil-alt"></i> Draw polygon</button>&nbsp;\n<button id="btnEdit${f}" class="btn"><i class="fas fa-draw-polygon"></i> Edit polygon</button>&nbsp;\n<button id="btnGrid${f}" class="btn"><i class="fas fa-border-all"></i> Draw grid</button>&nbsp;\n<button id="btnGridMarker${f}" class="btn"><i class="fas fa-paint-brush"></i> Mark grid</button>&nbsp;\n<button id="btnRuler${f}" class="btn"><i class="fas fa-ruler"></i> Ruler</button>&nbsp;\n<button id="btnMapMarker" class="btn" style="display: none"><i class="fas fa-map-marker-alt"></i> Hide markers</button></div>`,v+="</div></div>"),v+=`<table><tr><td><div id="${u}" class="viewer drop_site" style="width: ${a}px; height: ${s}px;"></div>\n</td><td style="vertical-align: top;"><span id="layers_and_colors${f}"></span></td>\n</tr></table>`,m.innerHTML=v,new CP(document.getElementById("mark"+f)).on("change",function(e,t,n,i){this.source.value=this.color(e,t,n,i),this.source.style.backgroundColor=this.color(e,t,n,i)});let b=[];try{b.push(document.getElementById("sliderRange"+h)),b.push(document.getElementById("sliderRange"+g))}catch(e){console.error("sliders",e)}let w=n.features,k=n.opacities,C={features:w[f],opacities:k[f]};if(c.push(new MultiViewer(f,u,t,C,b,i,l)),i<p&&y-1===i)break}}return c}).then(function(e){synchronizeViewers(e)})})},editPolygon=function(e,t){document.getElementById("btnEdit"+e).addEventListener("click",function(){toggleButton(this,"btnOn","btn"),Edit(t.fabricCanvas())})};function polygonPositionHandler(e,t,n){const i=n.points[this.pointIndex].x-n.pathOffset.x,o=n.points[this.pointIndex].y-n.pathOffset.y;return fabric.util.transformPoint({x:i,y:o},fabric.util.multiplyTransformMatrices(n.canvas.viewportTransform,n.calcTransformMatrix()))}function actionHandler(e,t,n,i){const o=t.target,r=o.controls[o.__corner],a=o.toLocalPoint(new fabric.Point(n,i),"center","center"),s=o._getNonTransformedDimensions(),l=o._getTransformedDimensions(0,0),c={x:a.x*s.x/l.x+o.pathOffset.x,y:a.y*s.y/l.y+o.pathOffset.y};return o.points[r.pointIndex]=c,!0}function anchorWrapper(e,t){return function(n,i,o,r){const a=i.target,s=fabric.util.transformPoint({x:a.points[e].x-a.pathOffset.x,y:a.points[e].y-a.pathOffset.y},a.calcTransformMatrix()),l=t(n,i,o,r),c=(a._setPositionDimensions({}),a._getNonTransformedDimensions()),d=(a.points[e].x-a.pathOffset.x)/c.x,u=(a.points[e].y-a.pathOffset.y)/c.y;return a.setPositionByOrigin(s,d+.5,u+.5),l}}function getPolygon(e){if(e.getActiveObject())return e.getActiveObject();{const t=e.getObjects("polygon");return 0===t.length?"null":1===t.length?t[0]:"null"}}function Edit(e){const t=getPolygon(e);if(isRealValue(t)){e.setActiveObject(t),t.edit=!t.edit;const n=getAColorThatShowsUp(t.stroke);if(t.edit){const e=t.points.length-1;t.cornerStyle="circle",t.cornerColor=n,t.controls=t.points.reduce(function(t,n,i){return t["p"+i]=new fabric.Control({positionHandler:polygonPositionHandler,actionHandler:anchorWrapper(i>0?i-1:e,actionHandler),actionName:"modifyPolygon",pointIndex:i}),t},{})}else t.cornerColor=n,t.cornerStyle="rect",t.controls=fabric.Object.prototype.controls;t.hasBorders=!t.edit,e.requestRenderAll()}else alertMessage("Please select a polygon for editing.")}const drawPolygon=function(e,t,n){const i=document.getElementById("btnDraw"+e),o=document.getElementById("mark"+e),r=n.fabricCanvas(),a=r.freeDrawingBrush=new fabric.PencilBrush(r);a.decimate=20,a.color=o.innerHTML,r.on("mouse:over",function(e){fillPolygon(e,r)}),r.on("mouse:out",function(e){unfillPolygon(e,r)}),r.on("mouse:up",function(){turnDrawingOff(r,t)}),r.on("path:created",function(e){pathCreatedHandler(e,i,r,a,t)}),i.addEventListener("click",function(){toggleButton(this,"btnOn","btn"),r.isDrawingMode?turnDrawingOff(r,t):turnDrawingOn(r,t,a,o)})};function turnDrawingOff(e,t){e.isDrawingMode=!1,e.off("mouse:down",function(){setGestureSettings(e,t)}),t.setMouseNavEnabled(!0),t.outerTracker.setTracking(!0)}function turnDrawingOn(e,t,n,i){e.isDrawingMode=!0,e.on("mouse:down",function(){setGestureSettings(e,t)}),n.color=i.innerHTML,n.width=10/t.viewport.getZoom(!0),t.setMouseNavEnabled(!1),t.outerTracker.setTracking(!1)}function pathCreatedHandler(e,t,n,i,o){convertPathToPolygon(e.path,n,i),customizePolygonControls(e.path,n,o),clearClassList(t),t.classList.add("btn"),n.off("path:created",function(){pathCreatedHandler(e,t,n,i,o)})}function setGestureSettings(e,t){e.getActiveObject()?t.gestureSettingsMouse.clickToZoom=!1:($(".deleteBtn").remove(),t.gestureSettingsMouse.clickToZoom=!0)}function customizePolygonControls(e,t,n){e.hasControls=!1,e.lockMovementX=!0,e.lockMovementY=!0,setupDeleteButton(t,n)}function setupDeleteButton(e,t){function n(e,t){jQuery(".deleteBtn").remove();const n=`<img src="images/delete-icon.png" class="deleteBtn" style="position:absolute;top:${t-10}px;left:${e-10}px;cursor:pointer;width:20px;height:20px;"/>`;jQuery(".canvas-container").append(n)}e.on("selection:created",function(e){n(e.target.oCoords.tr.x,e.target.oCoords.tr.y)}),e.on("object:modified",function(e){isRealValue(e.target.oCoords.tr)&&n(e.target.oCoords.tr.x,e.target.oCoords.tr.y)}),e.on("object:scaling",function(e){jQuery(".deleteBtn").remove()}),e.on("object:moving",function(e){jQuery(".deleteBtn").remove()}),e.on("object:rotating",function(e){jQuery(".deleteBtn").remove()}),jQuery(".canvas-container").on("click",".deleteBtn",function(){t.gestureSettingsMouse.clickToZoom=!1,e.getActiveObject()&&(e.remove(e.getActiveObject()),jQuery(".deleteBtn").remove()),t.gestureSettingsMouse.clickToZoom=!0})}function convertPathToPolygon(e,t,n){const i=e.path.map(e=>({x:e[1],y:e[2]})),o=getAColorThatShowsUp(e.stroke),r=new fabric.Polygon(i,{left:e.left,top:e.top,fill:"",strokeWidth:n.width,stroke:n.color,scaleX:e.scaleX,scaleY:e.scaleY,objectCaching:!1,transparentCorners:!1,cornerColor:o});t.add(r),t.setActiveObject(r),t.remove(e)}function fillPolygon(e,t){if(weHoveredOverPolygon(e)){const n=e.target;n.set({fill:n.stroke,opacity:.5}),t.renderAll()}}function unfillPolygon(e,t){if(weHoveredOverPolygon(e)){const n=e.target;null!==n&&(n.set({fill:""}),t.renderAll())}}function weHoveredOverPolygon(e){return isRealValue(e.target)&&"polygon"===e.target.type}const mugshots=function(e){const t=this.__canvas=e.overlay.fabricCanvas();e.overlay.resizeCanvas=function(){const e=this._viewer.world.getItemAt(0);this._fabricCanvas.setWidth(this._containerWidth),this._fabricCanvas.setHeight(this._containerHeight),this._fabricCanvas.setZoom(e.viewportToImageZoom(this._viewer.viewport.getZoom(!0)));const t=e.imageToWindowCoordinates(new OpenSeadragon.Point(0,0)),n=this._canvasdiv.getBoundingClientRect(),i=OpenSeadragon.getPageScroll();this._fabricCanvas.absolutePan(new fabric.Point(n.left-Math.round(t.x)+i.x,n.top-Math.round(t.y)+i.y))};const n=e.viewer.viewport,i="256,",o="0",r="default",a="jpg";function s(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function l(l,c,d,u){let f;!function(e){const t=e.getTopLeft();t.x%1!=0&&console.warn(t.x,"not a whole number");t.y%1!=0&&console.warn(t.y,"not a whole number")}(f=function(e,t){return void 0!==e&&void 0!==t&&e>=0&&t>=0}(d,u)?new OpenSeadragon.Rect(d,u,e.thumbnailSize,e.thumbnailSize):function(t){const n=2*e.thumbnailSize,i=s(n,t.width-n),o=s(n,t.height-n);return new OpenSeadragon.Rect(i,o,e.thumbnailSize,e.thumbnailSize)}(l));const h=document.createElement("IMG");h.alt="mugshot",h.classList.add("thumbnail-image"),h.src=function(e,t){return e+"/"+t.getTopLeft().x+","+t.getTopLeft().y+","+t.width+","+t.height+"/"+i+"/"+o+"/"+r+"."+a}(e.infoUrl,f),c.appendChild(h),h.addEventListener("click",function(){!function(i){(function(e){const t=n.imageToViewportRectangle(e);n.panTo(t.getCenter()),n.zoomTo(n.getMaxZoom())})(i),function(n){t.add(new fabric.Rect({stroke:e.roiColor,strokeWidth:2,fill:"",left:n.x,top:n.y,width:n.width,height:n.height})),t.renderAll()}(i)}(f)})}!function(t){let n,i,o;const r=document.createDocumentFragment();let a;for((n=document.createElement("ul")).classList.add("thumbnail-list"),r.appendChild(n),a=0;a<e.scrollerLength;a++)i=document.createElement("li"),n.appendChild(i),o=document.createElement("span"),l(t,o),i.appendChild(o);document.getElementById(e.thumbId).appendChild(r)}(e.imgDims)},gridOverlay=function(e,t){const n={canvas:t.fabricCanvas(),canvasWidth:Math.ceil(t.fabricCanvas().width),canvasHeight:Math.ceil(t.fabricCanvas().height),cellWidth:25,cellHeight:25,color:"#C0C0C0",cellX:[],cellY:[],gridAdded:!1};document.getElementById("btnGrid"+e).addEventListener("click",function(){gridHandler(this,n)}),document.getElementById("btnGridMarker"+e).addEventListener("click",function(){markerHandler(this,n)})};function gridHandler(e,t){toggleButton(e,"btnOn","btn");const n=e.classList.contains("btnOn");n&&(turnGridOn(t),t.gridAdded=!0,e.innerHTML='<i class="fas fa-border-all"></i> Remove grid'),n||(turnGridOff(t),t.gridAdded=!1,e.innerHTML='<i class="fas fa-border-all"></i> Draw grid')}function turnGridOff(e){const t=e.canvas.getObjects("line");let n;for(n=0;n<t.length;n++)e.canvas.remove(t[n])}function turnGridOn(e){const t={stroke:e.color,strokeWidth:2,selectable:!1};createHorizontalLines(e,t),createVerticalLines(e,t),e.canvas.renderAll(),e.gridAdded=!0}function createHorizontalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasHeight/e.cellHeight);++n)e.canvas.add(new fabric.Line([0,n*e.cellHeight,e.canvasWidth,n*e.cellHeight],t)),e.cellY[n+1]=n*e.cellHeight}function createVerticalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasWidth/e.cellWidth);++n)e.canvas.add(new fabric.Line([n*e.cellWidth,0,n*e.cellWidth,e.canvasHeight],t)),e.cellX[n+1]=n*e.cellWidth}function fillInGrid(e,t){const n=getCellPosition(getMousePosition(e,t)),i=new fabric.Rect({left:t.cellX[n.x],top:t.cellY[n.y],fill:"red",width:t.cellWidth,height:t.cellHeight,opacity:.5,selectable:!1});t.canvas.add(i)}function getMousePosition(e,t){const n=t.canvas.getPointer(e.e);return{x:n.x/t.cellWidth,y:n.y/t.cellHeight}}function getCellPosition(e){return{x:Math.ceil(e.x+.001),y:Math.ceil(e.y+.001)}}function markerHandler(e,t){toggleButton(e,"btnOn","btn");const n=e.classList.contains("btnOn");n||(t.canvas.__eventListeners["mouse:move"]=[],e.innerHTML='<i class="fas fa-paint-brush"></i> Mark grid'),n&&(t.gridAdded?(t.canvas.on("mouse:move",function(e){fillInGrid(e,t)}),e.innerHTML='<i class="fas fa-paint-brush"></i> Done marking'):(toggleButton(e,"btnOn","btn"),alertMessage("Please draw a grid first.")))}const mapMarker=function(e,t){overrideRightClickMenu(e.element),handleMarkerDisplay(e,t),handleButtonShowHide()};function overrideRightClickMenu(e){e.addEventListener("contextmenu",function(e){e.preventDefault()})}function handleMarkerDisplay(e,t){e.addHandler("canvas-nonprimary-press",function(n){if(isRightClick(n)){const i=n.position,o=e.viewport.pointFromPixel(i);document.querySelectorAll("#btnMapMarker").forEach(function(e){e.style.display="block"}),displayMapMarker(o,e,t)}})}function isRightClick(e){return 2===e.button}function displayMapMarker(e,t,n){n.forEach(function(n){const i=n.getViewer();i.id!==t.id&&addMarkerToViewer(e,i)})}function addMarkerToViewer(e,t){const n=createLink();t.addOverlay({element:n,location:e,placement:"BOTTOM",checkResize:!1})}function createLink(){const e=document.createElement("a");return e.href="#",e.dataset.href="#",e.id="the-map-marker",e.className="fas fa-map-marker",e.style.cssText=" text-decoration: none; font-size: 22px; color: red; cursor: pointer",e}function handleButtonShowHide(){document.querySelectorAll("#btnMapMarker").forEach(function(e){let t,n,i=!1;e.addEventListener("click",function(){i?(t="block",n='<i class="fas fa-map-marker"></i> Hide markers'):(t="none",n='<i class="fas fa-map-marker"></i> Show markers'),this.innerHTML=n,document.querySelectorAll("#the-map-marker").forEach(function(e){e.style.display=t}),i=!i})})}const ruler=function(e,t,n){let i,o,r,a,s=[],l=[],c=[],d=[],u=n.fabricCanvas({hoverCursor:"pointer",selection:!1});fabric.Object.prototype.transparentCorners=!1;const f=document.getElementById("btnRuler"+e);f.addEventListener("click",function(){toggleButton(f,"btnOn","btn"),f.classList.contains("btnOn")?(r="draw",f.innerHTML='<i class="fas fa-ruler"></i> Ruler off'):(r="",f.innerHTML='<i class="fas fa-ruler"></i> Ruler on')}),u.on("mouse:down",function(e){if("draw"===r){t.setMouseNavEnabled(!1),t.outerTracker.setTracking(!1),o=!0;let n=u.getPointer(e.e),r=[n.x,n.y,n.x,n.y];s[0]=n.x,c[0]=n.y,i=new fabric.Line(r,{strokeWidth:2,stroke:"#0f0",originX:"center",originY:"center"}),u.add(i)}else t.setMouseNavEnabled(!0),t.outerTracker.setTracking(!0),u.forEachObject(function(e){e.setCoords()})}),u.on("mouse:move",function(e){if(u.remove(a),u.renderAll(),!o)return;let t=u.getPointer(e.e);if(i.set({x2:t.x,y2:t.y}),l[0]=t.x,d[0]=t.y,"draw"===r){let e=h.lineLength(s[0],c[0],l[0],d[0]).toFixed(2);a=new fabric.Text("Length "+e,{left:l[0],top:d[0],fontSize:14,fill:"#0f0"}),u.add(a)}u.renderAll()}),u.on("mouse:up",function(e){let t=u.getPointer(e.e);o=!1,u.add(new fabric.Rect({left:t.x+1,top:t.y+1,width:150,height:25,fill:"rgba(255,255,255,0.5)",transparentCorners:!0})),u.add(new fabric.Text(a.text,{fontSize:20,left:t.x+1,top:t.y+1})),u.renderAll()});let h={lineLength:function(e,t,n,i){return Math.sqrt(Math.pow(1*n-1*e,2)+Math.pow(1*i-1*t,2))}}},markupTools=function(e,t){const n=t.fabricjsOverlay({scale:1e3});drawPolygon(e,t,n),editPolygon(e,n),gridOverlay(e,n),ruler(e,t,n)};function createDraggableDiv(e,t,n,i,o){let r=document.createElement("div");r.id=e,r.className="popup",r.style.left=n+"px",r.style.top=i+"px";let a=document.createElement("img");a.src="images/close_icon.png",a.width=25,a.height=25,a.alt="close",a.style.cursor="pointer",a.addEventListener("click",function(){r.style.display="none"});let s=document.createElement("div");s.id=e+"Header",s.className="popupHeader",s.innerHTML=t,s.appendChild(a),r.appendChild(s);let l=document.createElement("div");return l.id=e+"Body",r.appendChild(l),document.body.appendChild(r),o||(r.style.display="none"),dragElement(r),r}function dragElement(e){let t=0,n=0,i=0,o=0;function r(e){(e=e||window.event).preventDefault(),i=e.clientX,o=e.clientY,document.onmouseup=s,document.onmousemove=a}function a(r){(r=r||window.event).preventDefault(),t=i-r.clientX,n=o-r.clientY,i=r.clientX,o=r.clientY,e.style.top=e.offsetTop-n+"px",e.style.left=e.offsetLeft-t+"px"}function s(){document.onmouseup=null,document.onmousemove=null}document.getElementById(e.id+"Header")?document.getElementById(e.id+"Header").onmousedown=r:e.onmousedown=r}let filters=function(e,t,n){let i;if(isRealValue(n)){let o=makeId(5,"filters"),r=n.getBoundingClientRect();i=createDraggableDiv(o,"Color Levels",r.left,r.top),createWidget(document.getElementById(`${o}Body`),e,t)}else console.log("tba");return i},createWidget=function(e,t,n){const i=document.createElement("table");e.appendChild(i),n.forEach(function(e,o){let r=i.insertRow(-1);i.appendChild(r);let a=r.insertCell(-1),s=e.color,l=document.createElement("mark");l.id=makeId(5,"marker"),l.innerHTML="#"+rgba2hex(s),l.style.backgroundColor=s,a.appendChild(l),new CP(l).on("change",function(e,i,r,a){this.source.value=this.color(e,i,r,a),this.source.style.backgroundColor=this.color(e,i,r,a),n[o].color=`rgba(${e}, ${i}, ${r}, ${255*a})`,setViewerFilter(n,t)}),(a=r.insertCell(-1)).appendChild(createNumericInput({id:makeId(5,"low"),val:n[o].low},t,n)),(a=r.insertCell(-1)).appendChild(createNumericInput({id:makeId(5,"hi"),val:n[o].hi},t,n))})};function rgba2hex(e){let t,n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),i=(n&&n[4]||"").trim(),o=n?(256|n[1]).toString(16).slice(1)+(256|n[2]).toString(16).slice(1)+(256|n[3]).toString(16).slice(1):e;return o+=t=(256|(t=""!==i?i:0)).toString(16).slice(1)}function createNumericInput({id:e,val:t},n,i){let o=document.createElement("input");return o.id=e,o.setAttribute("type","number"),o.min="0",o.max="255",o.step="1",o.value=t.toString(),o.size=5,o.addEventListener("input",function(){let e=parseInt(this.value);e>255&&(this.value="255"),e<0&&(this.value="0"),this.id.startsWith("low")?i[index].low=parseInt(this.value):(i[index].hi=parseInt(this.value),setViewerFilter(i,n))}),o}function setViewerFilter(e,t){try{let n,i=t.world.getItemCount(),o=[];for(n=0;n<i;n++)n>0&&o.push({items:t.world.getItemAt(n),processors:[colorFilter.prototype.COLORLEVELS(e)]});t.setFilterOptions({filters:o,loadMode:"sync"})}catch(n){console.error(`setViewerFilter ${n.message}`),console.error("cr:",e,"viewer:",t)}}let colorFilter=OpenSeadragon.Filters.GREYSCALE;colorFilter.prototype.COLORLEVELS=(e=>(t,n)=>{if(t.canvas.width>0&&t.canvas.height>0){let o=t.getImageData(0,0,t.canvas.width,t.canvas.height);if(void 0!==typeof o){try{const t=o.data;let n;for(n=0;n<t.length;n+=4)if(255===t[n+3]){let o=i(t[n],e);void 0===o&&console.warn("rgba undefined",t[n]),t[n]=o[0],t[n+1]=o[1],t[n+2]=o[2],t[n+3]=o[3]}else t[n+3]=0}catch(e){console.warn("1:",e.message)}function i(e,t){try{let n,i;for(n=0;n<t.length;n++){let o=t[n].low,r=t[n].hi,a=t[n].color;e>=o&&e<=r&&(i=a.replace(/[a-z%\s\(\)]/g,"").split(","))}return void 0===i?e:i}catch(e){console.warn("2:",e.message)}}try{t.putImageData(o,0,0),n()}catch(e){console.warn("3:",e.message)}}else console.warn("imgData undefined")}else colorFilter=null,console.warn("Canvas width and height are 0. Setting filter to null")});class ImageViewer{constructor(e,t,n,i,o){this.viewer={},this.options=o,this.setSources(e,n,i,this.setViewer(t),this.options)}setViewer(e){let t;try{t=OpenSeadragon({id:e,prefixUrl:"vendor/openseadragon/images/",crossOriginPolicy:"Anonymous",immediateRender:!0,animationTime:0,imageLoaderLimit:1})}catch(e){console.warn("setViewer",e),t=null}return this.viewer=t,t}getViewer(){return this.viewer}setSources(e,t,n,i,o){jQuery.get(t).done(function(){i.addTiledImage({tileSource:t,opacity:1,x:0,y:0});const e=n.features,r=n.opacities;e&&e.forEach(function(e,t){i.addTiledImage({tileSource:e,opacity:r[t],x:0,y:0})}),function(e,t){try{e.world.addHandler("add-item",function(n){const i=e.world.getIndexOfItem(n.item);i>0&&(setViewerFilter(t,e),e.world.getItemAt(i).source.getTileUrl=function(e,t,n){return function(e,t,n,i){const o=Math.pow(.5,e.maxLevel-t),r=Math.ceil(e.width*o),a=Math.ceil(e.height*o),s=e.getTileWidth(t);let l;const c=l=Math.ceil(s/o);let d,u,f,h,g,m;r<s&&a<s?(m=r+",",d="full"):(u=n*l,f=i*c,h=Math.min(l,e.width-u),g=Math.min(c,e.height-f),m=Math.ceil(h*o)+",",d=[u,f,h,g].join(","));return[e["@id"],d,m,"0","default.png"].join("/")}(this,e,t,n)})})}catch(e){console.error("Here we are",e.message)}}(i,o.colorRanges)}).fail(function(e,n){!function(e,t){const n="ImageViewer.js: Url for the viewer isn't good... please check.";throw console.warn(n),console.log("jqXHR object:",t),console.log("URL",e),document.write(`<h1>${n}</h1><b>URL:</b>&nbsp;${e}<br><br><b>Check the console for any clues.`),new Error("Something went wrong.")}(t,e)})}}let layers=function(e,t,n,i){let o;if(isRealValue(i)){let e=makeId(5,"layers"),r=i.getBoundingClientRect();o=createDraggableDiv(e,"Features",r.left,r.top),createLayerWidget(document.getElementById(`${e}Body`),t,n),handleDragLayers(t)}else createLayerWidget(document.getElementById(e),t,n),handleDragLayers(t);return o},eyeball=function(e,t,n){let i=n.world.getItemAt(t);i&&(e.classList.contains("fa-eye")?i.setOpacity(1):i.setOpacity(0))},createLayerWidget=function(e,t,n){const i=document.createElement("table");e.appendChild(i);let o=n.features,r=n.opacities;o.forEach(function(e,n){let o,a,s,l,c,d=n+1;o=i.insertRow(-1),i.appendChild(o),a=o.insertCell(-1),(s=document.createElement("span")).className="layer_tab",s.id=n+makeId(5,"feat"),s.setAttribute("draggable","true"),s.display="block",s.innerHTML=getStringRep(e),a.appendChild(s),a=o.insertCell(-1),(l=document.createElement("i")).classList.add("fas"),1===r[n]?l.classList.add("fa-eye"):l.classList.add("fa-eye-slash"),l.id=makeId(5,"eye"),a.appendChild(l),l.addEventListener("click",function(){toggleButton(l,"fa-eye","fa-eye-slash"),eyeball(l,d,t)}),a=o.insertCell(-1);let u=document.createElement("div");u.className="showDiv";let f=document.createElement("div");f.className="showHover",(c=document.createElement("i")).classList.add("fas"),c.classList.add("fa-adjust"),c.classList.add("hover-orange"),c.style.cursor="pointer",u.appendChild(c);let h=document.createElement("input");h.type="range",h.id=makeId(5,"range"),h.min="0",h.max="100",h.step="0.1",h.value=100*r[n],h.addEventListener("input",function(){const e=t.world.getItemAt(d);void 0!==e?e.setOpacity(this.value/100):console.warn("worldItem",e)}),f.appendChild(h),u.appendChild(f),a.appendChild(u),a=o.insertCell(-1),(c=document.createElement("i")).classList.add("fas"),c.classList.add("fa-palette"),c.id=makeId(5,"palette"),c.style.cursor="pointer",a.appendChild(c);let g=filters(t,colorRanges,c);c.addEventListener("click",function(e){g.style.display="block"})})},handleDragLayers=function(e){let t=document.querySelectorAll(".layer_tab");function n(e){return e.preventDefault&&e.preventDefault(),!1}function i(e){this.classList.add("over")}function o(e){this.classList.remove("over")}function r(t){this.style.opacity="0.4",dragSrcEl=this,sourceViewer=e,t.dataTransfer.effectAllowed="move",console.log("e.target.id",t.target.id),t.dataTransfer.setData("text",t.target.id)}function a(e){this.style.opacity="1",t.forEach(function(e){e.classList.remove("over")})}function s(e){if(e.preventDefault&&e.preventDefault(),dragSrcEl!==this){const t=e.target.closest(".viewer");if(!t)return!1;let n=e.dataTransfer.getData("text"),i=document.getElementById(n),o=i.id,r=i.innerHTML,a=document.querySelectorAll(".layer_tab");for(let e=0;e<a.length;e++){let t=a[e];if(t.innerHTML===r&&t.id!==o){let e=t.parentElement.parentElement.children[1].children[0];e.classList.remove("fa-eye-slash"),e.classList.add("fa-eye"),t.classList.remove("highlight"),t.classList.add("highlight");break}}let s=getViewerObject(t),l=n[0];console.log("layerNum",l),l=parseInt(l)+1,s.world.getItemAt(l).setOpacity(1)}return!1}t.forEach(function(e){e.setAttribute("draggable","true"),e.addEventListener("dragstart",r,!1),e.addEventListener("dragend",a,!1)}),(t=document.querySelectorAll(".drop_site")).forEach(function(e){e.addEventListener("dragenter",i,!1),e.addEventListener("dragleave",o,!1),e.addEventListener("dragover",n,!1),e.addEventListener("drop",s,!1)})};function getViewerObject(e){let t;try{let n;for(n=0;n<syncedImageViewers.length;n++)if(syncedImageViewers[n].getViewer().id===e.id){t=syncedImageViewers[n].getViewer();break}}catch(e){console.error("getViewerObject:",e.message)}return t}class MultiViewer extends ImageViewer{constructor(e,t,n,i,o,r,a){if(super(e,t,n,i,a),void 0===a&&(a={}),this.checkboxes={checkPan:!0,checkZoom:!0},this.viewer1=super.getViewer(),this.idx=e,this.sliders=o,r>1&&(this.checkboxes.checkPan=document.getElementById("chkPan"+this.idx),this.checkboxes.checkZoom=document.getElementById("chkZoom"+this.idx)),a.slidersOn&&a.toolbarOn&&addInputHandler(this.sliders,this.viewer1),a.toolbarOn&&markupTools(this.idx,this.viewer1),void 0!==i.features&&a.draggableLayers){layers(`layers_and_colors${this.idx}`,this.viewer1,i);let e=document.getElementById(`layers${this.idx}`),t=layers("",this.viewer1,i,e);e.addEventListener("click",function(e){t.style.display="block"})}try{let e=document.getElementById("palette"+this.idx);if(void 0!==a.colorRanges&&void 0!==e){let t=filters(this.viewer1,a.colorRanges,e);e.addEventListener("click",function(e){t.style.display="block"})}}catch(e){console.error("COLOR PALETTE:",e)}}getViewer(){return this.viewer1}getPanZoom(){return this.checkboxes}}function addInputHandler(e,t){let n;for(n=0;n<e.length;n++)e[n].addEventListener("input",function(){let e;e=(this.id.replace("sliderRange","")-1)%2==0?0:1;const n=t.world.getItemAt(e);void 0!==n?n.setOpacity(this.value/100):this.hidden=!0})}const synchronizeViewers=function(e){checkData(e)&&(this.syncedImageViewers=[],this.activeViewerId=null,this.numViewers=e.length,e.forEach(function(e){const t=e.getViewer();var n,i;setPanZoomCurrent(t,function(){if(!isActive(t.id))return;setPanZoomOthers(e),resetFlag()}),n=t,i=this.syncedImageViewers,overrideRightClickMenu(n.element),handleMarkerDisplay(n,i),handleButtonShowHide(),this.syncedImageViewers.push(e)}))};function setPanZoomCurrent(e,t){e.addHandler("pan",t),e.addHandler("zoom",t)}function isActive(e){return init(e),e===this.activeViewerId}function init(e){isRealValue(this.activeViewerId)||(this.activeViewerId=e)}function isPanOn(e){const t=e.getPanZoom();return void 0!==t.checkPan.checked?t.checkPan.checked:1!==this.numViewers}function isZoomOn(e){const t=e.getPanZoom();return void 0!==t.checkZoom.checked?t.checkZoom.checked:1!==this.numViewers}function setPanZoomOthers(e){const t=e.getViewer();this.syncedImageViewers.forEach(function(n){const i=n.getViewer();i.id!==t.id&&(isPanOn(n)&&isPanOn(e)&&i.viewport.panTo(t.viewport.getCenter(!1),!1),isZoomOn(n)&&isZoomOn(e)&&i.viewport.zoomTo(t.viewport.getZoom(!1)))})}function resetFlag(){this.activeViewerId=null}function checkData(e){return isEmpty(e)?(console.error("synchronizeViewers.js: Expected input argument, but received none."),!1):e[0]instanceof Object||(console.error("synchronizeViewers.js: Array elements should be MultiViewer objects."),!1)}