/*! multi-viewer - v1.0.0 - 2022-06-15 */
let CONFIG={osdImages:"/multi-viewer/vendor/openseadragon/images/",appImages:"/multi-viewer/images/"};function setFilter(e,t,n,o){if(console.log("range",typeof n,JSON.stringify(n)),console.log("thresh",typeof o,JSON.stringify(o)),t.world){let a=performance.now();const r=t.world.getItemCount();let i=[];for(let a=0;a<r;a++){const r=t.world.getItemAt(a);if(a>0)if(isEmpty(n))if(STATE.outline)i.push({items:r,processors:colorFilter.prototype.OUTLINE([0,0,255,255])});else if("byProbability"===STATE.renderType)i.push({items:r,processors:colorFilter.prototype.COLORLEVELS(e[a].colorscheme.colorspectrum)});else if("byClass"===STATE.renderType||"byHeatmap"===STATE.renderType){let t;t=o?colorFilter.prototype.THRESHOLDING(o):colorFilter.prototype.COLORLEVELS(e[a].colorscheme.colors),i.push({items:r,processors:t})}else"byThreshold"===STATE.renderType&&i.push({items:r,processors:colorFilter.prototype.THRESHOLDING(o)});else{let e;e="inside"===n.type?[0,255,255,255]:[74,0,180,255],i.push({items:r,processors:colorFilter.prototype.PROBABILITY(n,e)})}}if(!isEmpty(i))try{t.setFilterOptions({filters:i,loadMode:"sync"})}catch(e){console.error(e.message)}let s=performance.now();console.log(`exec: ${s-a}`)}else console.warn("No viewer.world")}function setOsdMove(e,t){e.setMouseNavEnabled(t),e.outerTracker.setTracking(t),e.gestureSettingsMouse.clickToZoom=t}function toggleButton(e,t,n){e.classList.toggle(t),e.classList.toggle(n)}function isRealValue(e){return e&&"null"!==e&&"undefined"!==e}const isEmpty=e=>{const t=e=>{if(void 0===e.length){return!Object.keys(e).some(t=>!isEmpty(e[t]))&&t(Object.keys(e))}return!e.some(e=>!isEmpty(e))};return!1===e||void 0===e||null===e||"object"==typeof e&&t(e)};function alertMessage(e){return window.alert(e),!0}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function createId(e,t){let n="";const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=o.length;for(let t=0;t<e;t++)n+=o.charAt(Math.floor(Math.random()*a));return t&&(n=t+n),n}String.prototype.hashCode=function(){let e,t=0;if(0===this.length)return t;for(let n=0;n<this.length;n++)t=(t<<5)-t+(e=this.charCodeAt(n)),t&=t;return t},fabric.Canvas.prototype.getItemsByName=function(e){const t=[],n=this.getObjects();for(let o=0,a=this.size();o<a;o++)n[o].name&&n[o].name===e&&t.push(n[o]);return t};const e=(e,t={},n=[])=>{const o=document.createElement(e);return Object.keys(t).forEach(e=>{o.setAttribute(e,t[e])}),n.forEach(e=>{if(!e)return;const t="string"==typeof e?document.createTextNode(e):e;o.appendChild(t)}),o},abs=Math.abs,min=Math.min;function almostEqual(e,t,n,o){const a=abs(e-t);return null==n&&(n=almostEqual.DBL_EPSILON),null==o&&(o=n),a<=n||(a<=o*min(abs(e),abs(t))||e===t)}function colorToArray(e){return e.replace(/[a-z%\s()]/g,"").split(",").map(e=>Number(e))}function parseHash(){const e={},t=window.location.hash.replace(/^#/,"");if(t){t.split("&").forEach(t=>{const n=t.split("="),o=n[0],a=parseFloat(n[1]);!o||isNaN(a)?console.error("bad hash param",t):e[o]=a})}return e}function timeStamp(){const e=(new Date).toISOString(),t=e.slice(0,10);let n=e.slice(10);return`${t}_${n=n.replaceAll(":","-").replace("T","").slice(0,8)}`}function saveSettings(e,t){const n={theme:document.body.className,canvas:e.toJSON(),state:STATE,options:t};console.log("settings",n)}function extractLocation(e){let t;if("string"==typeof e.location)t=e.location;else{if("object"!=typeof e.location)throw new TypeError(`Unidentified URL type... ${e.location}`);t=e.location.url}return t}function isValidURL(e){let t,n;try{n=new URL(e),t=!0}catch(e){t=!1,console.log(`%c${e.message}`,"color: #ff6a5a;",n),console.log("%cscript:","color: #ff6a5a;",`${e.fileName}:${e.lineNumber}`)}return t}almostEqual.DBL_EPSILON=2.220446049250313e-16,Array.prototype.flat||(console.log("!Array.prototype.flat"),Array.prototype.flat=function(e){void 0===e&&(e=1);let t=function(e,n){return n<1?e.slice():e.reduce((e,o)=>e.concat(Array.isArray(o)?t(o,n-1):o),[])};return t(this,e)});const scaleToPct=e=>e/255*100,scaleToRgb=e=>255*e/100,MAX=255;let MICRONS_PER_PIX=.25;const RENDER_TYPES=["byProbability","byClass","byHeatmap","byThreshold"],STATE={attenuate:!1,outline:!1,renderType:RENDER_TYPES[0]},pageSetup=(t,n,o,a,r,i,s,l)=>{let c=[];isRealValue(n)&&null!==n[0]||document.write("<script>window.alert('Click OK to continue...');window.location=`${window.location.origin}/auth/realms/Halcyon/protocol/openid-connect/logout?redirect_uri=${window.location.origin}`;<\/script>"),document.addEventListener("DOMContentLoaded",function(){new Promise(e=>e(l)).then(l=>{document.body.classList.add("theme--default");const d=e("i",{class:"fas fa-moon moon"});let u;const h=n[0][0].location;if(h.includes("TCGA")){const e=h.match(/TCGA-[^%.]+/)[0];u=`Slide: ${e}`}else{const e=h.split("/");u=`Slide: ${e[e.length-1]}`}const p=e("div",{style:"display: flex"},[e("div",{style:"flex: 1"},[d]),e("div",{style:"flex: 1; text-align: right;"},[u])]),f=document.querySelector(`#${t}`);f.before(p);const g=localStorage.getItem("mode");g&&"dark-mode"===g&&toggleButton(document.body,"theme--default","theme--dark"),d.addEventListener("click",()=>{toggleButton(d,"fa-sun","fa-moon"),toggleButton(d,"sun","moon"),toggleButton(document.body,"theme--default","theme--dark"),document.body.classList.contains("theme--dark")?localStorage.setItem("mode","dark-mode"):localStorage.setItem("mode","light-mode")});const m=document.getElementById(t),y=e("table");let b;m.appendChild(y);const v=a*r;let w=0;for(b=0;b<a;b++){const t=y.insertRow(b);let a;for(a=0;a<r;a++){const r=t.insertCell(a),d=createId(11),u=w;if(w++,o<v&&w-1===o)break;const h=e("div",{class:"divSquare"});h.style.width=`${i}px`,r.appendChild(h);let p="";o>1&&(p+=`<input type="checkbox" id="chkPan${u}" checked=""><label for="chkPan${u}">Match Pan</label>&nbsp;\n<input type="checkbox" id="chkZoom${u}" checked=""><label for="chkZoom${u}">Match Zoom</label>&nbsp;&nbsp;`),l&&l.toolbarOn&&(p+=`<div class="controls showDiv" id="hideTools${u}"><div id="tools${u}" class="showHover">`,p+='<div class="floated">',l&&l.paintbrushColor?p+=`<mark id="mark${u}">${l.paintbrushColor}</mark>&nbsp;`:p+=`<mark id="mark${u}">#00f</mark>&nbsp;`,p+=`<button id="btnDraw${u}" class="annotationBtn" title="Draw"><i class="fas fa-pencil-alt"></i></button>\n<button id="btnEdit${u}" class="annotationBtn" title="Edit"><i class="fas fa-draw-polygon"></i></button>\n<button id="btnGrid${u}" class="annotationBtn" title="Grid"><i class="fas fa-border-all"></i></button>\n<button id="btnGridMarker${u}" class="annotationBtn" title="Mark grid"><i class="fas fa-paint-brush"></i></button>\n<button id="btnRuler${u}" class="annotationBtn" title="Measure in microns"><i class="fas fa-ruler"></i></button>\n<button id="btnShare${u}" class="annotationBtn" title="Share this link"><i class="fas fa-share-alt"></i></button>\n<button id="btnCam${u}" class="annotationBtn" title="Snapshot"><i class="fas fa-camera"></i></button>\n<button id="btnBlender${u}" class="annotationBtn" title="Blend-modes"><i class="fas fa-blender"></i></button>\n<button id="btnCrosshairs${u}" class="annotationBtn" title="Crosshairs"><i class="fas fa-crosshairs"></i></button>\n<button id="btnSave${u}" class="annotationBtn" title="Save"><i class="fas fa-save"></i></button>\n<div class="mag" style="display: inline">\n  <button class="annotationBtn">\n  <i class="fas fa-search"></i>\n  </button>\n  \x3c!-- data-value = image zoom --\x3e\n  <div class="mag-content">\n    <a href="#" data-value="0.025" id="1">1x</a>\n    <a href="#" data-value="0.05" id="2">2x</a>\n    <a href="#" data-value="0.1" id="4">4x</a>\n    <a href="#" data-value="0.25" id="10">10x</a>\n    <a href="#" data-value="0.5" id="20">20x</a>\n    <a href="#" data-value="1.0" id="40">40x</a>\n  </div>\n</div>\n<button id="btnMapMarker" class="annotationBtn" style="display: none"><i class="fas fa-map-marker-alt"></i> Hide markers</button>\n</div>`,p+="</div></div>"),p+=`<table><tr><td><div id="${d}" class="viewer dropzone" style="width: ${i}px; height: ${s}px;"></div>\n</td><td id="layersAndColors${u}" style="vertical-align: top;"></td>\n</tr></table>`,h.innerHTML=p;const f=new CP(document.getElementById(`mark${u}`));f.on("change",function(e,t,n,o){this.source.value=this.color(e,t,n,o),this.source.innerHTML=this.color(e,t,n,o),this.source.style.backgroundColor=this.color(e,t,n,o)});const g={idx:u,osdId:d,layers:n[u]};c.push(new MultiViewer(g,o,l))}}return c}).then(e=>{synchronizeViewers(e)})}),window.addEventListener("keydown",function(e){const t=e.key.toLocaleLowerCase();if("escape"===t||"esc"===t){e.preventDefault();const t=document.getElementsByClassName("btnOn");for(let e=0;e<t.length;e++)t[e].click()}if(e.ctrlKey&&"r"===t){e.preventDefault();for(let e=0;e<c.length;e++)document.querySelectorAll('[id^="btnRuler"]').forEach(e=>{e.click()})}})},editPolygon=(e,t)=>{e.addEventListener("click",function(){toggleButton(this,"btnOn","annotationBtn"),Edit(this,t.fabricCanvas())})};function polygonPositionHandler(e,t,n){const o=n.points[this.pointIndex].x-n.pathOffset.x,a=n.points[this.pointIndex].y-n.pathOffset.y;return fabric.util.transformPoint({x:o,y:a},fabric.util.multiplyTransformMatrices(n.canvas.viewportTransform,n.calcTransformMatrix()))}function actionHandler(e,t,n,o){const a=t.target,r=a.controls[a.__corner],i=a.toLocalPoint(new fabric.Point(n,o),"center","center"),s=a._getNonTransformedDimensions(),l=a._getTransformedDimensions(0,0),c={x:i.x*s.x/l.x+a.pathOffset.x,y:i.y*s.y/l.y+a.pathOffset.y};return a.points[r.pointIndex]=c,!0}function anchorWrapper(e,t){return(n,o,a,r)=>{const i=o.target,s=fabric.util.transformPoint({x:i.points[e].x-i.pathOffset.x,y:i.points[e].y-i.pathOffset.y},i.calcTransformMatrix()),l=t(n,o,a,r),c=(i._setPositionDimensions({}),i._getNonTransformedDimensions()),d=(i.points[e].x-i.pathOffset.x)/c.x,u=(i.points[e].y-i.pathOffset.y)/c.y;return i.setPositionByOrigin(s,d+.5,u+.5),l}}function getPolygon(e){if(e.getActiveObject())return e.getActiveObject();const t=e.getObjects("polygon");return 0===t.length?"null":1===t.length?t[0]:"null"}function Edit(e,t){const n=getPolygon(t);if(isRealValue(n)){if(t.setActiveObject(n),n.edit=!n.edit,n.edit){const e=n.points.length-1;n.cornerColor="rgba(0, 0, 255, 255)",n.cornerStyle="circle",n.controls=n.points.reduce((t,n,o)=>(t[`p${o}`]=new fabric.Control({positionHandler:polygonPositionHandler,actionHandler:anchorWrapper(o>0?o-1:e,actionHandler),actionName:"modifyPolygon",pointIndex:o}),t),{})}else n.cornerColor="rgba(0, 0, 255, 0.5)",n.cornerStyle="rect",n.controls=fabric.Object.prototype.controls;n.hasBorders=!n.edit,t.requestRenderAll()}else toggleButton(e,"btnOn","annotationBtn"),alertMessage("Please select a polygon for editing.")}const drawPolygon=(e,t,n)=>{const o=e.idx,a=document.getElementById(`btnDraw${o}`),r=document.getElementById(`mark${o}`),i=n.fabricCanvas(),s=i.freeDrawingBrush=new fabric.PencilBrush(i);function l(e,t){e.isDrawingMode=!1,e.off("mouse:down",()=>{c(e,t)}),setOsdMove(t,!0)}function c(e,t){t.gestureSettingsMouse.clickToZoom=!e.getActiveObject()}function d(e){return isRealValue(e.target)&&"polygon"===e.target.type}s.decimate=12,s.color=r.innerHTML,i.on("mouse:over",e=>{!function(e,t){if(d(e)){const n=e.target;n.set({fill:n.stroke,opacity:.5}),t.renderAll()}}(e,i)}),i.on("mouse:out",e=>{!function(e,t){if(d(e)){const n=e.target;null!==n&&(n.set({fill:""}),t.renderAll())}}(e,i)}),i.on("mouse:up",()=>{l(i,t)}),i.on("path:created",e=>{!function e(t,n,o,a,r){!function(e,t,n){const o=e.path.map(e=>({x:e[1],y:e[2]})),a=new fabric.Polygon(o,{left:e.left,top:e.top,fill:"",strokeWidth:n.width,stroke:n.color,scaleX:e.scaleX,scaleY:e.scaleY,objectCaching:!1,transparentCorners:!1,cornerColor:"rgba(0, 0, 255, 0.5)",cornerStyle:"square"});t.add(a),a.setControlVisible("tr",!1),t.setActiveObject(a),t.remove(e)}(t.path,o,a);i=t.path,i.lockMovementX=!0,i.lockMovementY=!0,function(){const e=document.createElement("img");var t;e.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E",fabric.Object.prototype.controls.deleteControl=new fabric.Control({x:.5,y:-.5,offsetX:15,offsetY:-15,cursorStyle:"pointer",mouseUpHandler:function(e,t){const n=t.target;try{const e=n.canvas;e.remove(n),e.requestRenderAll()}catch(e){console.error(`%c${e.message}`,"font-size: larger;")}},render:(t=e,function(e,n,o,a,r){const i=this.cornerSize;e.save(),e.translate(n,o),e.rotate(fabric.util.degreesToRadians(r.angle)),e.drawImage(t,-i/2,-i/2,i,i),e.restore()}),cornerSize:24})}();var i;toggleButton(n,"annotationBtn","btnOn");o.off("path:created",()=>{e(t,n,o,a,r)})}(e,a,i,s,t)}),a.addEventListener("click",function(){toggleButton(this,"btnOn","annotationBtn"),i.isDrawingMode?l(i,t):function(e,t,n,o){e.isDrawingMode=!0,e.on("mouse:down",()=>{c(e,t)}),n.color=o.innerHTML,n.width=10/t.viewport.getZoom(!0),setOsdMove(t,!1)}(i,t,s,r)})},gridOverlay=(e,t,n)=>{const o={canvas:n.fabricCanvas(),canvasWidth:Math.ceil(n.fabricCanvas().width),canvasHeight:Math.ceil(n.fabricCanvas().height),cellWidth:25,cellHeight:25,color:"#C0C0C0",cellX:[],cellY:[],gridAdded:!1};e.addEventListener("click",function(){gridHandler(this,o)}),t.addEventListener("click",function(){markerHandler(this,o)}),grandCross(e,o)};function gridHandler(e,t){toggleButton(e,"btnOn","annotationBtn");const n=e.classList.contains("btnOn");n&&(turnGridOn(t),t.gridAdded=!0),n||(turnGridOff(t),t.gridAdded=!1)}function turnGridOff(e){const t=e.canvas.getObjects("line");for(let n=0;n<t.length;n++)e.canvas.remove(t[n])}function turnGridOn(e){const t={stroke:e.color,strokeWidth:2,selectable:!1};createHorizontalLines(e,t),createVerticalLines(e,t),e.canvas.renderAll(),e.gridAdded=!0}function createHorizontalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasHeight/e.cellHeight);++n)e.canvas.add(new fabric.Line([0,n*e.cellHeight,e.canvasWidth,n*e.cellHeight],t)),e.cellY[n+1]=n*e.cellHeight}function createVerticalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasWidth/e.cellWidth);++n)e.canvas.add(new fabric.Line([n*e.cellWidth,0,n*e.cellWidth,e.canvasHeight],t)),e.cellX[n+1]=n*e.cellWidth}function fillInGrid(e,t){const n=getCellPosition(getMousePosition(e,t)),o=new fabric.Rect({left:t.cellX[n.x],top:t.cellY[n.y],fill:"red",width:t.cellWidth,height:t.cellHeight,opacity:.5,selectable:!1});t.canvas.add(o)}function getMousePosition(e,t){const n=t.canvas.getPointer(e.e);return{x:n.x/t.cellWidth,y:n.y/t.cellHeight}}function getCellPosition(e){return{x:Math.ceil(e.x+.001),y:Math.ceil(e.y+.001)}}function markerHandler(e,t){toggleButton(e,"btnOn","annotationBtn");const n=e.classList.contains("btnOn");n||(t.canvas.__eventListeners["mouse:move"]=[]),n&&(t.gridAdded?t.canvas.on("mouse:move",e=>{fillInGrid(e,t)}):(toggleButton(e,"btnOn","annotationBtn"),alertMessage("Please draw a grid first.")))}function grandCross(e,t){const n=t.canvas;const o=document.getElementById(`btnCrosshairs${e.id.slice(-1)}`);function a(e){if(e){const e=n.width/2,o=n.height/2;function t(e,t,o,a){const r=new fabric.Line([e,t,o,a],{stroke:"yellow",selectable:!1,strokeWidth:2,hoverCursor:"default",evented:!1,name:"cross"});n.add(r)}t(e,0,e,n.height),t(0,o,n.width,o)}else n.remove(...n.getItemsByName("cross"))}o.addEventListener("click",()=>{o.classList.contains("btnOn")?a(!1):a(!0),toggleButton(o,"btnOn","annotationBtn")})}const mapMarker=(e,t)=>{overrideRightClickMenu(e.element),handleMarkerDisplay(e,t),handleButtonShowHide()};function overrideRightClickMenu(e){e.addEventListener("contextmenu",e=>{e.preventDefault()})}function handleMarkerDisplay(e,t){e.addHandler("canvas-nonprimary-press",n=>{if(isRightClick(n)){const o=n.position,a=e.viewport.pointFromPixel(o);document.querySelectorAll("#btnMapMarker").forEach(e=>{e.style.display="block"}),displayMapMarker(a,e,t)}})}function isRightClick(e){return 2===e.button}function displayMapMarker(e,t,n){n.forEach(t=>{t.getViewer().addOverlay({element:createLink(),location:e,placement:"BOTTOM",checkResize:!1})})}function createLink(){const t=e("a",{href:"#",id:"pin",class:"fas fa-map-marker pointer"});return t.style="text-decoration: none; font-size: 22px; color: red;",t.dataset.href="#",t}function handleButtonShowHide(){document.querySelectorAll("#btnMapMarker").forEach(e=>{let t,n,o=!1;e.addEventListener("click",function(){o?(t="block",n='<i class="fas fa-map-marker"></i> Hide markers'):(t="none",n='<i class="fas fa-map-marker"></i> Show markers'),this.innerHTML=n,document.querySelectorAll("#pin").forEach(e=>{e.style.display=t}),o=!o})})}const ruler=(e,t,n)=>{let o,a,r,i,s="x";const l={x:0,y:0},c={x:0,y:0};let d,u;const h=n.fabricCanvas();function p(e){if(l.x=0,c.x=0,l.y=0,c.y=0,r=t.viewport.getZoom(!0),"draw"===s){setOsdMove(t,!1),a=!0;const n=e.e,i=new OpenSeadragon.Point(n.clientX,n.clientY);try{const e=t.viewport.pointFromPixel(i);d=t.world.getItemAt(0).viewportToImageCoordinates(e)}catch(e){console.error(`%c${e.message}`,"font-size: larger;")}const s=h.getPointer(n),c=[s.x,s.y,s.x,s.y];l.x=s.x,l.y=s.y,o=new fabric.Line(c,{strokeWidth:2/r,stroke:"#0f0",originX:"center",originY:"center",selectable:!1,evented:!1,name:"ruler"}),h.add(o)}else setOsdMove(t,!0),h.forEachObject(e=>{e.setCoords()})}function f(e,t){return Math.abs(e-t)}function g(e,t,n,o){const a=new fabric.Rect({left:e,top:t,width:150/r,height:25/r,rx:5/r,ry:5/r,fill:"rgba(255,255,255,0.5)",transparentCorners:!0,selectable:!1,evented:!1,name:"ruler"});(i=new fabric.Text(n,{left:e,top:t,fontFamily:"Verdana",fill:"black",selectable:!1,evented:!1,name:"ruler"})).scaleToWidth(a.width),o&&h.add(a),h.add(i)}function m(e){if(!a)return;h.remove(i),h.renderAll();const n=e.e,r=new OpenSeadragon.Point(n.clientX,n.clientY),l=t.viewport.pointFromPixel(r);u=t.world.getItemAt(0).viewportToImageCoordinates(l);const p=f(d.x,u.x),m=f(d.y,u.y);var y,b,v;const w=function(e){if(e<1e-6)return`${(1e9*e).toFixed(3)} fm`;if(e<.001)return`${(1e6*e).toFixed(3)} pm`;if(e<1)return`${(1e3*e).toFixed(3)} nm`;if(e>=1e3)return`${(e/1e3).toFixed(3)} mm`;return`${e.toFixed(3)} Âµm`}((y=p,b=m,v=MICRONS_PER_PIX,Math.sqrt(y*y*v*v+b*b*v*v))),E=h.getPointer(n);o.set({x2:E.x,y2:E.y}),c.x=E.x,c.y=E.y,"draw"===s&&g(c.x,c.y,w,!1),h.renderAll()}function y(e){if(o.setCoords(),h.remove(i),a=!1,c.x>0){console.log(`%clength: ${i.text}`,"color: #ccff00;");const t=h.getPointer(e.e);g(t.x,t.y,i.text,r<100),h.renderAll()}}fabric.Object.prototype.transparentCorners=!1,e.addEventListener("click",()=>{"draw"===s?(h.remove(...h.getItemsByName("ruler")),s="x",h.off("mouse:down",p),h.off("mouse:move",m),h.off("mouse:up",y)):(s="draw",h.on("mouse:down",p),h.on("mouse:move",m),h.on("mouse:up",y)),toggleButton(e,"btnOn","annotationBtn")})},blender=(t,n)=>{const o=[["normal","normal"],["difference","The Difference blend mode subtracts the pixels of the base and blend layers and the result is the greater brightness value. When you subtract two pixels with the same value, the result is black."],["multiply","The Multiply mode multiplies the colors of the blending layer and the base layers, resulting in a darker color. This mode is useful for coloring shadows."],["screen","With Screen blend mode, the values of the pixels in the layers are inverted, multiplied, and then inverted again. The result is the opposite of Multiply: wherever either layer was darker than white, the composite is brighter."],["overlay","The Overlay blend mode both multiplies dark areas and screens light areas at the same time, so dark areas become darker and light areas become lighter. Anything that is 50% gray completely disappears from view."],["darken","The Darken Blending Mode looks at the luminance values in each of the RGB channels and selects the color of whichever layer is darkest."],["lighten","The Lighten Blending Mode takes a look at color of the layers, and keeps whichever one is lightest."],["color-dodge","The Color Dodge blend mode divides the bottom layer by the inverted top layer."],["color-burn","The Color Burn Blending Mode gives you a darker result than Multiply by increasing the contrast between the base and the blend colors resulting in more highly saturated mid-tones and reduced highlights."],["hard-light","Hard Light combines the Multiply and Screen Blending Modes using the brightness values of the Blend layer to make its calculations. The results with Hard Light tend to be intense."],["soft-light","With the Soft Light blending mode, every color that is lighter than 50% grey will get even lighter, like it would if you shine a soft spotlight to it. In the same way, every color darker than 50% grey will get even darker."],["exclusion","Exclusion is very similar to Difference. Blending with white inverts the base color values, while blending with black produces no change. However, Blending with 50% gray produces 50% gray."],["hue","The Hue Blending Mode preserves the luminosity and saturation of the base pixels while adopting the hue of the blend pixels."],["saturation","The Saturation Blending Mode preserves the luminosity and hue of the base layer while adopting the saturation of the blend layer."],["color","The Color blend mode is a combination of Hue and Saturation. Only the color (the hues and their saturation values) from the layer is blended in with the layer or layers below it."],["luminosity","The Luminosity blend mode preserves the hue and chroma of the bottom layers, while adopting the luma of the top layer."]];t.addEventListener("click",()=>{const a=createId(5,"modes"),r=t.getBoundingClientRect();createDraggableDiv(a,"Blend Modes",r.left,r.top).style.display="block",function(t,n){const a=e("table");t.appendChild(a),o.forEach(t=>{const o=t[0],r=t[1],i=e("button",{type:"button",id:o.replace("-","_"),value:o,class:"annotationBtn css-tooltip",style:"width: 120px","data-tooltip":r});i.innerHTML=o;const s=e("tr",{},[e("td",{class:"tooltip"},[i,e("br")])]);a.appendChild(s),i.addEventListener("click",()=>{try{const e=n.world.getItemCount();n.world.getItemAt(e-1).setCompositeOperation(i.value)}catch(e){console.error(e.message)}})})}(document.getElementById(`${a}Body`),n)})},markupTools=(e,t,n)=>{const o=n.fabricjsOverlay({scale:1,static:!1}),a=e.idx;drawPolygon(e,n,o),editPolygon(document.getElementById(`btnEdit${a}`),o),gridOverlay(document.getElementById(`btnGrid${a}`),document.getElementById(`btnGridMarker${a}`),o),ruler(document.getElementById(`btnRuler${a}`),n,o),blender(document.getElementById(`btnBlender${a}`),n);const r=o.fabricCanvas();r.on("after:render",()=>{r.calcOffset()}),document.getElementById(`btnSave${e.idx}`).addEventListener("click",()=>{saveSettings(r,t)})};function createDraggableDiv(t,n,o,a,r=!1){const i=e("div",{class:"popup",id:t});i.style.left=`${o}px`,i.style.top=`${a}px`;const s=e("img",{src:`${CONFIG.appImages}close-icon.png`,alt:"close",height:25,width:25});s.style.cursor="pointer",s.addEventListener("click",()=>{i.style.display="none"});const l=e("div",{class:"popupHeader",id:`${t}Header`},[s,e("span",{},[n])]);i.appendChild(l);const c=e("div",{id:`${t}Body`,style:"padding: 10px;"});return i.appendChild(c),document.body.appendChild(i),r||(i.style.display="none"),dragElement(i),i}function dragElement(e){let t=0,n=0,o=0,a=0;function r(e){e.preventDefault(),o=e.clientX,a=e.clientY,document.onmouseup=s,document.onmousemove=i}function i(r){r.preventDefault(),t=o-r.clientX,n=a-r.clientY,o=r.clientX,a=r.clientY,e.style.top=`${e.offsetTop-n}px`,e.style.left=`${e.offsetLeft-t}px`}function s(){document.onmouseup=null,document.onmousemove=null}document.getElementById(`${e.id}Header`)?document.getElementById(`${e.id}Header`).onmousedown=r:e.onmousedown=r}const filterPopup=(t,n,o,a,r)=>{setChecked(o);const i=getRandomInt(100,999),s=createPopup(i,t,n),l=s.lastChild,c=e("div"),d=e("div"),u=e("div"),h=e("div"),p=createDropdown(i,[c,d,u,h],a,r);l.appendChild(p),c.style.display="byClass"===STATE.renderType?"block":"none",l.appendChild(c),createUI(i,c,o.colors,a,r,"byClass"),d.style.display="byProbability"===STATE.renderType?"block":"none",l.appendChild(d),createUI(i,d,o.colorspectrum,a,r,"byProbability");return u.style.display="byHeatmap"===STATE.renderType?"block":"none",l.appendChild(u),u.innerHTML='<p style="color: #ffffff; background: -webkit-linear-gradient(#FF0000, #0000FF);">Color gradient where reddish colors<br>correspond to sureness and<br>bluish colors to unsureness.</p>',h.style.display="byThreshold"===STATE.renderType?"block":"none",l.appendChild(h),createThresh(h,a,r),s};function createPopup(e,t,n){const o=`filters${e}`,a=t.getBoundingClientRect();return createDraggableDiv(o,n,a.left,a.top)}function setChecked(e){e.colors.map(e=>e.checked=!0),e.colorspectrum.forEach((e,t)=>{e.checked=!0,e.classid=t})}function createThresh(t,n,o,a,r){let i;a?3===(i=colorToArray(a.style.backgroundColor)).length&&i.push(255):i=[126,1,0,255];const s=e("input",{type:"number",min:"0",max:MAX.toString(),step:"1",size:"5",value:"1"}),l=e("input",{type:"range",min:"0",max:MAX.toString(),step:"1",value:"1"});t.appendChild(e("div",{},[s,l])),s.addEventListener("input",function(){l.value=this.value,setFilter(n,o,{},{val:parseInt(this.value),rgba:i,classId:r})}),l.addEventListener("input",function(){s.value=this.value,setFilter(n,o,{},{val:parseInt(this.value),rgba:i,classId:r})})}function checkboxHandler(e,t,n,o){e.addEventListener("click",()=>{t.find(t=>t.classid===parseInt(e.value)).checked=e.checked,setFilter(n,o)})}function createDropdown(t,n,o,a){const r=e("div",{style:"display: block;"}),i=`select${t}`;r.innerHTML=`<label for="${i}">Color by:</label>&nbsp;`;const s=e("select");return s.id=i,r.appendChild(s),RENDER_TYPES.forEach((e,t)=>{const n=document.createElement("option");n.setAttribute("value",e),n.text=e.startsWith("by")?e.replace("by",""):e,s.appendChild(n)}),s.addEventListener("change",()=>{STATE.renderType=s.options[s.selectedIndex].value,STATE.outline=!1,n.forEach(e=>{e.style.display="none"}),"byClass"===STATE.renderType?n[0].style.display="block":"byProbability"===STATE.renderType?n[1].style.display="block":"byHeatmap"===STATE.renderType?n[2].style.display="block":"byThreshold"===STATE.renderType&&(n[3].style.display="block"),"byThreshold"===STATE.renderType?setFilter(o,a,{},{val:1,rgba:[126,1,0,255]}):setFilter(o,a)}),r}function createUI(t,n,o,a,r,i){const s=e("table",{class:"popupBody"});n.appendChild(s);const l="byProbability"===i,c="byClass"===i;o?(c?s.appendChild(createHeaderRow(["","Color","Label","Pixels with certainty >= n"])):l&&(o.sort((e,t)=>t.low-e.low),s.appendChild(createHeaderRow(["","Color","Low","High"]))),o.forEach((n,i)=>{const d=e("input",{type:"checkbox",name:`classes${t}`,value:n.classid});n.checked?d.setAttribute("checked",!0):d.removeAttribute("checked");const u=createColorPicker(i,t,n,a,r);let h,p,f,g;if(l){p=createNumericInput(`low${t}${i}`,s,t,a,n,o,r),f=createNumericInput(`high${t}${i}`,s,t,a,n,o,r),g=e("i",{id:`i${t}${i}`,class:"fas fa-minus pointer"}),h=e("tr",{},[e("td",{},[d]),e("td",{},[u]),e("td",{},[p]),e("td",{},[f]),e("td",{},[g])])}else if(c){let t=e("div");createThresh(t,a,r,u,n.classid),h=e("tr",{},[e("td",{},[d]),e("td",{},[u]),e("td",{},[e("span",{},[n.name])]),e("td",{},[t])])}s.appendChild(h),checkboxHandler(d,o,a,r),l&&g.addEventListener("click",removeColor.bind(null,g,o,h,a,r),{passive:!0})}),l&&s.appendChild(extraRow(t,o,a,r))):console.warn("Layer colors?",o)}function removeColor(e,t,n,o,a){const r=e.id,i=r.charAt(r.length-1);t.splice(parseInt(i),1),n.remove(),setFilter(o,a)}function createHeaderRow(t){const n=e("tr");for(let o=0;o<t.length;o++){const a=e("th",{class:"pointer"});a.innerHTML=t[o],n.appendChild(a),a.addEventListener("click",()=>{const e=a.closest("table");Array.from(e.querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(a.parentNode.children).indexOf(a),this.asc=!this.asc)).forEach(t=>e.appendChild(t))})}return n}const getCellValue=(e,t)=>{const n=e.children[t];return n.children[0]?"number"===n.children[0].type?n.children[0].value:n.innerText||n.textContent:""},comparer=(e,t)=>(n,o)=>((e,t)=>""===e||""===t||isNaN(e)||isNaN(t)?e.toString().localeCompare(t):e-t)(getCellValue(t?n:o,e),getCellValue(t?o:n,e));function createColorPicker(t,n,o,a,r){let i=!0;const s=e("mark",{id:`marker${n}${t}`}),l=o.color;return s.style.backgroundColor=l,s.innerHTML=`#${rgba2hex(l)}`,new CP(s).on("change",function(e,t,n,s){i?i=!1:(this.source.value=this.color(e,t,n,s),this.source.innerHTML=this.color(e,t,n,s),this.source.style.backgroundColor=this.color(e,t,n,s),o.color=`rgba(${e}, ${t}, ${n}, ${255*s})`,setFilter(a,r))}),s}function rgba2hex(e){let t;const n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),o=(n&&n[4]||"").trim();let a=n?(256|n[1]).toString(16).slice(1)+(256|n[2]).toString(16).slice(1)+(256|n[3]).toString(16).slice(1):e;return a+=t=(256|(t=""!==o?o:1)).toString(16).slice(1)}function numericEvent(e,t,n,o){const a=parseInt(e.value);a>MAX&&(e.value=MAX.toString()),a<0&&(e.value="0"),e.id.startsWith("low")&&(t.low=a),e.id.startsWith("high")&&(t.high=a),setFilter(n,o)}function createNumericInput(t,n,o,a,r,i,s){let l;l=r.low||r.high?t.includes("low")?r.low.toString():r.high.toString():"";const c=e("input",{id:t,type:"number",min:"0",max:MAX.toString(),step:"1",size:"5",value:l});return c.addEventListener("input",numericEvent.bind(null,c,r,a,s),{passive:!0}),c}function isIntersect(e){const t=[],n=e.getElementsByTagName("td");for(const e of n){const n=e.children[0];if("number"===n.type&&(n.style.outlineStyle="",n.style.outlineColor="",n.id.startsWith("low")&&t.push({low:n,lowVal:parseInt(n.value)}),n.id.startsWith("high"))){const e=t[t.length-1];e.high=n,e.highVal=parseInt(n.value)}}t.sort((e,t)=>t.lowVal-e.lowVal);const o=t.length-1;for(let e=0;e<o;e++){const n=0!==t[e].lowVal&&0!==t[e+1].highVal;if(t[e].lowVal<=t[e+1].highVal&&n)return setOutlineStyle(t[e].low,t[e+1].high,"solid","red"),!0}return!1}function setOutlineStyle(e,t,n,o){isRealValue(e)&&(e.style.outlineStyle=n,e.style.outlineColor=o),isRealValue(t)&&(t.style.outlineStyle=n,t.style.outlineColor=o)}function addColor(t,n,o,a,r,i,s,l,c,d){if(setOutlineStyle(n,o,"",""),"0"===n.value&&"0"===o.value)setOutlineStyle(n,o,"solid","red");else{const t=`i${n.id.replace("low","")}`,o=e("i",{id:t,class:"fas fa-minus pointer"});s.lastChild.firstChild.remove(),s.lastChild.appendChild(o),o.addEventListener("click",removeColor.bind(null,o,l,s,c,d),{passive:!0}),checkboxHandler(r,l,c,d),s.closest("table").appendChild(extraRow(i,l,c,d))}}function seq(e){const t=e.map(e=>e.classid);t.sort();const[n,o]=[Math.min(...t),Math.max(...t)];return Array.from(Array(o-n),(e,t)=>t+n).filter(e=>!t.includes(e))}function extraRow(t,n,o,a){let r;const i=seq(n),s={color:"rgba(255, 255, 255, 255)",low:0,high:0,checked:!1,classid:r=!i||isEmpty(i)?n.length:Array.isArray(i)?i[0]:i};n.push(s);const l=e("input",{type:"checkbox",name:`classes${t}`,value:r});checkboxHandler(l,n,o,a);const c=createColorPicker(r,t,s,o,a),d=document.getElementById(`filters${t}Body`).firstChild,u=createNumericInput(`low${t}${r}`,d,t,o,s,n,a),h=createNumericInput(`high${t}${r}`,d,t,o,s,n,a),p=e("i",{id:`i${t}${r}`,class:"fas fa-plus pointer"}),f=e("tr",{},[e("td",{},[l]),e("td",{},[c]),e("td",{},[u]),e("td",{},[h]),e("td",{},[p])]);return p.addEventListener("click",addColor.bind(null,r,u,h,c,l,t,f,n,o,a),{passive:!0}),f}const img2array=e=>e.data.reduce((e,t,n)=>(n%4==0?e.push([t]):e[e.length-1].push(t))&&e,[]),bgTrans=function(e){for(let t=0;t<e.length;t+=4)0===e[t+1]&&(e[t+3]=0);return e},backgroundCorrection=e=>(e.forEach(e=>{0!==e[1]&&0!==e[3]||(e[0]=0,e[1]=0,e[2]=0,e[3]=0)}),e),colorFilter=OpenSeadragon.Filters.GREYSCALE,colorChannel=1,alphaChannel=3;colorFilter.prototype.OUTLINE=(e=>(t,n)=>{const o=t.canvas.width,a=t.canvas.height,r=t.getImageData(0,0,o,a);let i=backgroundCorrection(img2array(r));for(let t=0;t<i.length;t++)if(255===i[t][3]&&i[t][1]>0){try{0===i[t+1][3]&&(i[t][0]=e[0],i[t][1]=e[1],i[t][2]=e[2],i[t][3]=e[3])}catch(e){}try{0===i[t-1][3]&&(i[t][0]=e[0],i[t][1]=e[1],i[t][2]=e[2],i[t][3]=e[3])}catch(e){}try{0===i[t-o][3]&&(i[t][0]=e[0],i[t][1]=e[1],i[t][2]=e[2],i[t][3]=e[3])}catch(e){}try{0===i[t+o][3]&&(i[t][0]=e[0],i[t][1]=e[1],i[t][2]=e[2],i[t][3]=e[3])}catch(e){}}else i[t][0]=0,i[t][1]=0,i[t][2]=0,i[t][3]=0;i.forEach(e=>{e[1]>0&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0)});let s=t.createImageData(o,a);s.data.set(i.flat()),t.putImageData(s,0,0),n()}),colorFilter.prototype.PROBABILITY=((e,t)=>(n,o)=>{const a=n.getImageData(0,0,n.canvas.width,n.canvas.height);let r=a.data;if("inside"===e.type)for(let n=0;n<r.length;n+=4){const o=r[n+1];o>e.min&&o<=e.max?(r[n]=t[0],r[n+1]=t[1],r[n+2]=t[2],r[n+3]=t[3]):r[n+3]=0}else if("outside"===e.type)for(let n=0;n<r.length;n+=4){const o=r[n+1];o>0&&o<=e.min||o<=255&&o>=e.max?(r[n]=t[0],r[n+1]=t[1],r[n+2]=t[2],r[n+3]=t[3]):r[n+3]=0}n.putImageData(a,0,0),o()}),colorFilter.prototype.COLORLEVELS=(e=>(t,n)=>{const o=t.getImageData(0,0,t.canvas.width,t.canvas.height),a=bgTrans(o.data),r=e.filter(e=>!0===e.checked),i=r.map(e=>colorToArray(e.color)),s=(e,t,n)=>{for(let o=0;o<t.length;o++)if(e>=t[o].low&&e<=t[o].high)return n[o];return 0},l=(e,t,n)=>{for(let o=0;o<t.length;o++)if(e===t[o].classid)return n[o];return 0};function c(e,t){for(let n=0;n<a.length;n+=4)if(255===a[n+3]){const o=a[n],s=a[n+1];let l;if("byClass"===STATE.renderType)l=e(o,r,i);else if("byProbability"===STATE.renderType)l=e(s,r,i);else{if("byHeatmap"!==STATE.renderType)return void console.error("renderType?",STATE.renderType);l=t[s]}a[n]=l[0],a[n+1]=l[1],a[n+2]=l[2],a[n+3]=l[3],l[3]>0&&(a[n+3]=STATE.attenuate?s:255)}else a[n]=0,a[n+1]=0,a[n+2]=0,a[n+3]=0}"byClass"===STATE.renderType&&c(l),"byProbability"===STATE.renderType&&c(s),"byHeatmap"===STATE.renderType&&c({},[[0,0,255,255],[1,0,254,255],[2,0,253,255],[3,0,252,255],[4,0,251,255],[5,0,250,255],[6,0,249,255],[7,0,248,255],[8,0,247,255],[9,0,246,255],[10,0,245,255],[11,0,244,255],[12,0,243,255],[13,0,242,255],[14,0,241,255],[15,0,240,255],[16,0,239,255],[17,0,238,255],[18,0,237,255],[19,0,236,255],[20,0,235,255],[21,0,234,255],[22,0,233,255],[23,0,232,255],[24,0,231,255],[25,0,230,255],[26,0,229,255],[27,0,228,255],[28,0,227,255],[29,0,226,255],[30,0,225,255],[31,0,224,255],[32,0,223,255],[33,0,222,255],[34,0,221,255],[35,0,220,255],[36,0,219,255],[37,0,218,255],[38,0,217,255],[39,0,216,255],[40,0,215,255],[41,0,214,255],[42,0,213,255],[43,0,212,255],[44,0,211,255],[45,0,210,255],[46,0,209,255],[47,0,208,255],[48,0,207,255],[49,0,206,255],[50,0,205,255],[51,0,204,255],[52,0,203,255],[53,0,202,255],[54,0,201,255],[55,0,200,255],[56,0,199,255],[57,0,198,255],[58,0,197,255],[59,0,196,255],[60,0,195,255],[61,0,194,255],[62,0,193,255],[63,0,192,255],[64,0,191,255],[65,0,190,255],[66,0,189,255],[67,0,188,255],[68,0,187,255],[69,0,186,255],[70,0,185,255],[71,0,184,255],[72,0,183,255],[73,0,182,255],[74,0,181,255],[75,0,180,255],[76,0,179,255],[77,0,178,255],[78,0,177,255],[79,0,176,255],[80,0,175,255],[81,0,174,255],[82,0,173,255],[83,0,172,255],[84,0,171,255],[85,0,170,255],[86,0,169,255],[87,0,168,255],[88,0,167,255],[89,0,166,255],[90,0,165,255],[91,0,164,255],[92,0,163,255],[93,0,162,255],[94,0,161,255],[95,0,160,255],[96,0,159,255],[97,0,158,255],[98,0,157,255],[99,0,156,255],[100,0,155,255],[101,0,154,255],[102,0,153,255],[103,0,152,255],[104,0,151,255],[105,0,150,255],[106,0,149,255],[107,0,148,255],[108,0,147,255],[109,0,146,255],[110,0,145,255],[111,0,144,255],[112,0,143,255],[113,0,142,255],[114,0,141,255],[115,0,140,255],[116,0,139,255],[117,0,138,255],[118,0,137,255],[119,0,136,255],[120,0,135,255],[121,0,134,255],[122,0,133,255],[123,0,132,255],[124,0,131,255],[125,0,130,255],[126,0,129,255],[127,0,128,255],[128,0,127,255],[129,0,126,255],[130,0,125,255],[131,0,124,255],[132,0,123,255],[133,0,122,255],[134,0,121,255],[135,0,120,255],[136,0,119,255],[137,0,118,255],[138,0,117,255],[139,0,116,255],[140,0,115,255],[141,0,114,255],[142,0,113,255],[143,0,112,255],[144,0,111,255],[145,0,110,255],[146,0,109,255],[147,0,108,255],[148,0,107,255],[149,0,106,255],[150,0,105,255],[151,0,104,255],[152,0,103,255],[153,0,102,255],[154,0,101,255],[155,0,100,255],[156,0,99,255],[157,0,98,255],[158,0,97,255],[159,0,96,255],[160,0,95,255],[161,0,94,255],[162,0,93,255],[163,0,92,255],[164,0,91,255],[165,0,90,255],[166,0,89,255],[167,0,88,255],[168,0,87,255],[169,0,86,255],[170,0,85,255],[171,0,84,255],[172,0,83,255],[173,0,82,255],[174,0,81,255],[175,0,80,255],[176,0,79,255],[177,0,78,255],[178,0,77,255],[179,0,76,255],[180,0,75,255],[181,0,74,255],[182,0,73,255],[183,0,72,255],[184,0,71,255],[185,0,70,255],[186,0,69,255],[187,0,68,255],[188,0,67,255],[189,0,66,255],[190,0,65,255],[191,0,64,255],[192,0,63,255],[193,0,62,255],[194,0,61,255],[195,0,60,255],[196,0,59,255],[197,0,58,255],[198,0,57,255],[199,0,56,255],[200,0,55,255],[201,0,54,255],[202,0,53,255],[203,0,52,255],[204,0,51,255],[205,0,50,255],[206,0,49,255],[207,0,48,255],[208,0,47,255],[209,0,46,255],[210,0,45,255],[211,0,44,255],[212,0,43,255],[213,0,42,255],[214,0,41,255],[215,0,40,255],[216,0,39,255],[217,0,38,255],[218,0,37,255],[219,0,36,255],[220,0,35,255],[221,0,34,255],[222,0,33,255],[223,0,32,255],[224,0,31,255],[225,0,30,255],[226,0,29,255],[227,0,28,255],[228,0,27,255],[229,0,26,255],[230,0,25,255],[231,0,24,255],[232,0,23,255],[233,0,22,255],[234,0,21,255],[235,0,20,255],[236,0,19,255],[237,0,18,255],[238,0,17,255],[239,0,16,255],[240,0,15,255],[241,0,14,255],[242,0,13,255],[243,0,12,255],[244,0,11,255],[245,0,10,255],[246,0,9,255],[247,0,8,255],[248,0,7,255],[249,0,6,255],[250,0,5,255],[251,0,4,255],[252,0,3,255],[253,0,2,255],[254,0,1,255],[255,0,0,255]]),t.putImageData(o,0,0),n()}),colorFilter.prototype.THRESHOLDING=(e=>(t,n)=>{if(void 0!==e){let o,a=t.getImageData(0,0,t.canvas.width,t.canvas.height),r=a.data;if(o=void 0!==e.rgba?e.rgba:[126,1,0,255],void 0!==e.classId){parseInt(e.classId);for(let t=0;t<r.length;t+=4)r[t]===e.classId&&r[t+1]>=e.val?(r[t]=o[0],r[t+1]=o[1],r[t+2]=o[2],r[t+3]=o[3]):r[t+3]=0}else for(let t=0;t<r.length;t+=4)r[t+1]>=e.val?(r[t]=o[0],r[t+1]=o[1],r[t+2]=o[2],r[t+3]=o[3]):r[t+3]=0;t.putImageData(a,0,0),n()}else console.warn("thresh is undefined")});class ImageViewer{constructor(e){const t=e.layers,n=[];for(let e=0;e<t.length;e++){const o=t[e];n.push({tileSource:o.location,opacity:o.opacity,x:0,y:0})}let o,a;try{o=OpenSeadragon({id:e.osdId,crossOriginPolicy:"Anonymous",blendTime:0,prefixUrl:CONFIG.osdImages,minZoomImageRatio:1,maxZoomPixelRatio:1,tileSources:n})}catch(e){console.error(e.message)}o.world.addHandler("add-item",({item:e})=>{!function(e){try{const n=o.world.getIndexOfItem(e),a=o.world.getItemAt(n).source;void 0!==a.prefLabel&&(t[n].prefLabel=a.prefLabel),void 0!==a.resolutionUnit&&(t[n].resolutionUnit=a.resolutionUnit),void 0!==a.xResolution&&(t[n].xResolution=a.xResolution)}catch(e){console.log(`%c${e.message}`,"color: #ff6a5a;")}}(e)}),o.addOnceHandler("tile-loaded",()=>{if((a=o.drawer).imageSmoothingEnabled=!1,a._imageSmoothingEnabled=!1,window.location.hash){!function(e){console.log("params",typeof e,e);const t=o.viewport.getZoom(),n=o.viewport.getCenter();void 0!==e.zoom&&e.zoom!==t&&o.viewport.zoomTo(e.zoom,null,!0);if(void 0!==e.x&&void 0!==e.y&&(e.x!==n.x||e.y!==n.y)){const t=new OpenSeadragon.Point(e.x,e.y);o.viewport.panTo(t,!0)}}(parseHash())}!function(){const e=new OpenSeadragon.Button({tooltip:"Zoom to 100%",srcRest:`${CONFIG.osdImages}zin_rest.png`,srcGroup:`${CONFIG.osdImages}zin_grouphover.png`,srcHover:`${CONFIG.osdImages}zin_hover.png`,srcDown:`${CONFIG.osdImages}zin_pressed.png`,onClick(){o.viewport.zoomTo(o.viewport.getMaxZoom())}}),t=new OpenSeadragon.Button({tooltip:"Zoom to 0%",srcRest:`${CONFIG.osdImages}zout_rest.png`,srcGroup:`${CONFIG.osdImages}zout_grouphover.png`,srcHover:`${CONFIG.osdImages}zout_hover.png`,srcDown:`${CONFIG.osdImages}zout_pressed.png`,onClick(){o.viewport.goHome(!0)}});o.addControl(e.element,{anchor:OpenSeadragon.ControlAnchor.TOP_LEFT}),o.addControl(t.element,{anchor:OpenSeadragon.ControlAnchor.TOP_LEFT})}(),setFilter(t,o),function(){const e=t[0];if(isRealValue(e.resolutionUnit))if(3===e.resolutionUnit){const t=e.xResolution;r(100*t),MICRONS_PER_PIX=1e4/t}else console.warn("resolutionUnit <> 3",e.resolutionUnit)}()}),o.addOnceHandler("open",e=>{let t=o.viewport.viewportToImageZoom(o.viewport.getMinZoom()),n=[1,.5,.25],a=1,r=[];do{r=[...r,...n.map(e=>e/a)],a*=10}while(r[r.length-1]>t);for(;r[r.length-1]<t;)r.pop();r.push(t),r.sort((e,t)=>e-t);let i="",s=document.querySelector(".mag-content");if(s){for(let e=0;e<r.length;e++)i+=`<a href="#" data-value="${r[e]}">${Number((40*r[e]).toFixed(3))}x</a>`;s.innerHTML=i;for(let e of s.children)e.addEventListener("click",()=>{let t=e.getAttribute("data-value"),n=parseFloat(t);o.viewport.zoomTo(o.world.getItemAt(0).imageToViewportZoom(n))})}}),document.getElementById(`btnShare${e.idx}`).addEventListener("click",()=>{const e=o.viewport.getZoom(),t=o.viewport.getCenter(),n=`${location.origin}${location.pathname}#zoom=${e}&x=${t.x}&y=${t.y}`;o.world.getItemAt(0);prompt("Share this link:",n)}),document.getElementById(`btnCam${e.idx}`).addEventListener("click",()=>{const t=document.getElementById(e.osdId).querySelectorAll('[id^="osd-overlaycanvas"]');for(const e of t){const t=e.id;if(parseInt(t.slice(-1))%2==0){o.drawer.context.drawImage(e,0,0);const t=o.drawer.canvas.toDataURL("image/png"),n=document.createElement("a");n.href=t,n.download=`img_${timeStamp()}`,n.click();break}}});const r=e=>{console.log("ppm",typeof e,e),o.scalebar({type:OpenSeadragon.ScalebarType.MICROSCOPY,pixelsPerMeter:e,location:OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,xOffset:5,yOffset:10,stayInsideImage:!0,color:"rgb(150, 150, 150)",fontColor:"rgb(100, 100, 100)",backgroundColor:"rgba(255, 255, 255, 0.5)",barThickness:2})};this.viewer=o,this.overlay=this.viewer.fabricjsOverlay({scale:1e3}),this.canvas=this.overlay.fabricCanvas(),this.vInfo=e}getViewer(){return this.viewer}}const layerUI=(e,t,n)=>{createLayerElements(e,t,n),handleDrag(t,n)};function createLayerElements(t,n,o){const a=[],r=globalEye(t),i=e("div",{class:"divTable"}),s=e("div",{class:"divTableBody"});t.appendChild(i),i.appendChild(s);const l=e("div",{class:"divTableRow"});s.appendChild(l),l.appendChild(e("div",{class:"divTableCell"})),l.appendChild(e("div",{class:"divTableCell"},[r])),n.forEach(e=>{addIconRow(a,s,e,n,o)}),globalEyeEvent(r,a)}function handleDrag(e,t){const n=document.getElementById(t.id);function o(e){e.target.style.opacity="0.4",sourceViewer=t,draggedFeature=this,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",e.target.id)}function a(e){e.target.style.opacity="1",n.classList.remove("drag-over")}document.querySelectorAll(".layer").forEach(e=>{e.addEventListener("dragstart",o),e.addEventListener("dragend",a)}),n.addEventListener("dragover",e=>(e.preventDefault(),!1)),n.addEventListener("dragenter",function(e){e.target.classList.add("drag-over")}),n.addEventListener("dragleave",function(e){e.target.classList.remove("drag-over")}),n.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),e.target.classList.remove("drag-over");const t=e.target.closest(".viewer");if(!t)return console.error("!viewerDiv"),!1;const n=t.parentElement.nextSibling.firstChild.firstChild,o=e.dataTransfer.getData("text"),a=document.getElementById(o).innerHTML;let r,i,s,l,c,d=!1,u=n.children;for(let e=0;e<u.length;e++)if(e>0&&(r=u[e],i=r.children,s=i[0].firstChild,l=s.id[0],c=i[1].children[0],s.innerHTML===a)){d=!0,s.classList.remove("layer"),s.classList.add("block"),s.classList.add("color-fade"),setTimeout(function(){s.classList.remove("color-fade"),s.classList.remove("block"),s.classList.add("layer")},2e3),c.classList.remove("fa-eye-slash"),c.classList.add("fa-eye");break}const h=getOsdViewer(e,t);if(null!==h)if(d){console.log("Found matching slide");try{h.world.getItemAt(l).setOpacity(1)}catch(e){console.warn(e.message)}}else{let e;try{e=sourceViewer.tileSources[l].tileSource}catch(e){console.error("oops.",e.message)}console.error("Did not find matching slide\nLocation:",e)}return!1})}function addIconRow(t,n,o,a,r){const i=e("div",{class:"divTableRow"});n.appendChild(i);const s=o.layerNum,l=getPreferredLabel(o),c=createDraggableBtn(s,l);i.appendChild(e("div",{class:"divTableCell",style:"padding: 3px"},[c]));const d=layerEye(o);s>0&&t.push(d),i.appendChild(e("div",{class:"divTableCell"},[d]));const[u,h]=transparencySlider(o,d,r),p=e("div",{class:"myDIV",title:"transparency slider"},[u]);if(p.appendChild(e("div",{class:"hide"},[h])),d.addEventListener("click",layerEyeEvent.bind(null,d,h,s,r),!1),i.appendChild(e("div",{class:"divTableCell"},[p])),s>0){createColorPalette(i,l,o,a,r);const e=createTachometer(i,l);layerPopup(e,a,r)}else i.appendChild(e("div",{class:"divTableCell"}))}function getPreferredLabel(e){let t;const n=extractLocation(e),o=n.split("/");return(t=n.match(/^(?:[a-z]+:)?\b/gm)?o[o.length-2]:o[o.length-1]).includes(".")&&(t=t.substring(0,t.indexOf("."))),t}function createDraggableBtn(t,n){const o=e("button",{id:`${t}${createId(5,"feat")}`,class:"layer",style:"display: inline-block",draggable:"true",title:n});return o.innerHTML=n,o}function layerEye(t){const n=0===t.opacity?"fas fa-eye-slash":"fas fa-eye";return e("i",{id:createId(5,"eye"),class:`${n} layer-icons`,title:"toggle visibility"})}function layerEyeEvent(e,t,n,o){toggleButton(e,"fa-eye","fa-eye-slash");const a=o.world.getItemAt(n);if(void 0!==a)if(e.classList.contains("fa-eye-slash"))a.setOpacity(0);else{let e;0===parseInt(t.value)?(e=1,t.value="100"):e=t.value/100,a.setOpacity(e)}}function globalEye(t){const n=t.id.slice(-1);return e("i",{id:`eyeTog${n}`,style:"display: inline-block",class:"fas fa-eye layer-icons"})}function globalEyeEvent(t,n){t.addEventListener("click",function(){let t;this.classList.contains("fa-eye-slash")?(this.classList.remove("fa-eye-slash"),this.classList.add("fa-eye"),t=!0):(this.classList.remove("fa-eye"),this.classList.add("fa-eye-slash"),t=!1),n.forEach(n=>{t?n.classList.contains("fa-eye-slash")&&n.click(e):n.classList.contains("fa-eye-slash")||n.click(e)})})}function transparencySlider(t,n,o){const a=document.createElement("i");a.classList.add("fas"),a.classList.add("fa-adjust"),a.classList.add("layer-icons"),a.style.cursor="pointer";const r=e("input",{type:"range",class:"singleSlider",id:createId(5,"range"),min:"0",max:"100",step:"0.1",value:(100*t.opacity).toString()});return r.addEventListener("input",function(){const e=o.world.getItemAt(t.layerNum);void 0!==e?(e.setOpacity(this.value/100),"0"===this.value&&(n.classList.remove("fa-eye"),n.classList.add("fa-eye-slash")),parseFloat(this.value)>0&&(n.classList.remove("fa-eye-slash"),n.classList.add("fa-eye"))):console.warn("worldItem",e)}),[a,r]}function createColorPalette(t,n,o,a,r){const i=e("i",{id:createId(5,"palette"),class:"fas fa-palette pointer layer-icons",title:"color palette"});i.addEventListener("click",()=>{s.style.display="block"}),t.appendChild(e("div",{class:"divTableCell"},[i]));const s=filterPopup(i,`${n} colors`,o.colorscheme,a,r)}function createTachometer(t,n){const o=e("i",{id:createId(5,"tach"),class:"fas fa-tachometer-alt layer-icons",title:"settings"});t.appendChild(e("div",{class:"divTableCell"},[o]));const a=createId(5,"pop"),r=o.getBoundingClientRect(),i=createDraggableDiv(a,`${n} settings`,r.left,r.top),s=i.lastChild;return o.addEventListener("click",()=>{i.style.display="block"}),s}function getOsdViewer(e,t){if("canvas"===e.target.tagName.toLowerCase())try{let e;try{for(const n of SYNCED_IMAGE_VIEWERS)if(n.getViewer().id===t.id){e=n.getViewer();break}}catch(e){console.error("message:",e.message)}return e}catch(e){console.error(e.message)}return null}function getVals(e){let t=parseFloat(e[0].value),n=parseFloat(e[1].value);if(t>n){const e=n;n=t,t=e}return[t,n]}const layerPopup=function(t,n,o){function a(t,n,o,a){const r=e("div",{class:t.class,role:"group","aria-labelledby":"multi-lbl",style:`--${t.aLab}: ${t.aInit}; --${t.bLab}: ${t.bInit}; --min: ${t.min}; --max: ${t.max}`}),i=e("div",{id:"multi-lbl"});i.innerHTML=n,r.appendChild(i);const s=e("input",{id:t.aLab,type:"range",min:t.min,max:t.max,value:t.aInit}),l=e("input",{id:t.bLab,type:"range",min:t.min,max:t.max,value:t.bInit}),c=e("output",{for:t.aLab,style:`--c: var(--${t.aLab})`}),d=e("output",{for:t.bLab,style:`--c: var(--${t.bLab})`});function u(e){const n=e.target;n.parentNode.style.setProperty(`--${n.id}`,+n.value);const r=getVals([s,l]);"outside"===t.type?setFilter(o,a,{min:r[0],max:r[1],type:"outside"}):setFilter(o,a,{min:r[0],max:r[1],type:"inside"})}return r.appendChild(s),r.appendChild(c),r.appendChild(l),r.appendChild(d),s.addEventListener("input",u),l.addEventListener("input",u),r}const[r,i]=function(t,n){const o=createId(5,"atten"),a=e("label",{for:o});a.innerHTML="&nbsp;&#58;&nbsp;color-attenuation by probability<br>";const r=e("i",{id:o,class:"fas fa-broadcast-tower layer-icons",title:"toggle: color-attenuation by probability"});return r.addEventListener("click",()=>{STATE.attenuate=!STATE.attenuate,STATE.outline=!1,"byThreshold"===STATE.renderType&&(STATE.renderType="byProbability"),setFilter(t,n)}),[a,r]}(n,o),[s,l]=function(t,n){const o=createId(5,"fill"),a=e("label",{for:o});a.innerHTML="&nbsp;&nbsp;&#58;&nbsp;un/fill polygon<br>";const r=e("i",{id:o,class:"fas fa-circle layer-icons",title:"fill un-fill"});return r.addEventListener("click",()=>{STATE.outline=!STATE.outline,STATE.attenuate=!1,toggleButton(r,"fas","far"),setFilter(t,n)}),[a,r]}(n,o);t.appendChild(e("div",{},[i,r,l,s]));let c={aLab:"a",bLab:"b",aInit:70,bInit:185,min:0,max:MAX,class:"dualSlider",type:"inside"};const d=a(c,"In range:",n,o),u=a(c={aLab:"a1",bLab:"b1",aInit:10,bInit:245,min:0,max:MAX,class:"dualSlider1",type:"outside"},"Out range:",n,o),h=e("div",{},[u,d]);t.appendChild(h)};class MultiViewer extends ImageViewer{constructor(e,t,n){super(e),void 0===n&&(n={}),this.checkboxes={checkPan:!0,checkZoom:!0},t>1&&(this.checkboxes.checkPan=document.getElementById(`chkPan${e.idx}`),this.checkboxes.checkZoom=document.getElementById(`chkZoom${e.idx}`)),n.toolbarOn&&markupTools(e,n,super.getViewer()),layerUI(document.getElementById(`layersAndColors${e.idx}`),e.layers,super.getViewer())}getViewer(){return super.getViewer()}getPanZoom(){return this.checkboxes}}const synchronizeViewers=function(e){checkData(e)&&(this.SYNCED_IMAGE_VIEWERS=[],this.activeViewerId=null,this.numViewers=e.length,e.forEach(function(e){const t=e.getViewer();var n,o;setPanZoomCurrent(t,function(){if(!isActive(t.id))return;setPanZoomOthers(e),resetFlag()}),n=t,o=this.SYNCED_IMAGE_VIEWERS,overrideRightClickMenu(n.element),handleMarkerDisplay(n,o),handleButtonShowHide(),this.SYNCED_IMAGE_VIEWERS.push(e)}))};function setPanZoomCurrent(e,t){e.addHandler("pan",t),e.addHandler("zoom",t)}function isActive(e){return init(e),e===this.activeViewerId}function init(e){isRealValue(this.activeViewerId)||(this.activeViewerId=e)}function isPanOn(e){const t=e.getPanZoom();return void 0!==t.checkPan.checked?t.checkPan.checked:1!==this.numViewers}function isZoomOn(e){const t=e.getPanZoom();return void 0!==t.checkZoom.checked?t.checkZoom.checked:1!==this.numViewers}function setPanZoomOthers(e){const t=e.getViewer();this.SYNCED_IMAGE_VIEWERS.forEach(n=>{const o=n.getViewer();o.id!==t.id&&(isPanOn(n)&&isPanOn(e)&&o.viewport.panTo(t.viewport.getCenter(!1),!1),isZoomOn(n)&&isZoomOn(e)&&o.viewport.zoomTo(t.viewport.getZoom(!1)))})}function resetFlag(){this.activeViewerId=null}function checkData(e){return isEmpty(e)?(console.error("synchronizeViewers.js: Expected input argument, but received none."),!1):e[0]instanceof Object||(console.error("synchronizeViewers.js: Array elements should be MultiViewer objects."),!1)}