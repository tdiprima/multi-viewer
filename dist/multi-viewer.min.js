/*! multi-viewer - v1.0.0 - 2023-10-16 */
function setFilter(e,t,n,o){if(t.world){const a=t.world.getItemCount();let i=[];for(let r=1;r<a;r++){const a=t.world.getItemAt(r);if(isEmpty(n))if(STATE.outline)i.push({items:a,processors:OpenSeadragon.Filters.OUTLINE([0,0,255,255])});else if("byProbability"===STATE.renderType)i.push({items:a,processors:OpenSeadragon.Filters.COLORLEVELS(e[r].colorscheme.colorspectrum)});else if("byClass"===STATE.renderType||"byHeatmap"===STATE.renderType){let t;t=o?OpenSeadragon.Filters.THRESHOLDING(o):OpenSeadragon.Filters.COLORLEVELS(e[r].colorscheme.colors),i.push({items:a,processors:t})}else"byThreshold"===STATE.renderType&&i.push({items:a,processors:OpenSeadragon.Filters.THRESHOLDING(o)});else{let e;e="inside"===n.type?[0,255,255,255]:[74,0,180,255],i.push({items:a,processors:OpenSeadragon.Filters.PROBABILITY(n,e)})}}if(!isEmpty(i))try{t.setFilterOptions({filters:i,loadMode:"sync"})}catch(e){console.error(e.message)}}else console.warn("No viewer.world")}function setOsdTracking(e,t){e.setMouseNavEnabled(t),e.outerTracker.setTracking(t),e.gestureSettingsMouse.clickToZoom=t}function toggleButton(e,t,n){e.classList.toggle(t),e.classList.toggle(n)}function isRealValue(e){return null!==e&&void 0!==e}const isEmpty=e=>{const t=e=>{if(void 0===e.length){return!Object.keys(e).some(t=>!isEmpty(e[t]))&&t(Object.keys(e))}return!e.some(e=>!isEmpty(e))};return!1===e||void 0===e||null===e||"object"==typeof e&&t(e)};function alertMessage(e){return window.alert(e),!0}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function createId(e,t){let n="";const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=o.length;for(let t=0;t<e;t++)n+=o.charAt(Math.floor(Math.random()*a));return t&&(n=t+n),n}function createId2(){return`_${Math.random().toString(36).substring(2,13)}`}fabric.Canvas.prototype.getItemsByName=function(e){const t=[],n=this.getObjects();for(let o=0,a=this.size();o<a;o++)n[o].name&&n[o].name===e&&t.push(n[o]);return t};const e=(e,t={},n=[])=>{const o=document.createElement(e);return Object.keys(t).forEach(e=>{o.setAttribute(e,t[e])}),n.forEach(e=>{if(!e)return;const t="string"==typeof e?document.createTextNode(e):e;o.appendChild(t)}),o};function colorToArray(e){return e.replace(/[a-z%\s()]/g,"").split(",").map(e=>Number(e))}const scaleToPct=e=>e/255*100,scaleToRgb=e=>255*e/100,RENDER_TYPES=["byProbability","byClass","byHeatmap"],STATE={attenuate:!1,outline:!1,renderType:RENDER_TYPES[0]};function stringy(e){return JSON.stringify(e)}function populateStorage(e,t){localStorage.setItem("theme",document.body.className);const n=e.toJSON(["name","tag"]);localStorage.setItem("canvas",stringy(n)),localStorage.setItem("state",stringy(STATE)),localStorage.setItem("options",stringy(t))}function saveSettings(e,t){populateStorage(e,t);const n={theme:document.body.className,canvas:e.toJSON(["name","tag"]),state:STATE,options:t};console.log("saved",n)}let CONFIG={osdImages:"/multi-viewer/vendor/openseadragon/images/",appImages:"/multi-viewer/images/"};const MAX=255;let MICRONS_PER_PIX=.25;const pageSetup=(t,n,o,a,i,r,l,s)=>{let c=[];isRealValue(n)&&isRealValue(n[0])||document.write("<script>window.alert('You are logged out...');window.location=`${window.location.origin}/`;<\/script>"),document.addEventListener("DOMContentLoaded",function(){new Promise(e=>e(s)).then(s=>{document.body.classList.add("theme--default");const d=e("i",{class:"fas fa-moon moon"});let u;const h=n[0][0].location;if(h.includes("TCGA")){const e=h.match(/TCGA-[^%.]+/)[0];u=`Slide: ${e}`}else{const e=h.split("/");u=`Slide: ${e[e.length-1]}`}const p=e("div",{style:"display: flex"},[e("div",{style:"flex: 1"},[d]),e("div",{style:"flex: 1; text-align: right;"},[u])]),g=document.querySelector(`#${t}`);g.before(p);const m=localStorage.getItem("mode");m&&"dark-mode"===m&&toggleButton(document.body,"theme--default","theme--dark"),d.addEventListener("click",()=>{toggleButton(d,"fa-sun","fa-moon"),toggleButton(d,"sun","moon"),toggleButton(document.body,"theme--default","theme--dark"),document.body.classList.contains("theme--dark")?localStorage.setItem("mode","dark-mode"):localStorage.setItem("mode","light-mode")});const f=document.getElementById(t),y=e("table");let b;f.appendChild(y);const v=a*i;let w=0;for(b=0;b<a;b++){const t=y.insertRow(b);let a;for(a=0;a<i;a++){const i=t.insertCell(a),d=createId(11),u=w;if(w++,o<v&&w-1===o)break;const h=e("div",{class:"divSquare"});h.style.width=`${r}px`,i.appendChild(h);let p="";o>1&&(p+=`<input type="checkbox" id="chkPan${u}" checked=""><label for="chkPan${u}">Match Pan</label>&nbsp;\n<input type="checkbox" id="chkZoom${u}" checked=""><label for="chkZoom${u}">Match Zoom</label>&nbsp;&nbsp;`),s&&s.toolbarOn&&(p+=`<div class="controls showDiv" id="hideTools${u}"><div id="tools${u}" class="showHover">`,p+='<div class="floated">',s&&s.paintbrushColor?p+=`<mark id="mark${u}">${s.paintbrushColor}</mark>&nbsp;`:p+=`<mark id="mark${u}">#00f</mark>&nbsp;`,p+=`<button id="btnDraw${u}" class="annotationBtn" title="Draw"><i class="fas fa-pencil-alt"></i></button>\n<button id="btnEdit${u}" class="annotationBtn" title="Edit"><i class="fas fa-draw-polygon"></i></button>\n\x3c!--<button id="btnAnnotate${u}" class="annotationBtn" title="Add Annotation"><i class="fas fa-sticky-note"></i></button>--\x3e\n<button id="btnGrid${u}" class="annotationBtn" title="Grid"><i class="fas fa-border-all"></i></button>\n<button id="btnGridMarker${u}" class="annotationBtn" title="Mark grid"><i class="fas fa-paint-brush"></i></button>\n<button id="btnRuler${u}" class="annotationBtn" title="Measure in microns"><i class="fas fa-ruler"></i></button>\n<button id="btnShare${u}" class="annotationBtn" title="Share this link"><i class="fas fa-share-alt"></i></button>\n<button id="btnCam${u}" class="annotationBtn" title="Snapshot"><i class="fas fa-camera"></i></button>\n<button id="btnBlender${u}" class="annotationBtn" title="Blend-modes"><i class="fas fa-blender"></i></button>\n<button id="btnCrosshairs${u}" class="annotationBtn" title="Crosshairs"><i class="fas fa-crosshairs"></i></button>\n<button id="btnSave${u}" class="annotationBtn" title="Save"><i class="fas fa-save"></i></button>\n<div class="mag" style="display: inline">\n  <button class="annotationBtn">\n  <i class="fas fa-search"></i>\n  </button>\n  \x3c!-- data-value = image zoom --\x3e\n  <div class="mag-content">\n    <a href="#" data-value="0.025" id="1">1x</a>\n    <a href="#" data-value="0.05" id="2">2x</a>\n    <a href="#" data-value="0.1" id="4">4x</a>\n    <a href="#" data-value="0.25" id="10">10x</a>\n    <a href="#" data-value="0.5" id="20">20x</a>\n    <a href="#" data-value="1.0" id="40">40x</a>\n  </div>\n</div>\n<button id="btnMapMarker" class="annotationBtn" style="display: none"><i class="fas fa-map-marker-alt"></i> Hide markers</button>\n</div>`,p+="</div></div>"),p+=`<table><tr><td><div id="${d}" class="viewer dropzone" style="width: ${r}px; height: ${l}px;"></div>\n</td><td id="layersAndColors${u}" style="vertical-align: top;"></td>\n</tr></table>`,h.innerHTML=p;const g=new CP(document.getElementById(`mark${u}`));g.on("change",function(e,t,n,o){this.source.value=this.color(e,t,n,o),this.source.innerHTML=this.color(e,t,n,o),this.source.style.backgroundColor=this.color(e,t,n,o)});const m={idx:u,osdId:d,layers:n[u]};c.push(new ImageViewer(m,o,s))}}return c}).then(e=>{synchronizeViewers(e)})}),window.addEventListener("keydown",function(e){const t=e.key.toLocaleLowerCase();if("escape"===t||"esc"===t){e.preventDefault();const t=document.getElementsByClassName("btnOn");for(let e=0;e<t.length;e++)t[e].click()}if(e.ctrlKey&&"r"===t){e.preventDefault();for(let e=0;e<c.length;e++)document.querySelectorAll('[id^="btnRuler"]').forEach(e=>{e.click()})}})},editPolygon=(e,t)=>{e.addEventListener("click",function(){toggleButton(this,"btnOn","annotationBtn"),Edit(this,t.fabricCanvas())})};function polygonPositionHandler(e,t,n){const o=n.points[this.pointIndex].x-n.pathOffset.x,a=n.points[this.pointIndex].y-n.pathOffset.y;return fabric.util.transformPoint({x:o,y:a},fabric.util.multiplyTransformMatrices(n.canvas.viewportTransform,n.calcTransformMatrix()))}function actionHandler(e,t,n,o){const a=t.target,i=a.controls[a.__corner],r=a.toLocalPoint(new fabric.Point(n,o),"center","center"),l=a._getNonTransformedDimensions(),s=a._getTransformedDimensions(0,0),c={x:r.x*l.x/s.x+a.pathOffset.x,y:r.y*l.y/s.y+a.pathOffset.y};return a.points[i.pointIndex]=c,!0}function anchorWrapper(e,t){return(n,o,a,i)=>{const r=o.target,l=fabric.util.transformPoint({x:r.points[e].x-r.pathOffset.x,y:r.points[e].y-r.pathOffset.y},r.calcTransformMatrix()),s=t(n,o,a,i),c=(r._setPositionDimensions({}),r._getNonTransformedDimensions()),d=(r.points[e].x-r.pathOffset.x)/c.x,u=(r.points[e].y-r.pathOffset.y)/c.y;return r.setPositionByOrigin(l,d+.5,u+.5),s}}function getPolygon(e){if(e.getActiveObject())return e.getActiveObject();const t=e.getObjects("polygon");return 0===t.length?"null":1===t.length?t[0]:"null"}function Edit(e,t){const n=getPolygon(t);if(isRealValue(n)){if(t.setActiveObject(n),n.edit=!n.edit,n.edit){const e=n.points.length-1;n.cornerColor="rgba(0, 0, 255, 255)",n.cornerStyle="circle",n.controls=n.points.reduce((t,n,o)=>(t[`p${o}`]=new fabric.Control({positionHandler:polygonPositionHandler,actionHandler:anchorWrapper(o>0?o-1:e,actionHandler),actionName:"modifyPolygon",pointIndex:o}),t),{})}else n.cornerColor="rgba(0, 0, 255, 0.5)",n.cornerStyle="rect",n.controls=fabric.Object.prototype.controls;n.hasBorders=!n.edit,t.requestRenderAll()}else toggleButton(e,"btnOn","annotationBtn"),alertMessage("Please select a polygon for editing.")}const drawPolygon=(e,t,n)=>{let o,a=e.idx,i=document.getElementById(`btnDraw${a}`),r=document.getElementById(`mark${a}`),l=n.fabricCanvas(),s=l.freeDrawingBrush=new fabric.PencilBrush(l);function c(e,t){e.isDrawingMode=!1,e.off("mouse:down",()=>{d(e,t)}),setOsdTracking(t,!0)}function d(e,t){t.gestureSettingsMouse.clickToZoom=!e.getActiveObject()}function u(e,t,n){let o=e.target;isRealValue(o)&&"polygon"===o.type&&(n?o.set({fill:o.stroke,opacity:.5}):o.set({fill:""}),t.renderAll())}s.decimate=12,s.color=r.innerHTML,l.on("mouse:over",e=>{null!==e.target&&u(e,l,!0)}),l.on("mouse:out",e=>{null!==e.target&&u(e,l,!1)}),l.on("mouse:up",e=>{c(l,t)}),l.on("path:created",e=>{o=createId2(),function e(t,n,a,i,r){!function(e,t,n){let a=e.path.map(e=>({x:e[1],y:e[2]})),i=new fabric.Polygon(a,{left:e.left,top:e.top,fill:"",strokeWidth:n.width,stroke:n.color,scaleX:e.scaleX,scaleY:e.scaleY,objectCaching:!1,transparentCorners:!1,cornerColor:"rgba(0, 0, 255, 0.5)",cornerStyle:"square",tag:o});t.add(i),i.setControlVisible("tr",!1),t.setActiveObject(i),t.remove(e)}(t.path,a,i);!function(e){e.lockMovementX=!0,e.lockMovementY=!0;let t=document.createElement("img");t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E",fabric.Object.prototype.controls.deleteControl=new fabric.Control({x:.5,y:-.5,offsetX:15,offsetY:-15,cursorStyle:"pointer",mouseUpHandler:function(e,t){let n=t.target;try{let e=n.canvas;e.remove(n),e.requestRenderAll()}catch(e){console.error(`%c${e.message}`,"font-size: larger;")}},render:(n=t,function(e,t,o,a,i){let r=this.cornerSize;e.save(),e.translate(t,o),e.rotate(fabric.util.degreesToRadians(i.angle)),e.drawImage(n,-r/2,-r/2,r,r),e.restore()}),cornerSize:24});var n}(t.path);toggleButton(n,"annotationBtn","btnOn");a.off("path:created",()=>{e(t,n,a,i,r)})}(e,i,l,s,t)}),i.addEventListener("click",function(){toggleButton(this,"btnOn","annotationBtn"),l.isDrawingMode?c(l,t):(l.isDrawingMode=!0,l.on("mouse:down",()=>{d(l,t)}),s.color=r.innerHTML,s.width=10/t.viewport.getZoom(!0),setOsdTracking(t,!1))})},gridOverlay=(e,t,n)=>{const o={canvas:n.fabricCanvas(),canvasWidth:Math.ceil(n.fabricCanvas().width),canvasHeight:Math.ceil(n.fabricCanvas().height),cellWidth:25,cellHeight:25,color:"#C0C0C0",cellX:[],cellY:[],gridAdded:!1};e.addEventListener("click",function(){gridHandler(this,o)}),t.addEventListener("click",function(){markerHandler(this,o)}),drawCross(e.id.slice(-1),o.canvas)};function gridHandler(e,t){toggleButton(e,"btnOn","annotationBtn");const n=e.classList.contains("btnOn");n&&(turnGridOn(t),t.gridAdded=!0),n||(turnGridOff(t),t.gridAdded=!1)}function turnGridOff(e){const t=e.canvas.getObjects("line");for(let n=0;n<t.length;n++)e.canvas.remove(t[n])}function turnGridOn(e){const t={stroke:e.color,strokeWidth:2,selectable:!1};createHorizontalLines(e,t),createVerticalLines(e,t),e.canvas.renderAll(),e.gridAdded=!0}function createHorizontalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasHeight/e.cellHeight);++n)e.canvas.add(new fabric.Line([0,n*e.cellHeight,e.canvasWidth,n*e.cellHeight],t)),e.cellY[n+1]=n*e.cellHeight}function createVerticalLines(e,t){let n;for(n=0;n<Math.ceil(e.canvasWidth/e.cellWidth);++n)e.canvas.add(new fabric.Line([n*e.cellWidth,0,n*e.cellWidth,e.canvasHeight],t)),e.cellX[n+1]=n*e.cellWidth}function fillInGrid(e,t){const n=getCellPosition(getMousePosition(e,t)),o=new fabric.Rect({left:t.cellX[n.x],top:t.cellY[n.y],fill:"red",width:t.cellWidth,height:t.cellHeight,opacity:.5,selectable:!1});t.canvas.add(o)}function getMousePosition(e,t){const n=t.canvas.getPointer(e.e);return{x:n.x/t.cellWidth,y:n.y/t.cellHeight}}function getCellPosition(e){return{x:Math.ceil(e.x+.001),y:Math.ceil(e.y+.001)}}function markerHandler(e,t){toggleButton(e,"btnOn","annotationBtn");const n=e.classList.contains("btnOn");n||(t.canvas.__eventListeners["mouse:move"]=[]),n&&(t.gridAdded?t.canvas.on("mouse:move",e=>{fillInGrid(e,t)}):(toggleButton(e,"btnOn","annotationBtn"),alertMessage("Please draw a grid first.")))}function toggleCross(e,t){if(e){const e=t.width/2,o=t.height/2;function n(e,n,o,a){const i=new fabric.Line([e,n,o,a],{stroke:"yellow",selectable:!1,strokeWidth:2,hoverCursor:"default",evented:!1,name:"cross"});t.add(i)}n(e,0,e,t.height),n(0,o,t.width,o)}else t.remove(...t.getItemsByName("cross"))}function drawCross(e,t){const n=document.getElementById(`btnCrosshairs${e}`);n.addEventListener("click",()=>{n.classList.contains("btnOn")?toggleCross(!1,t):toggleCross(!0,t),toggleButton(n,"btnOn","annotationBtn")})}const mapMarker=(e,t)=>{overrideRightClickMenu(e.element),handleMarkerDisplay(e,t),handleButtonShowHide()};function overrideRightClickMenu(e){e.addEventListener("contextmenu",e=>{e.preventDefault()})}function handleMarkerDisplay(e,t){e.addHandler("canvas-nonprimary-press",n=>{if(isRightClick(n)){const o=n.position,a=e.viewport.pointFromPixel(o);document.querySelectorAll("#btnMapMarker").forEach(e=>{e.style.display="block"}),displayMapMarker(a,e,t)}})}function isRightClick(e){return 2===e.button}function displayMapMarker(e,t,n){n.forEach(t=>{t.getViewer().addOverlay({element:createLink(),location:e,placement:"BOTTOM",checkResize:!1})})}function createLink(){const t=e("a",{href:"#",id:"pin",class:"fas fa-map-marker pointer"});return t.style="text-decoration: none; font-size: 22px; color: red;",t.dataset.href="#",t}function handleButtonShowHide(){document.querySelectorAll("#btnMapMarker").forEach(e=>{let t,n,o=!1;e.addEventListener("click",function(){o?(t="block",n='<i class="fas fa-map-marker"></i> Hide markers'):(t="none",n='<i class="fas fa-map-marker"></i> Show markers'),this.innerHTML=n,document.querySelectorAll("#pin").forEach(e=>{e.style.display=t}),o=!o})})}const ruler=(e,t,n)=>{let o,a,i,r,l="x",s={x:0,y:0},c={x:0,y:0},d={x:0,y:0},u={x:0,y:0};const h=15,p=2;let g,m,f;g="#009933",m="#fff",f="#00cc01";let y=n.fabricCanvas();function b(e){if(s.x=0,c.x=0,s.y=0,c.y=0,y.remove(...y.getItemsByName("ruler")),i=t.viewport.getZoom(!0),"draw"===l){setOsdTracking(t,!1),a=!0;try{if(!e||!e.e)throw new Error("Event object or client coordinates are missing");let n=new OpenSeadragon.Point(e.e.clientX,e.e.clientY);if(!t||!t.viewport)throw new Error("Viewer or viewport is not initialized");let o=t.viewport.pointFromPixel(n),a=t.world.getItemAt(0);if(!a)throw new Error("No item found at index 0 in the viewer world");d=a.viewportToImageCoordinates(o)}catch(e){console.error(e.message)}let n=y.getPointer(e.e),i=[n.x,n.y,n.x,n.y];s.x=n.x,s.y=n.y,o=new fabric.Line(i,{strokeWidth:w().lineWidth,stroke:f,originX:"center",originY:"center",selectable:!1,evented:!1,name:"ruler"}),y.add(o)}else setOsdTracking(t,!0),y.forEachObject(e=>{e.setCoords()})}function v(e,t){return Math.abs(e-t)}function w(){let e=1/t.viewport.getZoom(!0);return{scaleFactor:e,fontSize:h*e,lineWidth:p*e}}function E(e,t,n){y.remove(r),r=new fabric.Text(n,{left:e-.5,top:t-.5,originX:"left",originY:"top",fill:m,fontFamily:"Arial,Helvetica,sans-serif",fontSize:w().fontSize,textBackgroundColor:g,selectable:!1,evented:!1,name:"ruler"}),y.add(r)}function T(e){if(!a)return;let n=new OpenSeadragon.Point(e.e.clientX,e.e.clientY),i=t.viewport.pointFromPixel(n);u=t.world.getItemAt(0).viewportToImageCoordinates(i);let r=v(d.x,u.x),s=v(d.y,u.y),h=(p=r,g=s,!(m=MICRONS_PER_PIX)||"number"!=typeof m||m<=0?(console.error("Invalid MICRONS_PER_PIX value:",m),0):Math.sqrt(p*p*m*m+g*g*m*m));var p,g,m;let f=(b=h)<1e-6?`${(1e9*b).toFixed(3)} fm`:b<.001?`${(1e6*b).toFixed(3)} pm`:b<1?`${(1e3*b).toFixed(3)} nm`:b>=1e3?`${(b/1e3).toFixed(3)} mm`:`${b.toFixed(3)} µm`;var b;let w=y.getPointer(e.e);o.set({x2:w.x,y2:w.y}),c.x=w.x,c.y=w.y,"draw"===l&&E(c.x,c.y,f),y.renderAll()}function C(e){if(a=!1,o.setCoords(),r.setCoords(),s.x!==c.x&&s.y!==c.y&&0!==c.x){console.log(`%clength: ${r.text}`,"color: #ccff00;");let t=y.getPointer(e.e);E(t.x,t.y,r.text),y.renderAll()}}e.addEventListener("click",()=>{const t="draw"===l;l=t?"x":"draw",t?(y.remove(...y.getItemsByName("ruler")),y.off("mouse:down",b),y.off("mouse:move",T),y.off("mouse:up",C)):(y.on("mouse:down",b),y.on("mouse:move",T),y.on("mouse:up",C)),toggleButton(e,"btnOn","annotationBtn")})},blender=(e,t,n=!0)=>{const o=[["normal","normal"],["difference","The Difference blend mode subtracts the pixels of the base and blend layers and the result is the greater brightness value. When you subtract two pixels with the same value, the result is black."],["multiply","The Multiply mode multiplies the colors of the blending layer and the base layers, resulting in a darker color. This mode is useful for coloring shadows."],["screen","With Screen blend mode, the values of the pixels in the layers are inverted, multiplied, and then inverted again. The result is the opposite of Multiply: wherever either layer was darker than white, the composite is brighter."],["overlay","The Overlay blend mode both multiplies dark areas and screens light areas at the same time, so dark areas become darker and light areas become lighter. Anything that is 50% gray completely disappears from view."],["darken","The Darken Blending Mode looks at the luminance values in each of the RGB channels and selects the color of whichever layer is darkest."],["lighten","The Lighten Blending Mode takes a look at color of the layers, and keeps whichever one is lightest."],["color-dodge","The Color Dodge blend mode divides the bottom layer by the inverted top layer."],["color-burn","The Color Burn Blending Mode gives you a darker result than Multiply by increasing the contrast between the base and the blend colors resulting in more highly saturated mid-tones and reduced highlights."],["hard-light","Hard Light combines the Multiply and Screen Blending Modes using the brightness values of the Blend layer to make its calculations. The results with Hard Light tend to be intense."],["soft-light","With the Soft Light blending mode, every color that is lighter than 50% grey will get even lighter, like it would if you shine a soft spotlight to it. In the same way, every color darker than 50% grey will get even darker."],["exclusion","Exclusion is very similar to Difference. Blending with white inverts the base color values, while blending with black produces no change. However, Blending with 50% gray produces 50% gray."],["hue","The Hue Blending Mode preserves the luminosity and saturation of the base pixels while adopting the hue of the blend pixels."],["saturation","The Saturation Blending Mode preserves the luminosity and hue of the base layer while adopting the saturation of the blend layer."],["color","The Color blend mode is a combination of Hue and Saturation. Only the color (the hues and their saturation values) from the layer is blended in with the layer or layers below it."],["luminosity","The Luminosity blend mode preserves the hue and chroma of the bottom layers, while adopting the luma of the top layer."]];e.addEventListener("click",()=>{const a=createId(5,"modes"),i=e.getBoundingClientRect();createDraggableDiv(a,"Blend Modes",i.left,i.top).style.display="block",function(e,t){const a=document.createElement("table");e.appendChild(a),o.forEach(e=>{const[o,i]=e,r=n?i:"",l=document.createElement("button");Object.assign(l,{type:"button",id:o.replace("-","_"),value:o,className:n?"annotationBtn css-tooltip":"annotationBtn",style:"width: 120px"}),n&&l.setAttribute("data-tooltip",r),l.innerHTML=o;const s=document.createElement("tr"),c=document.createElement("td");c.className="tooltip",c.appendChild(l),s.appendChild(c),a.appendChild(s),l.addEventListener("click",()=>{try{const e=t.world.getItemCount();t.world.getItemAt(e-1).setCompositeOperation(l.value)}catch(e){console.error(e.message)}})})}(document.getElementById(`${a}Body`),t)})},markupTools=(e,t,n)=>{const o=n.fabricjsOverlay({scale:1,static:!1}),a=e.idx;drawPolygon(e,n,o),editPolygon(document.getElementById(`btnEdit${a}`),o),gridOverlay(document.getElementById(`btnGrid${a}`),document.getElementById(`btnGridMarker${a}`),o),ruler(document.getElementById(`btnRuler${a}`),n,o),blender(document.getElementById(`btnBlender${a}`),n,!1);const i=o.fabricCanvas();i.on("after:render",()=>{i.calcOffset()}),document.getElementById(`btnSave${e.idx}`).addEventListener("click",()=>{saveSettings(i,t)})};function createDraggableDiv(t,n,o,a,i=!1){const r=e("div",{class:"popup",id:t});r.style.left=`${o}px`,r.style.top=`${a}px`;const l=e("img",{src:`${CONFIG.appImages}close-icon.png`,alt:"close",height:25,width:25});l.style.cursor="pointer",l.addEventListener("click",()=>{r.style.display="none"});const s=e("div",{class:"popupHeader",id:`${t}Header`},[l,e("span",{},[n])]);r.appendChild(s);const c=e("div",{id:`${t}Body`,style:"padding: 10px;"});return r.appendChild(c),document.body.appendChild(r),i||(r.style.display="none"),dragElement(r),r}function dragElement(e){let t=0,n=0,o=0,a=0;function i(e){e.preventDefault(),o=e.clientX,a=e.clientY,document.onmouseup=l,document.onmousemove=r}function r(i){i.preventDefault(),t=o-i.clientX,n=a-i.clientY,o=i.clientX,a=i.clientY,e.style.top=`${e.offsetTop-n}px`,e.style.left=`${e.offsetLeft-t}px`}function l(){document.onmouseup=null,document.onmousemove=null}document.getElementById(`${e.id}Header`)?document.getElementById(`${e.id}Header`).onmousedown=i:e.onmousedown=i}const filterPopup=(t,n,o,a,i)=>{setChecked(o);const r=getRandomInt(100,999),l=createPopup(r,t,n),s=document.getElementById(`${l.id}Body`),c=e("div"),d=e("div"),u=e("div"),h=e("div"),p=createDropdown(r,[c,d,u,h],a,i);s.appendChild(p),c.style.display="byClass"===STATE.renderType?"block":"none",s.appendChild(c),createUI(r,c,o.colors,a,i,"byClass"),d.style.display="byProbability"===STATE.renderType?"block":"none",s.appendChild(d),createUI(r,d,o.colorspectrum,a,i,"byProbability");return u.style.display="byHeatmap"===STATE.renderType?"block":"none",s.appendChild(u),u.innerHTML='<p style="color: #ffffff; background: -webkit-linear-gradient(#FF0000, #0000FF);">Color gradient where reddish colors<br>correspond to sureness and<br>bluish colors to unsureness.</p>',h.style.display="byThreshold"===STATE.renderType?"block":"none",s.appendChild(h),createThresh(h,a,i),l};function createPopup(e,t,n){const o=`filters${e}`,a=t.getBoundingClientRect();return createDraggableDiv(o,n,a.left,a.top)}function setChecked(e){e.colors.map(e=>e.checked=!0),e.colorspectrum.forEach((e,t)=>{e.checked=!0,e.classid=t})}function getThreshColor(e){let t;return e?(3===(t=colorToArray(e.style.backgroundColor)).length&&t.push(255),t):[126,1,0,255]}function createThresh(t,n,o,a,i){const r=e("input",{type:"number",min:"0",max:MAX.toString(),step:"1",size:"5",value:"1"}),l=e("input",{type:"range",min:"0",max:MAX.toString(),step:"1",value:"1"});function s(e){return function(){e.value=this.value,setFilter(n,o,{},{val:parseInt(this.value),rgba:getThreshColor(a),classId:i})}}t.appendChild(e("div",{},[r,l])),r.addEventListener("input",s(l)),l.addEventListener("input",s(r))}function checkboxHandler(e,t,n,o){e.addEventListener("click",()=>{STATE.outline=!1,t.find(t=>t.classid===parseInt(e.value)).checked=e.checked,setFilter(n,o)})}function createDropdown(t,n,o,a){const i=e("div",{style:"display: block;"}),r=`select${t}`;i.innerHTML=`<label for="${r}">Color by:</label>&nbsp;`;const l=e("select");return l.id=r,i.appendChild(l),RENDER_TYPES.forEach((e,t)=>{const n=document.createElement("option");n.setAttribute("value",e),n.text=e.startsWith("by")?e.replace("by",""):e,l.appendChild(n)}),l.addEventListener("change",()=>{STATE.renderType=l.options[l.selectedIndex].value,STATE.outline=!1,n.forEach(e=>{e.style.display="none"}),"byClass"===STATE.renderType?n[0].style.display="block":"byProbability"===STATE.renderType?n[1].style.display="block":"byHeatmap"===STATE.renderType?n[2].style.display="block":"byThreshold"===STATE.renderType&&(n[3].style.display="block"),"byThreshold"===STATE.renderType?setFilter(o,a,{},{val:1,rgba:[126,1,0,255]}):setFilter(o,a)}),i}function createUI(t,n,o,a,i,r){const l=e("table",{class:"popupBody"});n.appendChild(l);const s="byProbability"===r,c="byClass"===r;o?(c?l.appendChild(createHeaderRow(["","Color","Label","Pixels with certainty >= n"])):s&&(o.sort((e,t)=>t.low-e.low),l.appendChild(createHeaderRow(["","Color","Low","High"]))),o.forEach((n,r)=>{const d=e("input",{type:"checkbox",name:`classes${t}`,value:n.classid});n.checked?d.setAttribute("checked",!0):d.removeAttribute("checked");const u=createColorPicker(r,t,n,a,i);let h,p,g,m;if(s){p=createNumericInput(`low${t}${r}`,l,t,a,n,o,i),g=createNumericInput(`high${t}${r}`,l,t,a,n,o,i),m=e("i",{id:`i${t}${r}`,class:"fas fa-minus pointer"}),h=e("tr",{},[e("td",{},[d]),e("td",{},[u]),e("td",{},[p]),e("td",{},[g]),e("td",{},[m])])}else if(c){let t=e("div");createThresh(t,a,i,u,n.classid),h=e("tr",{},[e("td",{},[d]),e("td",{},[u]),e("td",{},[e("span",{},[n.name])]),e("td",{},[t])])}l.appendChild(h),checkboxHandler(d,o,a,i),s&&m.addEventListener("click",removeColor.bind(null,m,o,h,a,i),{passive:!0})}),s&&l.appendChild(extraRow(t,o,a,i))):console.warn("Layer colors?",o)}function removeColor(e,t,n,o,a){const i=e.id,r=i.charAt(i.length-1);t.splice(parseInt(r),1),n.remove(),setFilter(o,a)}function createHeaderRow(t){const n=e("tr");for(let o=0;o<t.length;o++){const a=e("th",{class:"pointer"});a.innerHTML=t[o],n.appendChild(a),a.addEventListener("click",()=>{const e=a.closest("table");Array.from(e.querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(a.parentNode.children).indexOf(a),this.asc=!this.asc)).forEach(t=>e.appendChild(t))})}return n}const getCellValue=(e,t)=>{const n=e.children[t];return n.children[0]?"number"===n.children[0].type?n.children[0].value:n.innerText||n.textContent:""},comparer=(e,t)=>(n,o)=>((e,t)=>""===e||""===t||isNaN(e)||isNaN(t)?e.toString().localeCompare(t):e-t)(getCellValue(t?n:o,e),getCellValue(t?o:n,e));function createColorPicker(t,n,o,a,i){let r=!0;const l=e("mark",{id:`marker${n}${t}`}),s=o.color;return l.style.backgroundColor=s,l.innerHTML=`#${rgba2hex(s)}`,new CP(l).on("change",function(e,t,n,l){r?r=!1:(STATE.outline=!1,this.source.value=this.color(e,t,n,l),this.source.innerHTML=this.color(e,t,n,l),this.source.style.backgroundColor=this.color(e,t,n,l),o.color=`rgba(${e}, ${t}, ${n}, ${255*l})`,setFilter(a,i))}),l}function rgba2hex(e){let t;const n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),o=(n&&n[4]||"").trim();let a=n?(256|n[1]).toString(16).slice(1)+(256|n[2]).toString(16).slice(1)+(256|n[3]).toString(16).slice(1):e;return a+=t=(256|(t=""!==o?o:1)).toString(16).slice(1)}function numericEvent(e,t,n,o){const a=parseInt(e.value);a>MAX&&(e.value=MAX.toString()),a<0&&(e.value="0"),e.id.startsWith("low")&&(t.low=a),e.id.startsWith("high")&&(t.high=a),setFilter(n,o)}function createNumericInput(t,n,o,a,i,r,l){let s;s=i.low||i.high?t.includes("low")?i.low.toString():i.high.toString():"";const c=e("input",{id:t,type:"number",min:"0",max:MAX.toString(),step:"1",size:"5",value:s});return c.addEventListener("input",numericEvent.bind(null,c,i,a,l),{passive:!0}),c}function isIntersect(e){const t=[],n=e.getElementsByTagName("td");for(const e of n){const n=e.children[0];if("number"===n.type&&(n.style.outlineStyle="",n.style.outlineColor="",n.id.startsWith("low")&&t.push({low:n,lowVal:parseInt(n.value)}),n.id.startsWith("high"))){const e=t[t.length-1];e.high=n,e.highVal=parseInt(n.value)}}t.sort((e,t)=>t.lowVal-e.lowVal);const o=t.length-1;for(let e=0;e<o;e++){const n=0!==t[e].lowVal&&0!==t[e+1].highVal;if(t[e].lowVal<=t[e+1].highVal&&n)return setOutlineStyle(t[e].low,t[e+1].high,"solid","red"),!0}return!1}function setOutlineStyle(e,t,n,o){isRealValue(e)&&(e.style.outlineStyle=n,e.style.outlineColor=o),isRealValue(t)&&(t.style.outlineStyle=n,t.style.outlineColor=o)}function addColor(t,n,o,a,i,r,l,s,c,d){if(setOutlineStyle(n,o,"",""),"0"===n.value&&"0"===o.value)setOutlineStyle(n,o,"solid","red");else{const t=`i${n.id.replace("low","")}`,o=e("i",{id:t,class:"fas fa-minus pointer"});l.querySelector("td:last-child i:first-child").replaceWith(o),o.addEventListener("click",removeColor.bind(null,o,s,l,c,d),{passive:!0}),checkboxHandler(i,s,c,d),l.closest("table").appendChild(extraRow(r,s,c,d))}}function seq(e){const t=e.map(e=>e.classid);t.sort();const[n,o]=[Math.min(...t),Math.max(...t)];return Array.from(Array(o-n),(e,t)=>t+n).filter(e=>!t.includes(e))}function extraRow(t,n,o,a){let i=n.length;const r={color:"rgba(255, 255, 255, 255)",low:0,high:0,checked:!1,classid:i};n.push(r);const l=e("input",{type:"checkbox",name:`classes${t}`,value:i});checkboxHandler(l,n,o,a);const s=createColorPicker(i,t,r,o,a),c=document.getElementById(`filters${t}Body`).firstChild,d=createNumericInput(`low${t}${i}`,c,t,o,r,n,a),u=createNumericInput(`high${t}${i}`,c,t,o,r,n,a),h=e("i",{id:`i${t}${i}`,class:"fas fa-plus pointer"}),p=e("tr",{},[e("td",{},[l]),e("td",{},[s]),e("td",{},[d]),e("td",{},[u]),e("td",{},[h])]);return h.addEventListener("click",addColor.bind(null,i,d,u,s,l,t,p,n,o,a),{passive:!0}),p}const bgTrans=function(e){for(let t=0;t<e.length;t+=4)0===e[t+1]&&(e[t+3]=0);return e},img2arrayWithBackgroundCorrection=e=>e.data.reduce((e,t,n)=>{if(n%4==0?e.push([t]):e[e.length-1].push(t),n%4==3){const t=e[e.length-1];0!==t[1]&&0!==t[3]||(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}return e},[]),colorChannel=1,alphaChannel=3,maxPixelValue=255;OpenSeadragon.Filters.OUTLINE=(e=>(t,n)=>{const o=t.canvas.width,a=t.canvas.height;let i=t.getImageData(0,0,o,a),r=img2arrayWithBackgroundCorrection(i),l=new Uint8ClampedArray(o*a*4);for(let t=0;t<r.length;t++){let n=r[t],a=!1;if(255===n[3]&&n[1]>0){let i=t+1,l=t-1,s=t-o,c=t+o;r[i]&&0===r[i][3]&&(a=!0),r[l]&&0===r[l][3]&&(a=!0),r[s]&&0===r[s][3]&&(a=!0),r[c]&&0===r[c][3]&&(a=!0),a&&(n=e)}else n=[0,0,0,0];l.set(n,4*t)}for(let e=0;e<l.length;e+=4)l[e+1]>0&&(l[e]=0,l[e+1]=0,l[e+2]=0,l[e+3]=0);let s=t.createImageData(o,a);s.data.set(l),t.putImageData(s,0,0),n()}),OpenSeadragon.Filters.PROBABILITY=((e,t)=>(n,o)=>{let a,i=n.getImageData(0,0,n.canvas.width,n.canvas.height),r=i.data;switch(e.type){case"inside":a=(t=>t>e.slideHandle1&&t<=e.slideHandle2);break;case"outside":a=(t=>t>0&&t<=e.slideHandle1||t<=255&&t>=e.slideHandle2);break;default:throw new Error(`Invalid type: ${e.type}`)}for(let e=0;e<r.length;e+=4){a(r[e+1])?(r[e]=t[0],r[e+1]=t[1],r[e+2]=t[2],r[e+3]=t[3]):r[e+3]=0}n.putImageData(i,0,0),o()});const getRangeColor=(e,t,n)=>{for(let o=0;o<t.length;o++)if(e>=t[o].low&&e<=t[o].high)return n[o];return[0,0,0,0]},getClassColor=(e,t,n)=>{for(let o=0;o<t.length;o++)if(e===t[o].classid)return n[o];return[0,0,0,0]},setPixelData=(e,t,n,o,a)=>{e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=a?o:n[3]},gradient=[[0,0,255,255],[1,0,254,255],[2,0,253,255],[3,0,252,255],[4,0,251,255],[5,0,250,255],[6,0,249,255],[7,0,248,255],[8,0,247,255],[9,0,246,255],[10,0,245,255],[11,0,244,255],[12,0,243,255],[13,0,242,255],[14,0,241,255],[15,0,240,255],[16,0,239,255],[17,0,238,255],[18,0,237,255],[19,0,236,255],[20,0,235,255],[21,0,234,255],[22,0,233,255],[23,0,232,255],[24,0,231,255],[25,0,230,255],[26,0,229,255],[27,0,228,255],[28,0,227,255],[29,0,226,255],[30,0,225,255],[31,0,224,255],[32,0,223,255],[33,0,222,255],[34,0,221,255],[35,0,220,255],[36,0,219,255],[37,0,218,255],[38,0,217,255],[39,0,216,255],[40,0,215,255],[41,0,214,255],[42,0,213,255],[43,0,212,255],[44,0,211,255],[45,0,210,255],[46,0,209,255],[47,0,208,255],[48,0,207,255],[49,0,206,255],[50,0,205,255],[51,0,204,255],[52,0,203,255],[53,0,202,255],[54,0,201,255],[55,0,200,255],[56,0,199,255],[57,0,198,255],[58,0,197,255],[59,0,196,255],[60,0,195,255],[61,0,194,255],[62,0,193,255],[63,0,192,255],[64,0,191,255],[65,0,190,255],[66,0,189,255],[67,0,188,255],[68,0,187,255],[69,0,186,255],[70,0,185,255],[71,0,184,255],[72,0,183,255],[73,0,182,255],[74,0,181,255],[75,0,180,255],[76,0,179,255],[77,0,178,255],[78,0,177,255],[79,0,176,255],[80,0,175,255],[81,0,174,255],[82,0,173,255],[83,0,172,255],[84,0,171,255],[85,0,170,255],[86,0,169,255],[87,0,168,255],[88,0,167,255],[89,0,166,255],[90,0,165,255],[91,0,164,255],[92,0,163,255],[93,0,162,255],[94,0,161,255],[95,0,160,255],[96,0,159,255],[97,0,158,255],[98,0,157,255],[99,0,156,255],[100,0,155,255],[101,0,154,255],[102,0,153,255],[103,0,152,255],[104,0,151,255],[105,0,150,255],[106,0,149,255],[107,0,148,255],[108,0,147,255],[109,0,146,255],[110,0,145,255],[111,0,144,255],[112,0,143,255],[113,0,142,255],[114,0,141,255],[115,0,140,255],[116,0,139,255],[117,0,138,255],[118,0,137,255],[119,0,136,255],[120,0,135,255],[121,0,134,255],[122,0,133,255],[123,0,132,255],[124,0,131,255],[125,0,130,255],[126,0,129,255],[127,0,128,255],[128,0,127,255],[129,0,126,255],[130,0,125,255],[131,0,124,255],[132,0,123,255],[133,0,122,255],[134,0,121,255],[135,0,120,255],[136,0,119,255],[137,0,118,255],[138,0,117,255],[139,0,116,255],[140,0,115,255],[141,0,114,255],[142,0,113,255],[143,0,112,255],[144,0,111,255],[145,0,110,255],[146,0,109,255],[147,0,108,255],[148,0,107,255],[149,0,106,255],[150,0,105,255],[151,0,104,255],[152,0,103,255],[153,0,102,255],[154,0,101,255],[155,0,100,255],[156,0,99,255],[157,0,98,255],[158,0,97,255],[159,0,96,255],[160,0,95,255],[161,0,94,255],[162,0,93,255],[163,0,92,255],[164,0,91,255],[165,0,90,255],[166,0,89,255],[167,0,88,255],[168,0,87,255],[169,0,86,255],[170,0,85,255],[171,0,84,255],[172,0,83,255],[173,0,82,255],[174,0,81,255],[175,0,80,255],[176,0,79,255],[177,0,78,255],[178,0,77,255],[179,0,76,255],[180,0,75,255],[181,0,74,255],[182,0,73,255],[183,0,72,255],[184,0,71,255],[185,0,70,255],[186,0,69,255],[187,0,68,255],[188,0,67,255],[189,0,66,255],[190,0,65,255],[191,0,64,255],[192,0,63,255],[193,0,62,255],[194,0,61,255],[195,0,60,255],[196,0,59,255],[197,0,58,255],[198,0,57,255],[199,0,56,255],[200,0,55,255],[201,0,54,255],[202,0,53,255],[203,0,52,255],[204,0,51,255],[205,0,50,255],[206,0,49,255],[207,0,48,255],[208,0,47,255],[209,0,46,255],[210,0,45,255],[211,0,44,255],[212,0,43,255],[213,0,42,255],[214,0,41,255],[215,0,40,255],[216,0,39,255],[217,0,38,255],[218,0,37,255],[219,0,36,255],[220,0,35,255],[221,0,34,255],[222,0,33,255],[223,0,32,255],[224,0,31,255],[225,0,30,255],[226,0,29,255],[227,0,28,255],[228,0,27,255],[229,0,26,255],[230,0,25,255],[231,0,24,255],[232,0,23,255],[233,0,22,255],[234,0,21,255],[235,0,20,255],[236,0,19,255],[237,0,18,255],[238,0,17,255],[239,0,16,255],[240,0,15,255],[241,0,14,255],[242,0,13,255],[243,0,12,255],[244,0,11,255],[245,0,10,255],[246,0,9,255],[247,0,8,255],[248,0,7,255],[249,0,6,255],[250,0,5,255],[251,0,4,255],[252,0,3,255],[253,0,2,255],[254,0,1,255],[255,0,0,255]];OpenSeadragon.Filters.COLORLEVELS=(e=>(t,n)=>{let o=t.getImageData(0,0,t.canvas.width,t.canvas.height);const a=bgTrans(o.data),i=e.filter(e=>e.checked),r=i.map(e=>colorToArray(e.color));((e,t)=>{for(let n=0;n<a.length;n+=4)if(255===a[n+3]){const o=a[n],l=a[n+1],s="byClass"===STATE.renderType?e(o,i,r):"byProbability"===STATE.renderType?e(l,i,r):"byHeatmap"===STATE.renderType?t[l]:(console.error("renderType?",STATE.renderType),[0,0,0,0]);setPixelData(a,n,s,l,STATE.attenuate)}else a[n]=a[n+1]=a[n+2]=a[n+3]=0})("byClass"===STATE.renderType?getClassColor:"byProbability"===STATE.renderType?getRangeColor:{},"byHeatmap"===STATE.renderType?gradient:{}),t.putImageData(o,0,0),n()}),OpenSeadragon.Filters.THRESHOLDING=(e=>(t,n)=>{if(void 0!==e){let o,a=t.getImageData(0,0,t.canvas.width,t.canvas.height),i=a.data;if(o=void 0!==e.rgba?e.rgba:[126,1,0,255],void 0!==e.classId)for(let t=0;t<i.length;t+=4)i[t]===e.classId&&i[t+1]>=e.val?(i[t]=o[0],i[t+1]=o[1],i[t+2]=o[2],i[t+3]=o[3]):i[t+3]=0;else for(let t=0;t<i.length;t+=4)i[t+1]>=e.val?(i[t]=o[0],i[t+1]=o[1],i[t+2]=o[2],i[t+3]=o[3]):i[t+3]=0;t.putImageData(a,0,0),n()}else console.warn("thresh is undefined")});class ImageViewer{constructor(e,t,n){const o=e.layers;void 0===t&&(t=1),void 0===n&&(n={}),this.checkboxes={checkPan:!0,checkZoom:!0},t>1&&(this.checkboxes.checkPan=document.getElementById(`chkPan${e.idx}`),this.checkboxes.checkZoom=document.getElementById(`chkZoom${e.idx}`));const a=[];for(let e=0;e<o.length;e++){const t=o[e];a.push({tileSource:t.location,opacity:t.opacity,x:0,y:0})}let i,r=OpenSeadragon({id:e.osdId,prefixUrl:CONFIG.osdImages,tileSources:a,crossOriginPolicy:"Anonymous",blendTime:0,minZoomImageRatio:1,maxZoomPixelRatio:1});function l(){const e=(new Date).toISOString(),t=e.slice(0,10);let n=e.slice(10);return`${t}_${n=n.replaceAll(":","-").replace("T","").slice(0,8)}`}this.viewer=r,this.overlay=this.viewer.fabricjsOverlay({scale:1e3}),this.canvas=this.overlay.fabricCanvas(),n.toolbarOn&&markupTools(e,n,r),r.world.addHandler("add-item",({item:e})=>{const t=r.world.getIndexOfItem(e),n=r.world.getItemAt(t).source;isRealValue(n.hasCreateAction)&&isRealValue(n.hasCreateAction.name)&&(o[t].name=n.hasCreateAction.name),isRealValue(n.xResolution)&&isRealValue(n.resolutionUnit)&&3===n.resolutionUnit&&(MICRONS_PER_PIX=1e4/n.xResolution,o[t].resolutionUnit=n.resolutionUnit,o[t].xResolution=n.xResolution)}),layerUI(document.getElementById(`layersAndColors${e.idx}`),o,r),r.addOnceHandler("tile-loaded",()=>{if((i=r.drawer).imageSmoothingEnabled=!1,i._imageSmoothingEnabled=!1,window.location.hash){!function(e){const t=r.viewport.getZoom(),n=r.viewport.getCenter();if(void 0!==e.zoom&&e.zoom!==t&&r.viewport.zoomTo(e.zoom,null,!0),void 0!==e.x&&void 0!==e.y&&(e.x!==n.x||e.y!==n.y)){const t=new OpenSeadragon.Point(e.x,e.y);r.viewport.panTo(t,!0)}}(function(){const e={},t=window.location.hash.replace(/^#/,"");t&&t.split("&").forEach(t=>{const n=t.split("="),o=n[0],a=parseFloat(n[1]);!o||isNaN(a)?console.error("bad hash param",t):e[o]=a});return e}())}!function(){const e=new OpenSeadragon.Button({tooltip:"Zoom to 100%",srcRest:`${CONFIG.appImages}zin_rest.png`,srcGroup:`${CONFIG.appImages}zin_grouphover.png`,srcHover:`${CONFIG.appImages}zin_hover.png`,srcDown:`${CONFIG.appImages}zin_pressed.png`,onClick(){r.viewport.zoomTo(r.viewport.getMaxZoom())}}),t=new OpenSeadragon.Button({tooltip:"Zoom to 0%",srcRest:`${CONFIG.appImages}zout_rest.png`,srcGroup:`${CONFIG.appImages}zout_grouphover.png`,srcHover:`${CONFIG.appImages}zout_hover.png`,srcDown:`${CONFIG.appImages}zout_pressed.png`,onClick(){r.viewport.goHome(!0)}});r.addControl(e.element,{anchor:OpenSeadragon.ControlAnchor.TOP_LEFT}),r.addControl(t.element,{anchor:OpenSeadragon.ControlAnchor.TOP_LEFT})}(),setFilter(o,r),function(){const e=o[0];isRealValue(e.xResolution)&&isRealValue(e.resolutionUnit)&&3===e.resolutionUnit&&s(100*e.xResolution)}()}),r.addOnceHandler("open",e=>{let t=r.viewport.getMinZoom(),n=r.world.getItemAt(0).viewportToImageZoom(t),o=[1,.5,.25],a=1,i=[];do{i=[...i,...o.map(e=>e/a)],a*=10}while(i[i.length-1]>n);for(;i[i.length-1]<n;)i.pop();i.push(n),i.sort((e,t)=>e-t);let l="",s=document.querySelector(".mag-content");if(s){for(let e=0;e<i.length;e++)l+=`<a href="#" data-value="${i[e]}">${Number((40*i[e]).toFixed(3))}x</a>`;s.innerHTML=l;for(let e of s.children)e.addEventListener("click",()=>{let t=e.getAttribute("data-value"),n=parseFloat(t);r.viewport.zoomTo(r.world.getItemAt(0).imageToViewportZoom(n))})}}),document.getElementById(`btnShare${e.idx}`).addEventListener("click",()=>{const e=r.viewport.getZoom(),t=r.viewport.getCenter(),n=`${location.origin}${location.pathname}#zoom=${e}&x=${t.x}&y=${t.y}`;r.world.getItemAt(0);prompt("Share this link:",n)}),document.getElementById(`btnCam${e.idx}`).addEventListener("click",()=>{const t=document.getElementById(e.osdId).querySelectorAll('[id^="osd-overlaycanvas"]');for(const e of t){const t=e.id;if(parseInt(t.slice(-1))%2==0){r.drawer.context.drawImage(e,0,0);const t=r.drawer.canvas.toDataURL("image/png"),n=document.createElement("a");n.href=t,n.download=`img_${l()}`,n.click();break}}});const s=e=>{r.scalebar({type:OpenSeadragon.ScalebarType.MICROSCOPY,pixelsPerMeter:e,location:OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,xOffset:5,yOffset:10,stayInsideImage:!0,color:"rgb(150, 150, 150)",fontColor:"rgb(100, 100, 100)",backgroundColor:"rgba(255, 255, 255, 0.5)",barThickness:2})}}getViewer(){return this.viewer}getPanZoom(){return this.checkboxes}}const layerUI=(e,t,n)=>{createLayerElements(e,t,n),setupDragAndDrop(n)};function createLayerElements(t,n,o){const a=[],i=globalEye(t),r=e("div",{class:"divTable"}),l=e("div",{class:"divTableBody"});t.appendChild(r),r.appendChild(l);const s=e("div",{class:"divTableRow"});l.appendChild(s),s.appendChild(e("div",{class:"divTableCell"})),s.appendChild(e("div",{class:"divTableCell"},[i])),n.forEach(e=>{addIconRow(a,l,e,n,o)}),globalEyeEvent(i,a)}function setupDragAndDrop(e){const t=document.getElementById(e.id);t.addEventListener("dragover",e=>(e.preventDefault(),!1)),t.addEventListener("dragenter",function(e){e.target.classList.add("drag-over")}),t.addEventListener("dragleave",function(e){e.target.classList.remove("drag-over")}),t.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),e.target.classList.remove("drag-over");const t=e.target.closest(".viewer"),n=t.parentElement.nextSibling.querySelector(".divTableBody"),o=e.dataTransfer.getData("text"),a=document.getElementById(o).innerHTML;let i,r=!1,l=n.children;for(let e=1;e<l.length;e++){const[t,n]=l[e].children,o=t.firstChild,s=n.firstChild;if(i=o.id[0],o.innerHTML===a){r=!0,o.classList.remove("layer"),o.classList.add("block"),o.classList.add("color-fade"),setTimeout(()=>{o.classList.remove("color-fade"),o.classList.remove("block"),o.classList.add("layer")},2e3),s.classList.remove("fa-eye-slash"),s.classList.add("fa-eye");break}}const s=getOsdViewer(t.id);return null!==s&&(r?s.world.getItemAt(i).setOpacity(1):console.warn("Did not find matching slide. Feature:",a)),!1})}async function fetchData(e){const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return t.json()}function getFeatureName(e,t,n){let o=new URL(t.location).search.split("/");const a=o.find(e=>e.startsWith("TCGA"));let i;if(a){i=t.location.includes("FeatureStorage")?n.hasCreateAction.name?n.hasCreateAction.name:`${o[o.indexOf("FeatureStorage")+1]}-${o[o.indexOf("FeatureStorage")+2]}`:a.split(".")[0]}else i=t.location.split("/").pop();return i}function createDraggableBtn(t,n,o){const a=e("span",{class:"button-text"},[o]),i=e("button",{id:`${t}${createId(5,"feat")}`,class:"layer expandable-button",draggable:"true"});return i.append(a),i}function handleDragStart(e){e.target.style.opacity="0.4",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",e.target.id)}function handleDragEnd(e){e.target.style.opacity="1"}async function addIconRow(t,n,o,a,i){const r=e("div",{class:"divTableRow"});n.appendChild(r);const l=o.layerNum;try{const n=getFeatureName(l,o,await fetchData(o.location)),s=createDraggableBtn(l,o,n);r.appendChild(e("div",{class:"divTableCell",style:"padding: 3px"},[s])),s.addEventListener("dragstart",handleDragStart),s.addEventListener("dragend",handleDragEnd);const c=layerEye(o);l>0&&t.push(c),r.appendChild(e("div",{class:"divTableCell"},[c]));const[d,u]=transparencySlider(o,c,i),h=e("div",{class:"myDIV",title:"transparency slider"},[d]);if(h.appendChild(e("div",{class:"hide"},[u])),c.addEventListener("click",layerEyeEvent.bind(null,c,u,l,i),!1),r.appendChild(e("div",{class:"divTableCell"},[h])),l>0){createColorPalette(r,n,o,a,i);const e=createTachometer(r,n);layerPopup(e,a,i)}else r.appendChild(e("div",{class:"divTableCell"}))}catch(e){console.error("There was a problem:",e)}}function layerEye(t){const n=0===t.opacity?"fas fa-eye-slash":"fas fa-eye";return e("i",{id:createId(5,"eye"),class:`${n} layer-icons`,title:"toggle visibility"})}function layerEyeEvent(e,t,n,o){toggleButton(e,"fa-eye","fa-eye-slash");const a=o.world.getItemAt(n);if(a)if(e.classList.contains("fa-eye-slash"))a.setOpacity(0);else{const e=parseInt(t.value),n=0===e?1:e/100;a.setOpacity(n),0===e&&(t.value="100")}}function globalEye(t){const n=t.id.slice(-1);return e("i",{id:`eyeTog${n}`,style:"display: inline-block",class:"fas fa-eye layer-icons"})}function globalEyeEvent(t,n){t.addEventListener("click",function(){let t;this.classList.contains("fa-eye-slash")?(this.classList.remove("fa-eye-slash"),this.classList.add("fa-eye"),t=!0):(this.classList.remove("fa-eye"),this.classList.add("fa-eye-slash"),t=!1),n.forEach(n=>{t?n.classList.contains("fa-eye-slash")&&n.click(e):n.classList.contains("fa-eye-slash")||n.click(e)})})}function transparencySlider(t,n,o){const a=document.createElement("i");a.classList.add("fas"),a.classList.add("fa-adjust"),a.classList.add("layer-icons"),a.style.cursor="pointer";const i=e("input",{type:"range",class:"singleSlider",id:createId(5,"range"),min:"0",max:"100",step:"0.1",value:(100*t.opacity).toString()});return i.addEventListener("input",function(){const e=o.world.getItemAt(t.layerNum);void 0!==e?(e.setOpacity(this.value/100),"0"===this.value&&(n.classList.remove("fa-eye"),n.classList.add("fa-eye-slash")),parseFloat(this.value)>0&&(n.classList.remove("fa-eye-slash"),n.classList.add("fa-eye"))):console.warn("worldItem",e)}),[a,i]}function createColorPalette(t,n,o,a,i){const r=e("i",{id:createId(5,"palette"),class:"fas fa-palette pointer layer-icons",title:"color palette"});r.addEventListener("click",()=>{l.style.display="block"}),t.appendChild(e("div",{class:"divTableCell"},[r]));const l=filterPopup(r,`${n} colors`,o.colorscheme,a,i)}function createTachometer(t,n){const o=e("i",{id:createId(5,"tach"),class:"fas fa-tachometer-alt layer-icons",title:"settings"});t.appendChild(e("div",{class:"divTableCell"},[o]));const a=createId(5,"pop"),i=o.getBoundingClientRect(),r=createDraggableDiv(a,`${n} settings`,i.left,i.top),l=document.getElementById(`${r.id}Body`);return o.addEventListener("click",()=>{r.style.display="block"}),l}function getOsdViewer(e){try{let t=SYNCED_IMAGE_VIEWERS.find(t=>t.getViewer().id===e);return t?t.getViewer():null}catch(e){console.error("Something happened...",e.message)}}function getVals(e){let t=parseFloat(e[0].value),n=parseFloat(e[1].value);if(t>n){const e=n;n=t,t=e}return[t,n]}const layerPopup=function(t,n,o){function a(){"byProbability"!==STATE.renderType&&(STATE.renderType="byProbability")}function i(t,n,o,a){const i=e("div",{class:t.class,role:"group","aria-labelledby":"multi-lbl",style:`--${t.aLab}: ${t.aInit}; --${t.bLab}: ${t.bInit}; --min: ${t.min}; --max: ${t.max}`}),r=e("div",{id:"multi-lbl"});r.innerHTML=n,i.appendChild(r);const l=e("input",{id:t.aLab,type:"range",min:t.min,max:t.max,value:t.aInit}),s=e("input",{id:t.bLab,type:"range",min:t.min,max:t.max,value:t.bInit}),c=e("output",{for:t.aLab,style:`--c: var(--${t.aLab})`}),d=e("output",{for:t.bLab,style:`--c: var(--${t.bLab})`});function u(e){const n=e.target;n.parentNode.style.setProperty(`--${n.id}`,+n.value);const i=getVals([l,s]);setFilter(o,a,{slideHandle1:i[0],slideHandle2:i[1],type:"outside"===t.type?"outside":"inside"})}return i.appendChild(l),i.appendChild(c),i.appendChild(s),i.appendChild(d),l.addEventListener("input",u),s.addEventListener("input",u),i}const[r,l]=function(t,n){const o=createId(5,"atten"),i=e("label",{for:o});i.innerHTML="&nbsp;&#58;&nbsp;color-attenuation by probability<br>";const r=e("i",{id:o,class:"fas fa-broadcast-tower layer-icons",title:"toggle: color-attenuation by probability"});return r.addEventListener("click",()=>{STATE.attenuate=!STATE.attenuate,STATE.outline=!1,a(),setFilter(t,n)}),[i,r]}(n,o),[s,c]=function(t,n){const o=createId(5,"fill"),i=e("label",{for:o});i.innerHTML="&nbsp;&nbsp;&#58;&nbsp;un/fill polygon<br>";const r=e("i",{id:o,class:"fas fa-circle layer-icons",title:"fill un-fill"});return r.addEventListener("click",()=>{STATE.outline=!STATE.outline,STATE.attenuate=!1,a(),toggleButton(r,"fas","far"),setFilter(t,n)}),[i,r]}(n,o);t.appendChild(e("div",{},[l,r,c,s]));let d={aLab:"a",bLab:"b",aInit:70,bInit:185,min:0,max:MAX,class:"dualSlider",type:"inside"};const u=i(d,"In range:",n,o),h=i(d={aLab:"a1",bLab:"b1",aInit:10,bInit:245,min:0,max:MAX,class:"dualSlider1",type:"outside"},"Out range:",n,o),p=e("div",{},[h,u]);t.appendChild(p)},synchronizeViewers=function(e){checkData(e)&&(this.SYNCED_IMAGE_VIEWERS=[],this.activeViewerId=null,this.numViewers=e.length,e.forEach(function(e){const t=e.getViewer();var n,o;setPanZoomCurrent(t,function(){if(!isActive(t.id))return;setPanZoomOthers(e),resetFlag()}),n=t,o=this.SYNCED_IMAGE_VIEWERS,overrideRightClickMenu(n.element),handleMarkerDisplay(n,o),handleButtonShowHide(),this.SYNCED_IMAGE_VIEWERS.push(e)}))};function setPanZoomCurrent(e,t){e.addHandler("pan",t),e.addHandler("zoom",t)}function isActive(e){return init(e),e===this.activeViewerId}function init(e){isRealValue(this.activeViewerId)||(this.activeViewerId=e)}function isPanOn(e){const t=e.getPanZoom();return void 0!==t.checkPan.checked?t.checkPan.checked:1!==this.numViewers}function isZoomOn(e){const t=e.getPanZoom();return void 0!==t.checkZoom.checked?t.checkZoom.checked:1!==this.numViewers}function setPanZoomOthers(e){const t=e.getViewer();this.SYNCED_IMAGE_VIEWERS.forEach(n=>{const o=n.getViewer();o.id!==t.id&&(isPanOn(n)&&isPanOn(e)&&o.viewport.panTo(t.viewport.getCenter(!1),!1),isZoomOn(n)&&isZoomOn(e)&&o.viewport.zoomTo(t.viewport.getZoom(!1)))})}function resetFlag(){this.activeViewerId=null}function checkData(e){return isEmpty(e)?(console.error("synchronizeViewers.js: Expected input argument, but received none."),!1):e[0]instanceof Object||(console.error("synchronizeViewers.js: Array elements should be ImageViewer objects."),!1)}